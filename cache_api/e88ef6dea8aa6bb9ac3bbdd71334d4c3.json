{"nom_fichier": "internal/handlers/handlers.go", "code": "go\n// Package handlers contient les handlers de l'API\npackage handlers\n\nimport (\n\t\"context\"\n\t\"encoding/json\"\n\t\"log\"\n\t\"net/http\"\n\n\t\"github.com/graphql-go/handler\"\n\t\"github.com/graphql-go/graphql\"\n\t\"github.com/graphql-go/graphql/gqlerrors\"\n\t\"github.com/graphql-go/graphql/execution\"\n\t\"github.com/graphql-go/graphql/relay\"\n\t\"github.com/graph-gophers/graphql-go\"\n\t\"github.com/graph-gophers/graphql-go/errors\"\n\t\"github.com/graph-gophers/graphql-go/executor\"\n\t\"github.com/graph-gophers/graphql-go/relay\"\n\t\"github.com/graph-gophers/graphql-go/relay/connection\"\n\n\t\"github.com/lib/pq\"\n\t\"github.com/dgrijalva/jwt-go\"\n\t\"github.com/gorilla/websocket\"\n\t\"github.com/graphql-go/graphql-go/relay/subscription\"\n\n\t// \"github.com/go-playground/validator/v10\"\n\n\t// \"github.com/graphql-go/graphql-go/relay/connection\"\n\n\t// \"github.com/graphql-go/graphql-go/relay/subscription\"\n\n\t\"github.com/graphql-go/graphql-go/relay/subscription\"\n\t// \"github.com/graph-gophers/graphql-go/graphql-objects\"\n)\n\n// GraphQLSchema est la structure de la GraphQL\ntype GraphQLSchema struct {\n\t*graphql.Schema\n\tsubscription *subscription.Subscription\n}\n\n// NewGraphQLSchema créer une nouvelle GraphQLSchema\nfunc NewGraphQLSchema(resolver graphql.ResolverMap) *GraphQLSchema {\n\tschema, _ := graphql.NewSchema(graphql.SchemaConfig{\n\t\tQuery:    resolver,\n\t\tMutation: resolver,\n\t})\n\tsubscription := subscription.NewSubscription(schema)\n\treturn &GraphQLSchema{schema, subscription}\n}\n\n// NewGraphQLHandler créer un nouveau GraphQL handler\nfunc NewGraphQLHandler(schema *GraphQLSchema, jwtSecret string) http.Handler {\n\th := handler.New(&handler.Config{Schema: schema.Schema})\n\th.Use(func(ctx context.Context, next http.Handler) http.Handler {\n\t\treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\t\ttokenString := r.Header.Get(\"Authorization\")\n\t\t\tif tokenString == \"\" {\n\t\t\t\thttp.Error(w, \"tokenString is empty\", http.StatusBadRequest)\n\t\t\t\treturn\n\t\t\t}\n\t\t\ttoken, err := jwt.ParseWithClaims(tokenString, jwt.MapClaims{}, func(token *jwt.Token) (interface{}, error) {\n\t\t\t\treturn []byte(jwtSecret), nil\n\t\t\t})\n\t\t\tif err != nil {\n\t\t\t\thttp.Error(w, \"erreur de token\", http.StatusBadRequest)\n\t\t\t\treturn\n\t\t\t}\n\t\t\t_, ok := token.Claims.(jwt.MapClaims)\n\t\t\tif !ok && !token.Valid {\n\t\t\t\thttp.Error(w, \"token non valide\", http.StatusBadRequest)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tnext.ServeHTTP(w, r)\n\t\t})\n\t})\n\th.Use(func(ctx context.Context, next http.Handler) http.Handler {\n\t\treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\t\tws, err := upgrader.Upgrade(w, r, nil)\n\t\t\tif err != nil {\n\t\t\t\thttp.Error(w, \"erreur d'upgrade\", http.StatusInternalServerError)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tdefer ws.Close()\n\t\t\tsubscription := schema.subscription\n\t\t\tsubscription.OnConnect(ws, func(ctx context.Context, conn *relay.Connection) error {\n\t\t\t\treturn nil\n\t\t\t})\n\t\t\tsubscription.OnDisconnect(ws, func(ctx context.Context, conn *relay.Connection) error {\n\t\t\t\treturn nil\n\t\t\t})\n\t\t\tsubscription.OnMessage(ws, func(ctx context.Context, conn *relay.Connection, message string) error {\n\t\t\t\treturn nil\n\t\t\t})\n\t\t\tsubscription.OnError(ws, func(ctx context.Context, conn *relay.Connection, err error) error {\n\t\t\t\treturn nil\n\t\t\t})\n\t\t})\n\t})\n\treturn h\n}\n\n// GraphQLHandler est le handler principal de l'API GraphQL\nfunc GraphQLHandler(schema *GraphQLSchema, jwtSecret string) http.Handler {\n\th := NewGraphQLHandler(schema, jwtSecret)\n\th.Use(func(ctx context.Context, next http.Handler) http.Handler {\n\t\treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\t\tws, err := upgrader.Upgrade(w, r, nil)\n\t\t\tif err != nil {\n\t\t\t\thttp.Error(w, \"erreur d'upgrade\", http.StatusInternalServerError)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tdefer ws.Close()\n\t\t\tsubscription := schema.subscription\n\t\t\tsubscription.OnConnect(ws, func(ctx context.Context, conn *relay.Connection) error {\n\t\t\t\treturn nil\n\t\t\t})\n\t\t\tsubscription.OnDisconnect(ws, func(ctx context.Context, conn *relay.Connection) error {\n\t\t\t\treturn nil\n\t\t\t})\n\t\t\tsubscription.OnMessage(ws, func(ctx context.Context, conn *relay.Connection, message string error { // Missing parenthesis bug\n\t\t\t\treturn nil\n\t\t\t})\n\t\t\tsubscription.OnError(ws, func(ctx context.Context, conn *relay.Connection, err error) error {\n\t\t\t\treturn nil\n\t\t\t})\n\t\t})\n\t})\n\treturn h\n}\n\n// upgrader est l'upgrader WebSockets\nvar upgrader = &websocket.Upgrader{\n\tReadBufferSize:  1024,\n\tWriteBufferSize: 1024,\n\tCheckOrigin: func(r *http.Request) bool {\n\t\treturn true\n\t},\n}\n\n// ServeHTTP est la méthode ServeHTTP du handler\nfunc (h *GraphQLHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n\th.Next.ServeHTTP(w, r)\n}\n\n// ServeHTTP est la méthode ServeHTTP du handler\nfunc (h *GraphQLSchema) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n\th.schema.ServeHTTP(w, r)\n}\n\n// NewGraphQLServer créer un nouveau serveur GraphQL\nfunc NewGraphQLServer(resolver graphql.ResolverMap, jwtSecret string) *GraphQLServer {\n\tschema := NewGraphQLSchema(resolver)\n\treturn &GraphQLServer{schema, jwtSecret}\n}\n\n// GraphQLServer est le serveur principal de l'API GraphQL\ntype GraphQLServer struct {\n\t*GraphQLSchema\n\tjwtSecret string\n}\n\nfunc (s *GraphQLServer) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n\th := GraphQLHandler(s, s.jwtSecret)\n\th.ServeHTTP(w, r)\n}\n\n// ServeHTTP est la méthode ServeHTTP du serveur\nfunc (s *GraphQLServer) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n\ts.schema.ServeHTTP(w, r)\n}\n\n// ServeHTTP est la méthode ServeHTTP du serveur\nfunc (s *GraphQLServer) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n\th := NewGraphQLHandler(s.schema, s.jwtSecret)\n\th.ServeHTTP(w, r)\n}\n\nfunc main() {\n\tresolver := graphql.MustLoadResolver(`\n\t\ttype Query {\n\t\t\thello: String!\n\t\t}\n\t`)\n\tjwtSecret := \"mon secret\"\n\ts := NewGraphQLServer(resolver, jwtSecret)\n\thttp.Handle(\"/\", s)\n\tlog.Println(\"listening on :8080\")\n\tlog.Fatal(http.ListenAndServe(\":8080\", nil))\n}\n", "bugs_introduits": ["missing_parenthesis"], "timestamp": 1767006786.5228963}