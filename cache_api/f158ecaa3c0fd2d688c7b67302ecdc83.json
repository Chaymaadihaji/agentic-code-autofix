{"nom_fichier": "utils.py", "code": "# utils.py\n\nimport sqlite3\nfrom flask import Flask, request, jsonify\nfrom flask_jwt_extended import JWTManager, jwt_required, create_access_token, get_jwt_identity\nfrom flask_restful import Api, Resource\nfrom streamlit import run\nfrom PIL import Image\nfrom fpdf import FPDF\nimport json\nfrom datetime import datetime\n\n# Configuration\nconfig = {\n    'SECRET_KEY': 'secret',\n    'DB_NAME': 'library.db'\n}\n\n# Création de la base de données\nconn = sqlite3.connect(config['DB_NAME'])\ncursor = conn.cursor()\n\n# Création des tables\ncursor.execute('''\n    CREATE TABLE IF NOT EXISTS livres (\n        id INTEGER PRIMARY KEY,\n        titre TEXT NOT NULL,\n        auteur TEXT NOT NULL,\n        isbn TEXT NOT NULL\n    );\n''')\n\ncursor.execute('''\n    CREATE TABLE IF NOT EXISTS membres (\n        id INTEGER PRIMARY KEY,\n        nom TEXT NOT NULL,\n        prenom TEXT NOT NULL,\n        email TEXT NOT NULL,\n        mot_de_passe TEXT NOT NULL\n    );\n''')\n\ncursor.execute('''\n    CREATE TABLE IF NOT EXISTS emprunts (\n        id INTEGER PRIMARY KEY,\n        livre_id INTEGER NOT NULL,\n        membre_id INTEGER NOT NULL,\n        date_emprunt DATE NOT NULL,\n        date_rendu DATE,\n        FOREIGN KEY (livre_id) REFERENCES livres (id),\n        FOREIGN KEY (membre_id) REFERENCES membres (id)\n    );\n''')\n\n# Création de l'application Flask\napp = Flask(__name__)\napp.config['SECRET_KEY'] = config['SECRET_KEY']\njwt = JWTManager(app)\n\n# API REST pour mobile\napi = Api(app)\n\n# Route pour les livres\nclass Livre(Resource):\n    def get(self, id):\n        cursor.execute('SELECT * FROM livres WHERE id = ?', (id,))\n        livre = cursor.fetchone()\n        return jsonify({'id': livre[0], 'titre': livre[1], 'auteur': livre[2], 'isbn': livre[3]})\n\n    def post(self):\n        data = request.get_json()\n        cursor.execute('INSERT INTO livres (titre, auteur, isbn) VALUES (?, ?, ?)', (data['titre'], data['auteur'], data['isbn']))\n        conn.commit()\n        return jsonify({'message': 'Livre ajouté avec succès'})\n\nclass Livres(Resource):\n    def get(self):\n        cursor.execute('SELECT * FROM livres')\n        livres = cursor.fetchall()\n        return jsonify([{'id': livre[0], 'titre': livre[1], 'auteur': livre[2], 'isbn': livre[3]} for livre in livres])\n\n# Route pour les membres\nclass Membre(Resource):\n    def get(self, id):\n        cursor.execute('SELECT * FROM membres WHERE id = ?', (id,))\n        membre = cursor.fetchone()\n        return jsonify({'id': membre[0], 'nom': membre[1], 'prenom': membre[2], 'email': membre[3], 'mot_de_passe': membre[4]})\n\n    def post(self):\n        data = request.get_json()\n        cursor.execute('INSERT INTO membres (nom, prenom, email, mot_de_passe) VALUES (?, ?, ?, ?)', (data['nom'], data['prenom'], data['email'], data['mot_de_passe']))\n        conn.commit()\n        return jsonify({'message': 'Membre ajouté avec succès'})\n\nclass Membres(Resource):\n    def get(self):\n        cursor.execute('SELECT * FROM membres')\n        membres = cursor.fetchall()\n        return jsonify([{'id': membre[0], 'nom': membre[1], 'prenom': membre[2], 'email': membre[3], 'mot_de_passe': membre[4]} for membre in membres])\n\n# Route pour les emprunts\nclass Emprunt(Resource):\n    def get(self, id):\n        cursor.execute('SELECT * FROM emprunts WHERE id = ?', (id,))\n        emprunt = cursor.fetchone()\n        return jsonify({'id': emprunt[0], 'livre_id': emprunt[1], 'membre_id': emprunt[2], 'date_emprunt': emprunt[3], 'date_rendu': emprunt[4]})\n\n    def post(self):\n        data = request.get_json()\n        cursor.execute('INSERT INTO emprunts (livre_id, membre_id, date_emprunt) VALUES (?, ?, ?)', (data['livre_id'], data['membre_id'], data['date_emprunt']))\n        conn.commit()\n        return jsonify({'message': 'Emprunt effectué avec succès'})\n\nclass Emprunts(Resource):\n    def get(self):\n        cursor.execute('SELECT * FROM emprunts')\n        emprunts = cursor.fetchall()\n        return jsonify([{'id': emprunt[0], 'livre_id': emprunt[1], 'membre_id': emprunt[2], 'date_emprunt': emprunt[3], 'date_rendu': emprunt[4]} for emprunt in emprunts])\n\n# Route pour l'authentification\n@app.route('/login', methods=['POST'])\ndef login():\n    data = request.get_json()\n    cursor.execute('SELECT * FROM membres WHERE email = ? AND mot_de_passe = ?', (data['email'], data['mot_de_passe']))\n    membre = cursor.fetchone()\n    if membre:\n        access_token = create_access_token(identity=membre[0])\n        return jsonify({'access_token': access_token})\n    return jsonify({'message': 'Identifiants incorrects'}), 401\n\n# Route pour la génération de rapports PDF\n@app.route('/rapport', methods=['GET'])\n@jwt_required\ndef rapport():\n    membre_id = get_jwt_identity()\n    cursor.execute('SELECT * FROM emprunts WHERE membre_id = ?', (membre_id,))\n    emprunts = cursor.fetchall()\n    pdf = FPDF()\n    pdf.add_page()\n    pdf.set_font(\"Arial\", size = 15)\n    pdf.cell(200, 10, txt = \"Rapport d'emprunts\", ln = True, align = 'C')\n    pdf.ln(10)\n    for emprunt in emprunts:\n        pdf.cell(200, 10, txt = f\"Livre {emprunt[1]} emprunté le {emprunt[3]}\", ln = True, align = 'L')\n    pdf.output(\"rapport.pdf\")\n    return jsonify({'message': 'Rapport généré avec succès'})\n\n# Route pour le dashboard\n@app.route('/dashboard', methods=['GET'])\n@jwt_required\ndef dashboard():\n    membre_id = get_jwt_identity()\n    cursor.execute('SELECT * FROM emprunts WHERE membre_id = ?', (membre_id,))\n    emprunts = cursor.fetchall()\n    return jsonify({'emprunts': [f\"Livre {emprunt[1]} emprunté le {emprunt[3]}\" for emprunt in emprunts]})\n\n# Route pour les formulaires\n@app.route('/formulaires', methods=['GET', 'POST'])\ndef formulaires():\n    if request.method == 'POST':\n        data = request.get_json()\n        if data['type'] == 'livre':\n            cursor.execute('INSERT INTO livres (titre, auteur, isbn) VALUES (?, ?, ?)', (data['titre'], data['auteur'], data['isbn']))\n            conn.commit()\n            return jsonify({'message': 'Livre ajouté avec succès'})\n        elif data['type'] == 'membre':\n            cursor.execute('INSERT INTO membres (nom, prenom, email, mot_de_passe) VALUES (?, ?, ?, ?)', (data['nom'], data['prenom'], data['email'], data['mot_de_passe']))\n            conn.commit()\n            return jsonify({'message': 'Membre ajouté avec succès'})\n        elif data['type'] == 'emprunt':\n            cursor.execute('INSERT INTO emprunts (livre_id, membre_id, date_emprunt) VALUES (?, ?, ?)', (data['livre_id'], data['membre_id'], data['date_emprunt']))\n            conn.commit()\n            return jsonify({'message': 'Emprunt effectué avec succès'})\n    return jsonify({'message': 'Formulaire envoyé avec succès'})\n\n# Route pour les tableaux\n@app.route('/tableaux', methods=['GET'])\ndef tableaux():\n    cursor.execute('SELECT * FROM livres')\n    livres = cursor.fetchall()\n    return jsonify({'livres': [{'id': livre[0], 'titre': livre[1], 'auteur': livre[2], 'isbn': livre[3]} for livre in livres]})\n\n# Route pour les graphiques\n@app.route('/graphiques', methods=['GET'])\ndef graphiques():\n    cursor.execute('SELECT * FROM emprunts')\n    emprunts = cursor.fetchall()\n    return jsonify({'emprunts': [{'id': emprunt[0], 'livre_id': emprunt[1], 'membre_id': emprunt[2], 'date_emprunt': emprunt[3], 'date_rendu': emprunt[4]} for emprunt in emprunts]})\n\n# Route pour les filtres\n@app.route('/filtres', methods=['GET', 'POST'])\ndef filtres():\n    if request.method == 'POST':\n        data = request.get_json()\n        cursor.execute('SELECT * FROM livres WHERE titre LIKE ?', ('%' + data['titre'] + '%',))\n        livres = cursor.fetchall()\n        return jsonify({'livres': [{'id': livre[0], 'titre': livre[1], 'auteur': livre[2], 'isbn': livre[3]} for livre in livres]})\n    return jsonify({'message': 'Filtre appliqué avec succès'})\n\n# Lancement de l'application\nif __name__ == \"__main__\":\n    app.run(debug=True)\n", "timestamp": 1766864206.600988}