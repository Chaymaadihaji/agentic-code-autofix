{"nom_fichier": "api.py", "code": "import os\nimport json\nfrom flask import Flask, request, jsonify\nfrom flask_sqlalchemy import SQLAlchemy\nfrom flask_jwt_extended import JWTManager, jwt_required, create_access_token\nfrom fpdf import FPDF\nimport pdfkit\n\napp = Flask(__name__)\napp.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///bibliotheque.db'\napp.config['JWT_SECRET_KEY'] = 'secretkey'\ndb = SQLAlchemy(app)\njwt = JWTManager(app)\n\nclass Livre(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    titre = db.Column(db.String(100), nullable=False)\n    auteur = db.Column(db.String(100), nullable=False)\n\nclass Membre(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    nom = db.Column(db.String(100), nullable=False)\n    prenom = db.Column(db.String(100), nullable=False)\n    email = db.Column(db.String(100), nullable=False)\n\nclass Emprunt(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    livre_id = db.Column(db.Integer, db.ForeignKey('livre.id'), nullable=False)\n    membre_id = db.Column(db.Integer, db.ForeignKey('membre.id'), nullable=False)\n    date_emprunt = db.Column(db.DateTime, nullable=False, default=db.func.current_timestamp())\n    date_retour = db.Column(db.DateTime, nullable=True)\n\n@app.route('/login', methods=['POST'])\ndef login():\n    email = request.json['email']\n    password = request.json['password']\n    membre = Membre.query.filter_by(email=email).first()\n    if membre and membre.password == password:\n        access_token = create_access_token(identity=membre.id)\n        return jsonify(access_token=access_token)\n    return jsonify(error='Mauvais email ou mot de passe'), 401\n\n@app.route('/livres', methods=['GET'])\n@jwt_required\ndef get_livres():\n    livres = Livre.query.all()\n    return jsonify([{'id': l.id, 'titre': l.titre, 'auteur': l.auteur} for l in livres])\n\n@app.route('/livres', methods=['POST'])\n@jwt_required\ndef add_livre():\n    titre = request.json['titre']\n    auteur = request.json['auteur']\n    livre = Livre(titre=titre, auteur=auteur)\n    db.session.add(livre)\n    db.session.commit()\n    return jsonify({'id': livre.id, 'titre': livre.titre, 'auteur': livre.auteur})\n\n@app.route('/livres/<int:id>', methods=['PUT'])\n@jwt_required\ndef update_livre(id):\n    livre = Livre.query.get(id)\n    if livre:\n        titre = request.json['titre']\n        auteur = request.json['auteur']\n        livre.titre = titre\n        livre.auteur = auteur\n        db.session.commit()\n        return jsonify({'id': livre.id, 'titre': livre.titre, 'auteur': livre.auteur})\n    return jsonify(error='Livre non trouvé'), 404\n\n@app.route('/livres/<int:id>', methods=['DELETE'])\n@jwt_required\ndef delete_livre(id):\n    livre = Livre.query.get(id)\n    if livre:\n        db.session.delete(livre)\n        db.session.commit()\n        return jsonify({'message': 'Livre supprimé'})\n    return jsonify(error='Livre non trouvé'), 404\n\n@app.route('/membres', methods=['GET'])\n@jwt_required\ndef get_membres():\n    membres = Membre.query.all()\n    return jsonify([{'id': m.id, 'nom': m.nom, 'prenom': m.prenom, 'email': m.email} for m in membres])\n\n@app.route('/membres', methods=['POST'])\n@jwt_required\ndef add_membre():\n    nom = request.json['nom']\n    prenom = request.json['prenom']\n    email = request.json['email']\n    password = request.json['password']\n    membre = Membre(nom=nom, prenom=prenom, email=email, password=password)\n    db.session.add(membre)\n    db.session.commit()\n    return jsonify({'id': membre.id, 'nom': membre.nom, 'prenom': membre.prenom, 'email': membre.email})\n\n@app.route('/membres/<int:id>', methods=['PUT'])\n@jwt_required\ndef update_membre(id):\n    membre = Membre.query.get(id)\n    if membre:\n        nom = request.json['nom']\n        prenom = request.json['prenom']\n        email = request.json['email']\n        password = request.json['password']\n        membre.nom = nom\n        membre.prenom = prenom\n        membre.email = email\n        membre.password = password\n        db.session.commit()\n        return jsonify({'id': membre.id, 'nom': membre.nom, 'prenom': membre.prenom, 'email': membre.email})\n    return jsonify(error='Membre non trouvé'), 404\n\n@app.route('/membres/<int:id>', methods=['DELETE'])\n@jwt_required\ndef delete_membre(id):\n    membre = Membre.query.get(id)\n    if membre:\n        db.session.delete(membre)\n        db.session.commit()\n        return jsonify({'message': 'Membre supprimé'})\n    return jsonify(error='Membre non trouvé'), 404\n\n@app.route('/emprunts', methods=['GET'])\n@jwt_required\ndef get_emprunts():\n    emprunts = Emprunt.query.all()\n    return jsonify([{'id': e.id, 'livre_id': e.livre_id, 'membre_id': e.membre_id, 'date_emprunt': e.date_emprunt, 'date_retour': e.date_retour} for e in emprunts])\n\n@app.route('/emprunts', methods=['POST'])\n@jwt_required\ndef add_emprunt():\n    livre_id = request.json['livre_id']\n    membre_id = request.json['membre_id']\n    emprunt = Emprunt(livre_id=livre_id, membre_id=membre_id)\n    db.session.add(emprunt)\n    db.session.commit()\n    return jsonify({'id': emprunt.id, 'livre_id': emprunt.livre_id, 'membre_id': emprunt.membre_id, 'date_emprunt': emprunt.date_emprunt, 'date_retour': emprunt.date_retour})\n\n@app.route('/emprunts/<int:id>', methods=['PUT'])\n@jwt_required\ndef update_emprunt(id):\n    emprunt = Emprunt.query.get(id)\n    if emprunt:\n        livre_id = request.json['livre_id']\n        membre_id = request.json['membre_id']\n        emprunt.livre_id = livre_id\n        emprunt.membre_id = membre_id\n        db.session.commit()\n        return jsonify({'id': emprunt.id, 'livre_id': emprunt.livre_id, 'membre_id': emprunt.membre_id, 'date_emprunt': emprunt.date_emprunt, 'date_retour': emprunt.date_retour})\n    return jsonify(error='Emprunt non trouvé'), 404\n\n@app.route('/emprunts/<int:id>', methods=['DELETE'])\n@jwt_required\ndef delete_emprunt(id):\n    emprunt = Emprunt.query.get(id)\n    if emprunt:\n        db.session.delete(emprunt)\n        db.session.commit()\n        return jsonify({'message': 'Emprunt supprimé'})\n    return jsonify(error='Emprunt non trouvé'), 404\n\n@app.route('/rapport', methods=['GET'])\n@jwt_required\ndef get_rapport():\n    livres = Livre.query.all()\n    membres = Membre.query.all()\n    emprunts = Emprunt.query.all()\n    pdf = FPDF()\n    pdf.add_page()\n    pdf.set_font(\"Arial\", size=15)\n    pdf.cell(200, 10, txt=\"Rapport bibliothèque\", ln=True, align='C')\n    pdf.ln(10)\n    for livre in livres:\n        pdf.cell(200, 10, txt=f\"Livre: {livre.titre} - Auteur: {livre.auteur}\", ln=True, align='L')\n    pdf.ln(10)\n    for membre in membres:\n        pdf.cell(200, 10, txt=f\"Membre: {membre.nom} {membre.prenom} - Email: {membre.email}\", ln=True, align='L')\n    pdf.ln(10)\n    for emprunt in emprunts:\n        pdf.cell(200, 10, txt=f\"Emprunt: Livre {emprunt.livre_id} - Membre {emprunt.membre_id} - Date emprunt: {emprunt.date_emprunt} - Date retour: {emprunt.date_retour}\", ln=True, align='L')\n    pdf.output(\"rapport.pdf\")\n    return jsonify({'message': 'Rapport généré'})\n\nif __name__ == \"__main__\":\n    app.run(debug=True)\n", "timestamp": 1766864243.375503}