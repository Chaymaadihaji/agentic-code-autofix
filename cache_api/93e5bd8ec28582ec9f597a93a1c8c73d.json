{"nom_fichier": "app.py", "code": "python\n# app.py\n\nfrom fastapi import FastAPI, Depends, HTTPException\nfrom pydantic import BaseModel\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom jose import JWTError, jwt\nfrom datetime import datetime, timedelta\nfrom fastapi.responses import JSONResponse\nfrom pymongo import MongoClient\nfrom typing import Optional\nfrom bson import ObjectId\n\napp = FastAPI(title=\"Mon API\",\n              description=\"API REST avec FastAPI et MongoDB\",\n              version=\"1.0\",\n              contact={\"name\": \"Toto\", \"email\": \"toto@example.com\"},)\n\n# Configurations\nSECRET_KEY = \"secreteeeftrt\"\nALGORITHM = \"HS256\"\nACCESS_TOKEN_EXPIRE_MINUTES = 30\n\n# Authentification JWT\ndef get_current_user(token: str = Depends(oauth2_scheme)):\n    try:\n        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])\n        return dict(payload)\n    except JWTError:\n        return None\n\ndef get_current_active_user(current_user: str = Depends(get_current_user)):\n    if current_user is None:\n        raise HTTPException(status_code=401, detail=\"Unauthorized\")\n    return current_user\n\n# Modèle de données\nclass Utilisateur(BaseModel):\n    id_utilisateur : Optional[str]\n    username: str\n    password: str\n\n# Chemin MongoDB\nclient = MongoClient(\"mongodb://localhost:27017/\")\ndatabase = client[\"mydatabase\"]\ncollection = database[\"utilisateurs\"]\n\n# Sécurité\noauth2_scheme = OAuth2PasswordBearer(tokenUrl=\"auth\")\n\n# Documentation Swagger\napi_v1_tag = {\n    \"name\": \"Utilisateurs\",\n    \"description\": \"Opérations relatives aux utilisateurs\"\n}\n\n@app.get(\"/users/\", response_model=list[Utilisateur], tags=[\"Utilisateurs\"])\nasync def read_users():\n    users = list(collection.find({}, {\"_id\": False}))\n    return users\n\n@app.post(\"/users/\", response_model=Utilisateur, tags=[\"Utilisateurs\"])\nasync def create_user(user: Utilisateur):\n    collection.insert_one(user.dict())\n    return user\n\n@app.get(\"/users/{id_utilisateur}\", response_model=Utilisateur, tags=[\"Utilisateurs\"])\nasync def read_user(id_utilisateur: str):\n    user = list(collection.find({\"id_utilisateur\": id_utilisateur}, {\"_id\": False}))\n    if not user:\n        raise HTTPException(status_code=404, detail=\"User not found\")\n    return user[0]\n\n@app.patch(\"/users/{id_utilisateur}\", response_model=Utilisateur, tags=[\"Utilisateurs\"])\nasync def update_user(id_utilisateur: str, user: Utilisateur):\n    collection.update_one({\"id_utilisateur\": id_utilisateur}, {\"$set\": user.dict()})\n    return user\n\n@app.delete(\"/users/{id_utilisateur}\", response_model=dict, tags=[\"Utilisateurs\"])\nasync def delete_user(id_utilisateur: str):\n    collection.delete_one({\"id_utilisateur\": id_utilisateur})\n    return {\"message\": \"User deleted\"}\n\n# Authentification\n@app.post(\"/auth\")\nasync def auth_user(form_data: OAuth2PasswordRequestForm = Depends()):\n    user = list(collection.find({\"username\": form_data.username, \"password\": form_data.password}, {\"_id\": False}))\n    if not user:\n        raise HTTPException(status_code=404, detail=\"User not found\")\n    access_token_expires = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)\n    access_token = jwt.encode({\"sub\": user[0][\"id_utilisateur\"], \"exp\": access_token_expires}, SECRET_KEY, algorithm=ALGORITHM)\n    return {\"access_token\": access_token, \"token_type\": \"bearer\"}\n\n# Gestion d'exceptions\n@app.exception_handler(Exception)\ndef exception_handler(request: Request, exc: Exception):\n    return JSONResponse(status_code=500, content={\"error\": str(exc}})\n", "langage": "python", "bugs_introduits": [], "corrections_appliquees": [], "timestamp": 1767107195.6598818, "tentative": 4}