{"nom_fichier": "main.py", "code": "python\n# main.py\n\nfrom fastapi import FastAPI, Depends, HTTPException\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom fastapi.responses import JSONResponse\nfrom pydantic import BaseModel\nfrom typing import Optional\nfrom datetime import datetime, timedelta\nfrom jose import jwt, JWTError\nfrom passlib.context import CryptContext\nfrom pymongo import MongoClient\nfrom bson.objectid import ObjectId\nfrom bson import pymongo\nfrom bson import json_util\n\n# Configuration\napp = FastAPI()\nMONGO_URI = \"mongodb://localhost:27017\"\n\n# MongoDB client\nclient = MongoClient(MONGO_URI)\ndb = client[\"mon_app\"]\n\n# Secret key pour la génération du jeton JWT\nSECRET_KEY = \"mon_secret_key\"\n\n# Algorithme pour la génération du jeton JWT\nALGORITHM = \"HS256\"\n\n# Temps de validité du jeton JWT\nACCESS_TOKEN_EXPIRE_MINUTES = 30\n\n# Configuration pour la sécurité\nsecurity = OAuth2PasswordBearer(tokenUrl=\"auth\")\n\n# Model pour la demande d'authentification\nclass UserRequest(BaseModel):\n    username: str\n    password: str\n\n# Model pour le user\nclass User(BaseModel):\n    id: str\n    username: str\n    email: str\n    token: Optional[str] = None\n\n# Gestion des exceptions\n@app.exception_handler(HTTPException)\nasync def http_exception_handler(request, exc):\n    return JSONResponse(status_code=exc.status_code, content={\"error\": exc.detail})\n\n# Génération d'un jeton JWT\ndef generate_token(data: dict, expires_delta: timedelta):\n    to_encode = data.copy()\n    expire = datetime.utcnow() + expires_delta\n    to_encode.update({\"exp\": expire})\n    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)\n    return encoded_jwt\n\n# Vérification d'un jeton JWT\ndef verify_token(token: str):\n    try:\n        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])\n        return payload\n    except JWTError:\n        raise HTTPException(status_code=401, detail=\"Invalid token\")\n\n# Fonction d'authentification\ndef auth_user(username: str, password: str):\n    user = db[\"users\"].find_one({\"username\": username})\n    if user and user[\"password\"] == password:\n        return user\n    raise HTTPException(status_code=401, detail=\"Invalid credentials\")\n\n# Fonction de récupération du token\ndef get_token():\n    token = JWT().get_token()\n    return token\n\n# Fonction de récupération des données utilisateur\ndef get_user_data(token: str):\n    payload = verify_token(token)\n    user_id = payload[\"sub\"]\n    user = db[\"users\"].find_one({\"_id\": ObjectId(user_id)})\n    return user\n\n# API d'authentification\n@app.post(\"/auth\")\nasync def auth(form_data: OAuth2PasswordRequestForm = Depends()):\n    user = auth_user(form_data.username, form_data.password)\n    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)\n    token = generate_token({\"sub\": str(user[\"_id\"]), \"exp\": expire}, timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES))\n    return {\"token\": token}\n\n# API de récupération des données utilisateur\n@app.get(\"/user\")\nasync def get_user(token: str = Depends(security)):\n    user = get_user_data(token)\n    return user\n\n# Documentation Swagger\nfrom fastapi.openapi.docs import get_swagger_ui_html\nfrom fastapi import FastAPI\nfrom fastapi.security import OAuth2PasswordBearer\n\napp.include_router(get_swagger_ui_html, tags=[\"Documentation\"])\n", "langage": "python", "bugs_introduits": [], "corrections_appliquees": [], "timestamp": 1767106572.8137202, "tentative": 2}