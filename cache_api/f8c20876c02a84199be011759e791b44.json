{"nom_fichier": "app.py", "code": "from flask import Flask, render_template, request, jsonify, session, redirect, url_for\nfrom flask_sqlalchemy import SQLAlchemy\nfrom flask_login import LoginManager, UserMixin, login_user, logout_user, login_required, current_user\nfrom werkzeug.security import generate_password_hash, check_password_hash\nfrom flask_wtf import FlaskForm\nfrom wtforms import StringField, PasswordField, SubmitField\nfrom wtforms.validators import DataRequired, Email, EqualTo\nfrom itsdangerous import URLSafeTimedSerializer, SignatureExpired\nimport smtplib\nfrom email.mime.multipart import MIMEMultipart\nfrom email.mime.text import MIMEText\nfrom flask_bootstrap import Bootstrap\nfrom flask_sslify import SSLify\nimport os\nfrom datetime import datetime\nfrom flask import send_file\nimport pytz\n\napp = Flask(__name__)\napp.config['SECRET_KEY'] = 'secret_key_here'\napp.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///projets_frontend\\projet_web_1766865214_c305b988\\database.db'\napp.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False\ndb = SQLAlchemy(app)\nlogin_manager = LoginManager()\nlogin_manager.init_app(app)\nlogin_manager.login_view = 'login'\nlogin_manager.login_message = 'Veuillez vous connecter pour accéder à cette page'\nlogin_manager.login_message_category = 'info'\nBootstrap(app)\nsslify = SSLify(app)\n\nclass Utilisateur(UserMixin, db.Model):\n    __tablename__ = 'utilisateurs'\n    id = db.Column(db.Integer, primary_key=True)\n    pseudo = db.Column(db.String(64), index=True, unique=True)\n    email = db.Column(db.String(120), index=True, unique=True)\n    motdepasse = db.Column(db.String(128))\n    historique = db.relationship('Historique', backref='utilisateur', lazy=True)\n\nclass Historique(db.Model):\n    __tablename__ = 'historique'\n    id = db.Column(db.Integer, primary_key=True)\n    utilisateurs_id = db.Column(db.Integer, db.ForeignKey('utilisateurs.id'), nullable=False)\n    date = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)\n\n@login_manager.user_loader\ndef load_user(id):\n    return Utilisateur.query.get(int(id))\n\nclass ConnexionForm(FlaskForm):\n    pseudo = StringField('Pseudo', validators=[DataRequired()])\n    motdepasse = PasswordField('Mot de passe', validators=[DataRequired()])\n    submit = SubmitField('Se connecter')\n\nclass InscriptionForm(FlaskForm):\n    pseudo = StringField('Pseudo', validators=[DataRequired()])\n    email = StringField('Email', validators=[DataRequired(), Email()])\n    motdepasse = PasswordField('Mot de passe', validators=[DataRequired()])\n    confirm_motdepasse = PasswordField('Confirmer le mot de passe', validators=[DataRequired(), EqualTo('motdepasse')])\n    submit = SubmitField('S\\'inscrire')\n\nclass MotdepasseOublieForm(FlaskForm):\n    email = StringField('Email', validators=[DataRequired(), Email()])\n    submit = SubmitField('Récupérer le mot de passe')\n\nclass EnvoiSMSForm(FlaskForm):\n    email = StringField('Email', validators=[DataRequired(), Email()])\n    submit = SubmitField('Envoyer le SMS')\n\nclass HistoriqueForm(FlaskForm):\n    submit = SubmitField('Afficher l\\'historique')\n\n@app.route('/', methods=['GET', 'POST'])\ndef index():\n    form = ConnexionForm()\n    if form.validate_on_submit():\n        utilisateur = Utilisateur.query.filter_by(pseudo=form.pseudo.data).first()\n        if utilisateur and check_password_hash(utilisateur.motdepasse, form.motdepasse.data):\n            login_user(utilisateur)\n            return redirect(url_for('historique'))\n    return render_template('index.html', title='Connexion', form=form)\n\n@app.route('/inscription', methods=['GET', 'POST'])\ndef inscription():\n    form = InscriptionForm()\n    if form.validate_on_submit():\n        utilisateur = Utilisateur(pseudo=form.pseudo.data, email=form.email.data, motdepasse=generate_password_hash(form.motdepasse.data))\n        db.session.add(utilisateur)\n        db.session.commit()\n        return redirect(url_for('connexion'))\n    return render_template('inscription.html', title='Inscription', form=form)\n\n@app.route('/connexion', methods=['GET', 'POST'])\n@login_required\ndef connexion():\n    form = EnvoiSMSForm()\n    if form.validate_on_submit():\n        utilisateur = Utilisateur.query.filter_by(email=form.email.data).first()\n        if utilisateur:\n            # Envoi du SMS\n            msg = MIMEMultipart()\n            msg['From'] = 'votre_adresse_email@gmail.com'\n            msg['To'] = form.email.data\n            msg['Subject'] = 'Réinitialisation du mot de passe'\n            body = 'Votre lien de réinitialisation est: http://localhost:5000/reinitialisation'\n            msg.attach(MIMEText(body, 'plain'))\n            server = smtplib.SMTP('smtp.gmail.com', 587)\n            server.starttls()\n            server.login(msg['From'], 'votre_mot_de_passe')\n            text = msg.as_string()\n            server.sendmail(msg['From'], msg['To'], text)\n            server.quit()\n            return redirect(url_for('reinitialisation'))\n    return render_template('connexion.html', title='Connexion', form=form)\n\n@app.route('/reinitialisation', methods=['GET', 'POST'])\ndef reinitialisation():\n    form = MotdepasseOublieForm()\n    if form.validate_on_submit():\n        utilisateur = Utilisateur.query.filter_by(email=form.email.data).first()\n        if utilisateur:\n            # Envoi du SMS\n            msg = MIMEMultipart()\n            msg['From'] = 'votre_adresse_email@gmail.com'\n            msg['To'] = form.email.data\n            msg['Subject'] = 'Réinitialisation du mot de passe'\n            body = 'Votre lien de réinitialisation est: http://localhost:5000/reinitialisation'\n            msg.attach(MIMEText(body, 'plain'))\n            server = smtplib.SMTP('smtp.gmail.com', 587)\n            server.starttls()\n            server.login(msg['From'], 'votre_mot_de_passe')\n            text = msg.as_string()\n            server.sendmail(msg['From'], msg['To'], text)\n            server.quit()\n            return redirect(url_for('reinitialisation'))\n    return render_template('reinitialisation.html', title='Réinitialisation', form=form)\n\n@app.route('/historique', methods=['GET', 'POST'])\n@login_required\ndef historique():\n    form = HistoriqueForm()\n    if form.validate_on_submit():\n        return redirect(url_for('historique'))\n    return render_template('historique.html', title='Historique', form=form)\n\n@app.route('/logout')\n@login_required\ndef logout():\n    logout_user()\n    return redirect(url_for('index'))\n\n@app.route('/api/historique', methods=['GET'])\n@login_required\ndef api_historique():\n    historiques = Historique.query.all()\n    return jsonify([{'date': h.date, 'utilisateur_id': h.utilisateurs.id} for h in historiques])\n\nif __name__ == \"__main__\":\n    app.run(debug=True)\n", "timestamp": 1766865240.087678}