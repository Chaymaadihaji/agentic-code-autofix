{"nom_fichier": "app.py", "code": "```python\n# app.py\n\nfrom flask import Flask, render_template, request, redirect, url_for\nfrom flask_sqlalchemy import SQLAlchemy\nfrom flask_login import LoginManager, UserMixin, login_required, login_user, logout_user, current_user\nfrom flask_restful import Api\nfrom flask_wtf import FlaskForm\nfrom wtforms import StringField, PasswordField, SubmitField\nfrom wtforms.validators import DataRequired, Email, EqualTo\nfrom flask_ckeditor import CKEditor\nfrom flask_mail import Mail, Message\nfrom datetime import datetime\nfrom pytz import timezone\nfrom sqlalchemy import func\nfrom werkzeug.security import generate_password_hash, check_password_hash\nimport os\nimport csv\nimport pdfkit\nfrom jinja2 import Template\n\n# Config\napp = Flask(__name__)\napp.config['SECRET_KEY'] = 'secret_key_here'\napp.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///bibliotheque.db'\napp.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False\napp.config['MAIL_SERVER'] = 'smtp.gmail.com'\napp.config['MAIL_PORT'] = 465\napp.config['MAIL_USE_TLS'] = False\napp.config['MAIL_USE_SSL'] = True\napp.config['MAIL_USERNAME'] = 'votre_email@gmail.com'\napp.config['MAIL_PASSWORD'] = 'votre_mot_de_passe'\n\n# Initialize\ndb = SQLAlchemy(app)\nlogin_manager = LoginManager(app)\napi = Api(app)\nckeditor = CKEditor(app)\nmail = Mail(app)\n\n# Models\nclass User(UserMixin, db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    username = db.Column(db.String(64), unique=True, nullable=False)\n    email = db.Column(db.String(120), unique=True, nullable=False)\n    password = db.Column(db.String(128), nullable=False)\n    books = db.relationship('Book', backref='user', lazy=True)\n\nclass Book(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    title = db.Column(db.String(100), nullable=False)\n    author = db.Column(db.String(100), nullable=False)\n    publication_date = db.Column(db.DateTime, nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=True)\n\nclass Emprunt(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    book_id = db.Column(db.Integer, db.ForeignKey('book.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)\n    start_date = db.Column(db.DateTime, nullable=False)\n    end_date = db.Column(db.DateTime, nullable=False)\n\n# Forms\nclass RegistrationForm(FlaskForm):\n    username = StringField('Username', validators=[DataRequired()])\n    email = StringField('Email', validators=[DataRequired(), Email()])\n    password = PasswordField('Password', validators=[DataRequired()])\n    confirm_password = PasswordField('Confirm Password', validators=[DataRequired(), EqualTo('password')])\n    submit = SubmitField('Register')\n\nclass LoginForm(FlaskForm):\n    email = StringField('Email', validators=[DataRequired(), Email()])\n    password = PasswordField('Password', validators=[DataRequired()])\n    submit = SubmitField('Login')\n\n# API Routes\nclass BookResource(Resource):\n    def get(self):\n        return {'books': [book.to_dict() for book in Book.query.all()]}\n\nclass EmpruntResource(Resource):\n    def get(self):\n        return {'emprunts': [emprunt.to_dict() for emprunt in Emprunt.query.all()]}\n\n# Dashboard Routes\n@app.route('/dashboard')\n@login_required\ndef dashboard():\n    statistiques = db.session.query(Book).all()\n    return render_template('dashboard.html', statistiques=statistiques)\n\n# API\napi.add_resource(BookResource, '/api/books')\napi.add_resource(EmpruntResource, '/api/emprunts')\n\n# Login Manager\n@login_manager.user_loader\ndef load_user(user_id):\n    return User.query.get(int(user_id))\n\n# Routes\n@app.route('/')\ndef index():\n    return render_template('index.html')\n\n@app.route('/inscription', methods=['GET', 'POST'])\ndef inscription():\n    form = RegistrationForm()\n    if form.validate_on_submit():\n        user = User(username=form.username.data, email=form.email.data, password=generate_password_hash(form.password.data))\n        db.session.add(user)\n        db.session.commit()\n        return redirect(url_for('login'))\n    return render_template('inscription.html', form=form)\n\n@app.route('/connexion', methods=['GET', 'POST'])\ndef login():\n    form = LoginForm()\n    if form.validate_on_submit():\n        user = User.query.filter_by(email=form.email.data).first()\n        if user and check_password_hash(user.password, form.password.data):\n            login_user(user)\n            return redirect(url_for('dashboard'))\n    return render_template('connexion.html', form=form)\n\n@app.route('/deconnexion')\n@login_required\ndef deconnexion():\n    logout_user()\n    return redirect(url_for('index'))\n\n@app.route('/livres')\n@login_required\ndef livres():\n    livres = Book.query.all()\n    return render_template('livres.html', livres=livres)\n\n@app.route('/ajouter_livre', methods=['GET', 'POST'])\n@login_required\ndef ajouter_livre():\n    if request.method == 'POST':\n        book = Book(title=request.form['title'], author=request.form['author'], publication_date=datetime.strptime(request.form['publication_date'], '%Y-%m-%d'))\n        db.session.add(book)\n        db.session.commit()\n        return redirect(url_for('livres'))\n    return render_template('ajouter_livre.html')\n\n@app.route('/modifier_livre/<int:book_id>', methods=['GET', 'POST'])\n@login_required\ndef modifier_livre(book_id):\n    book = Book.query.get(book_id)\n    if request.method == 'POST':\n        book.title = request.form['title']\n        book.author = request.form['author']\n        book.publication_date = datetime.strptime(request.form['publication_date'], '%Y-%m-%d')\n        db.session.commit()\n        return redirect(url_for('livres'))\n    return render_template('modifier_livre.html', book=book)\n\n@app.route('/supprimer_livre/<int:book_id>')\n@login_required\ndef supprimer_livre(book_id):\n    book = Book.query.get(book_id)\n    db.session.delete(book)\n    db.session.commit()\n    return redirect(url_for('livres'))\n\n@app.route('/rechercher_livre', methods=['GET', 'POST'])\n@login_required\ndef rechercher_livre():\n    if request.method == 'POST':\n        livres = Book.query.filter(Book.title.like('%' + request.form['recherche'] + '%')).all()\n        return render_template('rechercher_livre.html', livres=livres)\n    return render_template('rechercher_livre.html')\n\n@app.route('/emprunter/<int:book_id>', methods=['GET', 'POST'])\n@login_required\ndef emprunter(book_id):\n    book = Book.query.get(book_id)\n    if request.method == 'POST':\n        emprunt = Emprunt(book_id=book_id, user_id=current_user.id, start_date=datetime.now(), end_date=datetime.now() + datetime.timedelta(days=14))\n        db.session.add(emprunt)\n        db.session.commit()\n        return redirect(url_for('livres'))\n    return render_template('emprunter.html', book=book)\n\n@app.route('/retourner/<int:emprunt_id>')\n@login_required\ndef retourner(emprunt_id):\n    emprunt = Emprunt.query.get(emprunt_id)\n    emprunt.end_date = datetime.now()\n    db.session.commit()\n    return redirect(url_for('livres'))\n\n# Export CSV\n@app.route('/export_csv')\n@login_required\ndef export_csv():\n    livres = Book.query.all()\n    with open('livres.csv', 'w', newline='') as csvfile:\n        writer = csv.writer(csvfile)\n        writer.writerow(['Titre', 'Auteur', 'Date de publication'])\n        for livre in livres:\n            writer.writerow([livre.title, livre.author, livre.publication_date])\n    return redirect(url_for('download_csv'))\n\n@app.route('/download_csv')\n@login_required\ndef download_csv():\n    return send_file('livres.csv', as_attachment=True)\n\n# Export PDF\n@app.route('/export_pdf')\n@login_required\ndef export_pdf():\n    livres = Book.query.all()\n    template = Template('livres.html')\n    html = template.render(livres=livres)\n    pdfkit.from_string(html, 'livres.pdf')\n    return redirect(url_for('download_pdf'))\n\n@app.route('/download_pdf')\n@login_required\ndef download_pdf():\n    return send_file('livres.pdf', as_attachment=True)\n\n# Recherche avancée\n@app.route('/rechercher_avancee', methods=['GET', 'POST'])\n@login_required\ndef rechercher_avancee():\n    if request.method == 'POST':\n        livres = Book.query.filter(Book.title.like('%' + request.form['recherche'] + '%')).all()\n        return render_template('rechercher_avancee.html', livres=livres)\n    return render_template('rechercher_avancee.html')\n\n# Système de recommandation\n@app.route('/recommandations')\n@login_required\ndef recommandations():\n    livres = Book.query.all()\n    recommandations = []\n    for livre in livres:\n        if livre.user_id == current_user.id:\n            recommandations.append(livre)\n    return render_template('recommandations.html', recommandations=recommandations)\n\n# Run\nif __name__ == '__main__':\n    db.create_all()\n    app\n", "timestamp": 1766872970.9287498}