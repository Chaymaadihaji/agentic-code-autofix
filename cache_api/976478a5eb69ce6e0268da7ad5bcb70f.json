{"nom_fichier": "app.py", "code": "from flask import Flask, render_template, request, redirect, url_for, flash\nfrom flask_login import LoginManager, UserMixin, login_user, logout_user, login_required, current_user\nfrom flask_sqlalchemy import SQLAlchemy\nfrom flask_bcrypt import Bcrypt\nfrom flask_bootstrap import Bootstrap\nimport smtplib\nimport random\nimport string\nfrom email.mime.multipart import MIMEMultipart\nfrom email.mime.text import MIMEText\nimport hashlib\nimport os\n\napp = Flask(__name__)\napp.config['SECRET_KEY'] = 'secret_key'\napp.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///users.db'\napp.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False\n\ndb = SQLAlchemy(app)\nbcrypt = Bcrypt(app)\nbootstrap = Bootstrap(app)\nlogin_manager = LoginManager(app)\n\nclass User(UserMixin, db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    email = db.Column(db.String(100), unique=True, nullable=False)\n    password = db.Column(db.String(256), nullable=False)\n    connected_at = db.Column(db.DateTime, nullable=False, default=db.func.current_timestamp())\n    history = db.relationship('History', backref='user', lazy=True)\n\nclass History(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)\n    connected_at = db.Column(db.DateTime, nullable=False, default=db.func.current_timestamp())\n\ndef send_sms(phone_number, code):\n    msg = MIMEMultipart()\n    msg['From'] = 'your_email@gmail.com'\n    msg['To'] = phone_number\n    msg['Subject'] = 'Réinitialisation de mot de passe'\n    body = f'Votre code de réinitialisation est : {code}'\n    msg.attach(MIMEText(body, 'plain'))\n    server = smtplib.SMTP('smtp.gmail.com', 587)\n    server.starttls()\n    server.login(msg['From'], 'your_password')\n    text = msg.as_string()\n    server.sendmail(msg['From'], msg['To'], text)\n    server.quit()\n\ndef validate_email(email):\n    email_regex = r'^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\\.[a-zA-Z0-9-.]+$'\n    return bool(re.match(email_regex, email))\n\ndef generate_code(length=6):\n    return ''.join(random.choices(string.digits, k=length))\n\n@login_manager.user_loader\ndef load_user(user_id):\n    return User.query.get(int(user_id))\n\n@app.route('/')\ndef index():\n    return render_template('index.html')\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    if request.method == 'POST':\n        email = request.form['email']\n        password = request.form['password']\n        user = User.query.filter_by(email=email).first()\n        if user and bcrypt.check_password_hash(user.password, password):\n            login_user(user)\n            return redirect(url_for('dashboard'))\n        else:\n            flash('Email ou mot de passe incorrect')\n    return render_template('login.html')\n\n@app.route('/register', methods=['GET', 'POST'])\ndef register():\n    if request.method == 'POST':\n        email = request.form['email']\n        password = request.form['password']\n        confirm_password = request.form['confirm_password']\n        if validate_email(email):\n            if password == confirm_password:\n                hashed_password = bcrypt.generate_password_hash(password).decode('utf-8')\n                user = User(email=email, password=hashed_password)\n                db.session.add(user)\n                db.session.commit()\n                return redirect(url_for('login'))\n            else:\n                flash('Les mots de passe ne correspondent pas')\n        else:\n            flash('Email non valide')\n    return render_template('register.html')\n\n@app.route('/forgot_password', methods=['GET', 'POST'])\ndef forgot_password():\n    if request.method == 'POST':\n        email = request.form['email']\n        if validate_email(email):\n            user = User.query.filter_by(email=email).first()\n            if user:\n                code = generate_code()\n                send_sms(user.email, code)\n                user.code = code\n                db.session.commit()\n                return redirect(url_for('reset_password', email=email))\n            else:\n                flash('Cet email n\\'est pas enregistré')\n        else:\n            flash('Email non valide')\n    return render_template('forgot_password.html')\n\n@app.route('/reset_password/<email>', methods=['GET', 'POST'])\ndef reset_password(email):\n    if request.method == 'POST':\n        code = request.form['code']\n        new_password = request.form['new_password']\n        confirm_password = request.form['confirm_password']\n        if code == User.query.filter_by(email=email).first().code:\n            if new_password == confirm_password:\n                hashed_password = bcrypt.generate_password_hash(new_password).decode('utf-8')\n                User.query.filter_by(email=email).first().password = hashed_password\n                db.session.commit()\n                return redirect(url_for('login'))\n            else:\n                flash('Les mots de passe ne correspondent pas')\n        else:\n            flash('Code de réinitialisation incorrect')\n    return render_template('reset_password.html', email=email)\n\n@app.route('/dashboard')\n@login_required\ndef dashboard():\n    return render_template('dashboard.html')\n\n@app.route('/logout')\n@login_required\ndef logout():\n    logout_user()\n    return redirect(url_for('index'))\n\nif __name__ == \"__main__\":\n    db.create_all()\n    app.run(debug=True)\n", "timestamp": 1766865407.45341}