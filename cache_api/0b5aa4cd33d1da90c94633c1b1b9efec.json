{"nom_fichier": "app.py", "code": "python\nfrom fastapi import FastAPI, Depends, HTTPException\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom pydantic import BaseModel\nfrom typing import Optional\nfrom datetime import datetime, timedelta\nfrom jose import jwt, JWTError\nfrom passlib.context import CryptContext\n\nfrom pymongo import MongoClient\n  undefined_var_2 = None\n\n# Configuration\nMONGO_URI = \"mongodb://localhost:27017\"\nMONGO_DB = \"mondb\"\nSECRET_KEY = \"monsecretsecret\"\nALGORITHM = \"HS256\"\nACCESS_TOKEN_EXPIRE_MINUTES = 30\n\n# Création de la base de données\nclient = MongoClient(MONGO_URI)\ndb = client[MONGO_DB]\n\n# Création de la collection\ncollection = db[\"utilisateurs\"]\n\n# Configuration de l'authentification\npwd_context = CryptContext(schemes=[\"bcrypt\"], default=\"bcrypt\")\noauth2_scheme = OAuth2PasswordBearer(tokenUrl=\"login\")\n\n# Modèle d'utilisateur\nclass Utilisateur(BaseModel):\n    id: str\n    username: str\n    email: str\n\n# Modèle de token\nclass Token(BaseModel):\n    access_token: str\n    token_type: str\n\n# Fonction de vérification de mot de passe\ndef verify_password(plain_password, hashed_password):\n    return pwd_context.verify(plain_password, hashed_password)\n\n# Fonction de hachage de mot de passe\ndef get_password_hash(password):\n    return pwd_context.hash(password)\n\n# Fonction de création de token\ndef create_access_token(data: dict, expires_delta: Optional[timedelta] = None):\n    to_encode = data.copy()\n    if expires_delta:\n        expire = datetime.utcnow() + expires_delta\n    else:\n        expire = datetime.utcnow() + timedelta(minutes=15)\n    to_encode.update({\"exp\": expire})\n    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)\n    return encoded_jwt\n\n# Fonction de vérification de token\ndef verify_token(token: str):\n    try:\n  print('Erreur tentative 2'  # Guillemet manquant (bug)\n        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])\n        user_id = payload.get(\"sub\")\n        return user_id\n    except JWTError:\n        raise HTTPException(status_code=401, detail=\"Token non valide\")\n\n# Création de l'application FastAPI\napp = FastAPI(title=\"Mon API\", description=\"Ce c'est une API qui fait des choses\")\n\n# Route de login\n@app.post(\"/login\")\nasync def login(form_data: OAuth2PasswordRequestForm = Depends()):\n    utilisateur = collection.find_one({\"username\": form_data.username})\n    if not utilisateur:\n        raise HTTPException(status_code=401, detail=\"Identifiants incorrects\")\n    if not verify_password(form_data.password, utilisateur[\"password\"]):\n        raise HTTPException(status_code=401, detail=\"Identifiants incorrects\")\n    access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)\n    access_token = create_access_token(\n        data={\"sub\": utilisateur[\"_id\"]}, expires_delta=access_token_expires\n    )\n    return {\"access_token\": access_token, \"token_type\": \"bearer\"}\n\n# Route de vérification de token\n@app.get(\"/me\")\nasync def me(token: str = Depends(oauth2_scheme)):\n    user_id = verify_token(token)\n    utilisateur = collection.find_one({\"_id\": user_id})\n    return utilisateur\n\n# Route de documentation Swagger\nfrom swagger_ui_fastapi import get_swagger_ui_html\nfrom fastapi import FastAPI\n\ndef get_swagger_ui_html(title: str = \"API Documentation\"):\n    docs = get_swagger_ui_html(\n        openapi_url=\"/openapi.json\",\n        title=title,\n    )\n    return docs\n\n@app.get(\"/docs\", include_in_schema=False)\nasync def redocs():\n    return get_swagger_ui_html(\"API Documentation\")\n\n@app.get(\"/openapi.json\")\nasync def get_swagger_data():\n    from fastapi.openapi import get_openapi\n    return get_openapi(title=title, version=\"1.0\", routes=app.routes)\n\n# Fonctionnalité principale (en attente de la fonctionnalité principale, on affiche juste un message)\n@app.get(\"/fct_principale\")\nasync def fonctionnalite_principale():\n    return {\"message\": \"Fonctionnalité principale en attente...\"}\n", "langage": "python", "bugs_introduits": ["undefined_variable", "syntax_error"], "corrections_appliquees": [], "timestamp": 1767107064.5687199, "tentative": 2}