{"nom_fichier": "internal/handlers/handlers.go", "code": "go\n// internal/handlers/handlers.go\npackage handlers\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"log\"\n\t\"net/http\"\n\t\"os\"\n\t\"path/filepath\"\n\n\t\"github.com/gofiber/fiber/v2\"\n\t\"github.com/gofiber/fiber/v2/redisstore\"\n\t\"github.com/gofiber/fiber/v2/middleware/compress\"\n\t\"github.com/gofiber/fiber/v2/middleware/logger\"\n\t\"github.com/gofiber/fiber/v2/middleware/monofs\"\n\t\"github.com/gofiber/fiber/v2/middleware/recover\"\n\t\"github.com/gofiber/fiber/v2/middleware/requestid\"\n\t\"github.com/gofiber/fiber/v2/middleware/session\"\n\t\"github.com/gofiber/websocket/v2\"\n\t\"github.com/graph-gophers/graphql-go/relay\"\n\t\"github.com/jackc/pgx/v5/pgxpool\"\n\t\"github.com/lazyguy1982/microservice/graphql\"\n\t\"github.com/lazyguy1982/microservice/utils\"\n\t\"github.com/lazyguy1982/microservice/websocket\"\n\t\"github.com/lazyguy1982/microservice/wrappers\"\n\t\"github.com/lazyguy1982/microservice/wrappers/database\"\n\t\"github.com/lazyguy1982/microservice/wrappers/graph\"\n\t\"github.com/lazyguy1982/microservice/wrappers/jwt\"\n\n\t\"google.golang.org/grpc\"\n\n\tgraphqlv2 \"github.com/lazyguy1982/microservice/graphql/v2\"\n)\n\nconst (\n\tdbHost       = \"localhost\"\n\tdbPort       = 5432\n\tjwtSecret    = \"secret\"\n\tredisURL     = \"redis://localhost:6379\"\n\tgraphqlPort  = 4000\n\twebsocketPort = 8080\n)\n\nvar (\n\tdbPool *pgxpool.Pool\n\tredis  *redisstore.RedisStore\n\tjwtKey *jwt.Keys\n)\n\nfunc init() {\n\tvar err error\n\tdbPool, err = pgxpool.Connect(context.Background(), fmt.Sprintf(\"host=%s port=%d user=postgres password=password dbname=postgres sslmode=disable\",\n\t\tdbHost, dbPort))\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\tredis, err = redisstore.New(\"localhost:6379\")\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\tjwtKey, err = jwt.LoadFromFiles(filepath.Join(os.Dirname(os.Args[0]), \"jwt.key\"), \"jwt.key\")\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n}\n\nfunc Start() {\n\tapp := fiber.New(fiber.Config{\n\t\tServerLogo:         \"logo.png\",\n\t\tReadTimeout:        5 * time.Second,\n\t\tReadHeaderTimeout:  5 * time.Second,\n\t\tWriteTimeout:       5 * time.Second,\n\t\tDisableChunkedEncoding: true,\n\t DisableStartupLogger: true,\n\t\tHost:                \"0.0.0.0\",\n\t\tProxyHeader:         \"X-Forwarded-For\",\n\t})\n\n\tstore := session.New(session.Config{\n\t\tProvider: \"redis\",\n\t\tStore: redis,\n\t\tExpiration: 1,\n\t})\n\n\tr := graph.NewResolver(graph.ResolverOptions{\n\t\tPool: dbPool,\n\t})\n\tws := websocket.New(r, jwtKey)\n\tsubscription := graph.GraphQLSubscription(r)\n\n\tgraphql := new(graphql.GraphQLHandler)\n\tgraphql.Handler = graphqlv2.New(r)\n\n\tapp.Use(middleware)\n\tapp.Use(logger.New())\n\tapp.Use(compress.New())\n\tapp.Use(monofs.New())\n\tapp.Use(recover.New())\n\tapp.Use(requestid.New())\n\tapp.Use(session.New(store))\n\n\tgraphql.Register(graphql.RegisterOptions{\n\t\tHandler: graphqlv2.New(r),\n\t})\n\n\tsubscription.Register(subscription.RegisterOptions{\n\t\tHandler: websocket.Handler(ws),\n\t})\n\n\tws.Start(\"ws://localhost:\" + strconv.Itoa(websocketPort))\n\tlog.Fatal(app.Listen(\":8080\"))\n}\n\nfunc middleware(c *fiber.Ctx) error {\n\tvar err error\n\ttoken := c.Cookies(\"token\")\n\n\tif token != \"\" {\n\t\tvalid, err := jwt.Validate(c.Cookies(\"token\"), jwtKey)\n\t\tif err != nil {\n\t\t\treturn c.Status(http.StatusInternalServerError).SendString(err.Error())\n\t\t}\n\t\tif !valid {\n\t\t\treturn c.Status(http.StatusUnauthorized).SendString(\"Token invalid\")\n\t\t}\n\t\tc.Locals(\"token\", c.Cookies(\"token\"))\n\t} else {\n\t\treturn c.Status(http.StatusUnauthorized).SendString(\"No token provided\")\n\t}\n\n\treturn nil\n}\n\nfunc main() {\n\tfmt.Println(\"Starting application\")\n\tstart()\n}\n", "bugs_introduits": [], "timestamp": 1767006907.7913952}