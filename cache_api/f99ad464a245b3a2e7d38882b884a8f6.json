{"nom_fichier": "cmd/api/main.go", "code": "go\n// File: cmd/api/main.go\n// Description: API GraphQL en Go avec Gqlgen, base de données PostgreSQL, authentification JWT, subscriptions WebSocket, et déploiement sur Kubernetes\n\npackage main\n\n// MISSING IMPORT (bug)\n\t\"context\"\n\t\"database/sql\"\n\t\"fmt\"\n\t\"log\"\n\t\"net/http\"\n\n\t\"github.com/gorilla/handlers\"\n\t\"github.com/gorilla/mux\"\n\t\"github.com/graphql-go/graphql\"\n\t\"github.com/graphql-go/handler\"\n\t\"github.com/joho/godotenv\"\n\t\"github.com/lib/pq\"\n\t\"github.com/graphql-go/graphql/gqlerrors\"\n\t\"github.com/graphql-go/relay\"\n\t\"github.com/golang-jwt/jwt/v4\"\n\t\"github.com/grpc-ecosystem/go-grpc-middleware/recovery\"\n\t\"k8s.io/client-go/kubernetes\"\n\n\t\"github.com/graphql-go/graphql/gqllist\"\n\t_ \"github.com/lib/pq/extension\"\n\t_ \"github.com/postgres/postgres\"\n\n\tgraphqlGo \"github.com/graphql-go/graphql/go\"\n\tgraphqlPg \"github.com/graphql-go/graphql/postgres\"\n)\n\n// Define les types de données\ntype User struct {\n\tID       string `json:\"id\"`\n\tUsername string `json:\"username\"`\n\tPassword string `json:\"password\"`\n}\n\n// Configure the PostgreSQL database\nconst (\n\tdbDSN = \"user=myuserepass=monpass#db=mydatabase host=localhost port=5432\"\n)\n\nfunc ConnectDB() (*sql.DB, error) {\n\tdb, err := sql.Open(\"postgres\", dbDSN)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\treturn db, nil\n}\n\n// Configure le GraphQL Schema\nfunc main() {\n\tlogger := log.New(log.Writer(), log.Ldate|log.Ltime|log.Llongfile, log.LstdFlags)\n\n\t// Charger les variables d'environnement\n\tif err := godotenv.Load(); err != nil {\n\t\tlogger.Fatal(err)\n\t}\n\n\t// Connexion à la base de données\n\tdb, err := ConnectDB()\n\tif err != nil {\n\t\tlogger.Fatal(err)\n\t}\n\n\t// Définition du schema GraphQL\n\tschema, err := graphql.NewSchema(\n\t\tgraphql.SchemaConfig{\n\t\t\tQuery: graphql.NewObject(\n\t\t\t\tgraphql.ObjectConfig{\n\t\t\t\t\tName: \"Query\",\n\t\t\t\t\tFields: graphql.Fields{\n\t\t\t\t\t\t\"users\": &graphql.Field{\n\t\t\t\t\t\t\tType: graphql.NewList(graphqlInt),\n\t\t\t\t\t\t\tResolve: func(parent interface{}, args interface{}) (interface{}, error) {\n\t\t\t\t\t\t\t\tvar users []User\n\t\t\t\t\t\t\t\tvar err error\n\n\t\t\t\t\t\t\t\tswitch args.(string) {\n\t\t\t\t\t\t\t\tcase \"id\":\n\t\t\t\t\t\t\t\t\trows, err := db.Query(\"SELECT id FROM users\")\n\t\t\t\t\t\t\t\t\tdefer rows.Close()\n\t\t\t\t\t\t\t\t\tif err != nil {\n\t\t\t\t\t\t\t\t\t\treturn nil, err\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\tfor rows.Next() {\n\t\t\t\t\t\t\t\t\t\tvar user User\n\t\t\t\t\t\t\t\t\t\terr = rows.Scan(&user.ID)\n\t\t\t\t\t\t\t\t\t\tif err != nil {\n\t\t\t\t\t\t\t\t\t\t\treturn nil, err\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\tusers = append(users, user)\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\treturn users, nil\n\t\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\t\treturn nil, gqlerrors.FormatError(errors.New(\"Method not supported\"))\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t),\n\t\t\tMutation: graphql.NewObject(\n\t\t\t\tgraphql.ObjectConfig{\n\t\t\t\t\tName: \"Mutation\",\n\t\t\t\t\tFields: graphql.Fields{\n\t\t\t\t\t\t\"register\": &graphql.Field{\n\t\t\t\t\t\t\tType: graphql.NewObject(graphql.ObjectConfig{\n\t\t\t\t\t\t\t\tName: \"RegisterResult\",\n\t\t\t\t\t\t\t\tFields: graphql.Fields{\n\t\t\t\t\t\t\t\t\t\"token\": &graphql.Field{\n\t\t\t\t\t\t\t\t\t\tType: graphql.String,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\"user\": &graphql.Field{\n\t\t\t\t\t\t\t\t\t\tType: graphql.NewObject(graphql.ObjectConfig{\n\t\t\t\t\t\t\t\t\t\t\tName: \"User\",\n\t\t\t\t\t\t\t\t\t\t\tFields: graphql.Fields{\n\t\t\t\t\t\t\t\t\t\t\t\t\"id\": &graphql.Field{\n\t\t\t\t\t\t\t\t\t\t\t\t\tType: graphql.String,\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\"username\": &graphql.Field{\n\t\t\t\t\t\t\t\t\t\t\t\t\tType: graphql.String,\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\"password\": &graphql.Field{\n\t\t\t\t\t\t\t\t\t\t\t\t\tType: graphql.String,\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\tArgs: graphql.FieldConfigArgument{\n\t\t\t\t\t\t\t\t\"username\": &graphql.ArgumentConfig{\n\t\t\t\t\t\t\t\t\tType: graphql.String,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"password\": &graphql.ArgumentConfig{\n\t\t\t\t\t\t\t\t\tType: graphql.String,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tResolve: func(parent interface{}, args interface{}) (interface{}, error) {\n\t\t\t\t\t\t\t\tusername := args.(map[string]string)[\"username\"]\n\t\t\t\t\t\t\t\tpassword := args.(map[string]string)[\"password\"]\n\n\t\t\t\t\t\t\t\tvar user User\n\t\t\t\t\t\t\t\tuser.ID = fmt.Sprintf(\"%s\", time.Now().UnixNano())\n\t\t\t\t\t\t\t\tuser.Username = username\n\t\t\t\t\t\t\t\tuser.Password = password\n\n\t\t\t\t\t\t\t\tctx := context.Background()\n\t\t\t\t\t\t\t\t// Inserer dans la base de données\n\t\t\t\t\t\t\t\t_, err := db.ExecContext(ctx, \"INSERT INTO users (id, username, password) VALUES ($1, $2, $3)\", user.ID, user.Username, user.Password)\n\t\t\t\t\t\t\t\tif err != nil {\n\t\t\t\t\t\t\t\t\treturn nil, err\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t// Générer un jeton JWT\n\t\t\t\t\t\t\t\ttoken := jwt.NewWithClaims(jwt.SigningMethodHS256, jwt.MapClaims{\n\t\t\t\t\t\t\t\t\t\"token\": true,\n\t\t\t\t\t\t\t\t\t\"user_id\": user.ID,\n\t\t\t\t\t\t\t\t})\n\n\t\t\t\t\t\t\t\treturn map[string]string{\n\t\t\t\t\t\t\t\t\t\"token\": token.SignedString([]byte(\"secret\")),\n\t\t\t\t\t\t\t\t\t\"user\": map[string]string{\n\t\t\t\t\t\t\t\t\t\t\"id\":       user.ID,\n\t\t\t\t\t\t\t\t\t\t\"username\": user.Username,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t}, nil\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t),\n\t\t\tSubscribe: graphql.NewObject(\n\t\t\t\tgraphql.ObjectConfig{\n\t\t\t\t\tName: \"Subscribe\",\n\t\t\t\t\tFields: graphql.Fields{\n\t\t\t\t\t\t\"onEvent\": &graphql.Field{\n\t\t\t\t\t\t\tType: graphql.Boolean,\n\t\t\t\t\t\t\tResolve: func(parent interface{}, args interface{}) (interface{}, error) {\n\t\t\t\t\t\t\t\t// Gestion des abonnements en temps réel\n\t\t\t\t\t\t\t\treturn true, nil\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t),\n\t\t},\n\t)\n\n\t// Définition du gestionnaire GraphQL\n\th := handler.New(&handler.Config{\n\t\tSchema: &graphql.Schema{\n\t\t\tSchema: schema,\n\t\t},\n\t\tParseParams: func(params graphql.Params) (context.Context, error) {\n\t\t\treturn context.WithValue(context.Background(), \"params\", params)\n\t\t},\n\t\tValidateFunc: func(params graphql.Params) error {\n\t\t\treturn nil\n\t\t},\n\t\t// GraphQL subscriptions\n\t\tSubscribeFunc:         handler.Subscription(schema),\n\t\tKeepAlive:             10,\n\t\tEnableGraphQLAuth:     true,\n\t\tEnablePlayground:       true,\n\t\tEnableGraphiQL:         true,\n\t\tEnableAutoSchema:       true,\n\t\tGqlerrors:              gqlerrors.FormatError,\n\t\tDisableIntrospection:   true,\n\t\tDisableExecuteAsync:    false,\n\t\tPGConnectionParams:     \"user=myuserepass=monpass#db=mydatabase host=localhost port=5432\",\n\t})\n\t// Configuration gRPC\n\tgunicornConfig := &config{Server: &gunicorn.Server{\n\t\tMaxConnections: 10,\n\t\tEnableCompression: true,\n\t}}\n\t// Initialisation du serveur\n\tlogger.Fatal(http.ListenAndServe(\":3000\", handlers.CORS(handlers.AllowedOrigins([]string{\"http://localhost:3000\"}))(&http.Handler{ServeFunc: h.ServeHTTP})))\n}\n\ntype Config struct {\n\tPort string `yaml:\"port\"`\n}\n", "bugs_introduits": ["missing_import"], "timestamp": 1767006900.6539505}