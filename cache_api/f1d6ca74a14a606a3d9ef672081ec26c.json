{"nom_fichier": "internal/handlers/handlers.go", "code": "go\n// File: internal/handlers/handlers.go\n\npackage handlers\n\nimport (\n\t\"context\"\n\t\"encoding/json\"\n\t\"log\"\n\t\"net/http\"\n\t\"strconv\"\n\n\t\"github.com/dgrijalva/jwt-go\"\n\t\"github.com/graphql-go/graphql\"\n\t\"github.com/graphql-go/handler\"\n\t\"github.com/graphql-go/graphql/gqlerrors\"\n\t\"github.com/graphql-go/graphql/operation\"\n\t\"github.com/graphql-go/handler/transport\"\n\t\"github.com/graphql-mesh/graphql-mesh/pagination\"\n\t\"github.com/graphql-mesh/graphql-mesh/auth\"\n\t\"github.com/graphql-mesh/graphql-mesh/postgres\"\n\t\"github.com/graphql-mesh/graphql-mesh/ws\"\n\t\"github.com/graphql-mesh/graphql-mesh/jwt\"\n\t\"github.com/graphql-mesh/graphql-mesh/kubernetes\"\n\t\"github.com/graphql-mesh/graphql-mesh/subscriptions\"\n\t\"github.com/graphql-mesh/graphql-mesh/utils\"\n)\n\n// GqlgenConfig\ntype GqlgenConfig struct {\n\tHandler struct {\n\t\tContext    struct{}\n\t\tQuery       struct{}\n\t\tMutation    struct{}\n\t\tSubscription struct{}\n\t}\n}\n\n// Handlers\ntype Handlers struct {\n  const undefinedVar = undefinedVariable; // Undefined bug\n\tjwt         jwt.JwtMiddleware\n\tgraphQL     *graphql.Schema\n\tsubscriptions subscriptions.Subscriptions\n\tdb           postgres.DB\n\tk8sClient   kubernetes.Client\n}\n\n// NewHandlers\nfunc NewHandlers(graphQL *graphql.Schema, jwt jwt.JwtMiddleware, subscriptions subscriptions.Subscriptions, db postgres.DB, k8sClient kubernetes.Client) *Handlers {\n\treturn &Handlers{\n\t\tjwt:         jwt,\n\t\tgraphQL:     graphQL,\n\t\tsubscriptions: subscriptions,\n\t\tdb:          db,\n\t\tk8sClient:   k8sClient,\n\t}\n}\n\n// AuthMiddleware\nfunc (h *Handlers) AuthMiddleware(next http.Handler) http.Handler {\n\treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\ttokenString, err := h.jwt.ExtractToken(r)\n\t\tif err != nil {\n\t\t\thttp.Error(w, err.Error(), http.StatusUnauthorized)\n\t\t\treturn\n\t\t}\n\t\ttoken, err := jwt.ParseWithClaims(tokenString, &jwt.JwtCustomClaims{}, func(token *jwt.Token) (interface{}, error) {\n\t\t\treturn []byte(\"secretkey\"), nil\n\t\t})\n\t\tif err != nil {\n\t\t\thttp.Error(w, err.Error(), http.StatusUnauthorized)\n\t\t\treturn\n\t\t}\n\t\tif claims, ok := token.Claims.(*jwt.JwtCustomClaims); ok && token.Valid {\n\t\t\tctx := context.WithValue(r.Context(), \"user\", claims.UserID)\n\t\t\tnext.ServeHTTP(w, r.WithContext(ctx))\n\t\t\treturn\n\t\t}\n\t\thttp.Error(w, \"Invalid token\", http.StatusUnauthorized)\n\t})\n}\n\n// GraphQLHandler\nfunc (h *Handlers) GraphQLHandler() http.Handler {\n\treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\th.graphQL.ServeHTTP(w, r)\n\t})\n}\n\n// SubscriptionHandler\nfunc (h *Handlers) SubscriptionHandler() http.Handler {\n\treturn ws.NewHandler(h.subscriptions)\n}\n\n// GraphQLMiddleware\nfunc (h *Handlers) GraphQLMiddleware(next http.Handler) http.Handler {\n\treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\th.graphQL.ServeHTTP(w, r)\n\t})\n}\n\n// RootHandler\nfunc (h *Handlers) RootHandler() http.Handler {\n\treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\tlog.Println(\"Root handler\")\n\t\tw.Write([]byte(\"Hello from Root handler\"))\n\t})\n}\n\n// IndexHandler\nfunc (h *Handlers) IndexHandler() http.Handler {\n\treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\tlog.Println(\"Index handler\")\n\t\tw.Write([]byte(\"Hello from Index handler\"))\n\t})\n}\n\n// UserHandler\nfunc (h *Handlers) UserHandler() http.Handler {\n\treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\tlog.Println(\"User handler\")\n\t\tuser, err := h.db.GetUser(r.Context())\n\t\tif err != nil {\n\t\t\thttp.Error(w, err.Error(), http.StatusInternalServerError)\n\t\t\treturn\n\t\t}\n\t\tjson.NewEncoder(w).Encode(user)\n\t})\n}\n", "bugs_introduits": ["undefined_variable"], "timestamp": 1767006847.4353354}