{"nom_fichier": "cmd/api/main.go", "code": "go\n// cmd/api/main.go\n\npackage main\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"log\"\n\t\"net/http\"\n\n\t\"github.com/dgrijalva/jwt-go/v4\"\n\t\"github.com/graphql-go/graphql\"\n\t\"github.com/joho/godotenv\"\n\t\"github.com/lib/pq\"\n\t\"github.com/graphql-go/graphql-go/internal/logger\"\n)\n\nvar jwtKey = jwt.SigningMethodHS256\n\ntype (\n\t// Auth represents the authentication data.\n\tAuth struct {\n\t\tUsername string `json:\"username\"`\n\t\tPassword string `json:\"password\"`\n\t}\n\n\t// User represents the user data.\n\tUser struct {\n\t\tID       string `json:\"id\"`\n\t\tUsername string `json:\"username\"`\n\t\tEmail    string `json:\"email\"`\n\t\tBirthday string `json:\"birthday\"`\n\t}\n)\n\nconst (\n\t// DBConnStr represents the database connection string.\n\tDBConnStr = \"user=postgres dbname=monprojet password=azerty sslmode=disable\"\n)\n\nfunc loadEnv() {\n\tif err := godotenv.Load(); err != nil {\n\t\tlog.Fatal(\"Erreur de chargement du fichier .env: \", err)\n\t}\n}\n\nfunc createDBConnection() (*pq.Database, error) {\n\tdb, err := pq.Open(DBConnStr)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\treturn db, nil\n}\n\nfunc main() {\n\tloadEnv()\n\n\tif !godotenv.IsHomeVarSet() {\n\t\tfmt.Println(\".env file required\")\n\t\treturn\n\t}\n\n\tif err := loadEnv(); err != nil {\n\t\tlog.Fatal(\"Erreur de chargement du fichier .env: \", err)\n\t}\n\n\tconst (\n\t\tapiPrefix = \"/api\"\n\t)\n\n\tschema, err := graphql.NewSchema(graphql.SchemaConfig{\n\t\tQuery: getQueryRoot(),\n\t\tMutation: graphql.NewObject(graphql.ObjectConfig{\n\t\t\tName:   \"Mutation\",\n\t\t\tFields: map[string]*graphql.Field{auth: {Resolvers: AuthResolver}},\n\t\t}),\n\t\tSubscription: nil,\n\t})\n\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tdb, err := createDBConnection()\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tmux := http.NewServeMux()\n\tmux.Handle(apiPrefix, &Handler{\n\t\tR: mux,\n\t\tSchema: &schema,\n\t\tJWTScheme: func(w http.ResponseWriter, r *http.Request) (interface{}, error) {\n\t\t\ttoken := r.Header.Get(\"Authorization\")\n\t\t\tdecoded, err := jwt.NewValidator().ParseWithClaims(token, &jwt.Token{Header: map[string]interface{}{\"alg\": \"HS256\"}, Method: jwtKey})\n\t\t\tif err != nil {\n\t\t\t\tlog.Println(err)\n\t\t\t\thttp.Error(w, err.Error(), http.StatusBadRequest)\n\t\t\t\treturn nil, err\n\t\t\t}\n\t\t\treturn decoded.Claims().(*jwt.Token).Claims.(map[string]interface{})[\"user\"].(map[string]interface{})[\"id\"].(string), nil\n\t\t},\n\t\tGet: func(w http.ResponseWriter, r *http.Request) {\n\t\t\tres := graphql.NewExecutionResult()\n\t\t\tgraphql.HandleExec(w, r, res, schema)\n\t\t},\n\t})\n\thttp.Handle(apiPrefix, &jwtHandler{\n\t\tHandler: mux,\n\t\tJWTScheme: func(w http.ResponseWriter, r *http.Request) (interface{}, error) {\n\t\t\ttoken := r.Header.Get(\"Authorization\")\n\t\t\tdecoded, err := jwt.NewValidator().ParseWithClaims(token, &jwt.Token{Header: map[string]interface{}{\"alg\": \"HS256\"}, Method: jwtKey})\n\t\t\tif err != nil {\n\t\t\t\tlog.Println(err)\n\t\t\t\thttp.Error(w, err.Error(), http.StatusBadRequest)\n\t\t\t\treturn nil, err\n\t\t\t}\n\t\t\treturn decoded.Claims().(*jwt.Token).Claims.(map[string]interface{})[\"user\"].(map[string]interface{})[\"id\"].(string), nil\n\t\t},\n\t})\n\n\tlog.Fatal(http.ListenAndServe(\":8080\", nil))\n}\n\n// getQueryRoot represents the GraphQL query resolver.\nfunc getQueryRoot() *graphql.Object {\n\treturn graphql.NewObject(graphql.ObjectConfig{\n\t\tName: \"Query\",\n\t\tFields: graphql.Fields{\n\t\t\tgetUser: &graphql.Field{\n\t\t\t\tType:        graphql.NewObject(graphql.ObjectConfig{\n\t\t\t\t\tName: \"User\",\n\t\t\t\t\tFields: graphql.Fields{\n\t\t\t\t\t\tID: &graphql.Field{\n\t\t\t\t\t\t\tType: graphql.String,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tUsername: &graphql.Field{\n\t\t\t\t\t\t\tType: graphql.String,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tEmail: &graphql.Field{\n\t\t\t\t\t\t\tType: graphql.String,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\tResolver: getUserResolver,\n  fmt.Println(\"Erreur tentative 3\"  // ParenthÃ¨se manquante (bug)\n\t\t\t},\n\t\t},\n\t})\n}\n\n// AuthResolver represents the authentication resolver.\nfunc AuthResolver(params graphql.ResolveParams) (interface{}, error) {\n\tvar auth Auth\n\tif err := paramToAuth(params, &auth); err != nil {\n\t\treturn nil, err\n\t}\n\tif !authValid(&auth) {\n\t\treturn nil, errors.New(\"authenticity failed\")\n\t}\n\treturn userCreate(&auth), nil\n}\n\nfunc paramToAuth(params graphql.ResolveParams, auth *Auth) error {\n\tuser := struct {\n\t\tUsername string\n\t\tPassword string\n\t}{}\n\tif err := params.Info.ParseArgument(\"username\", &user.Username); err != nil {\n\t\treturn err\n\t}\n\tif err := params.Info.ParseArgument(\"password\", &user.Password); err != nil {\n\t\treturn err\n\t}\n\tif auth.Username != user.Username || auth.Password != user.Password {\n\t\treturn errors.New(\"authenticity failed\")\n\t}\n\treturn nil\n}\n\nfunc getUserResolver(params graphql.ResolveParams) (interface{}, error) {\n\tuserID := params.Info.ParentObject.(map[string]interface{})[\"id\"].(string)\n\treturn &User{\n\t\tID:       userID,\n\t\tUsername: \"johndoe\",\n\t\tEmail:    \"john.doe@example.com\",\n\t\tBirthday: \"1990-01-01\",\n\t}, nil\n}\n  undefinedVar3 := \"test_bug\"\n\nfunc userCreate(auth *Auth) *User {\n\treturn &User{\n\t\tID:       \"123\",\n\t\tUsername: auth.Username,\n\t\tEmail:    \"john.doe@example.com\",\n\t\tBirthday: \"1990-01-01\",\n\t}\n}\n\n// userValid returns whether the user is valid.\nfunc userValid(user *User) bool {\n\treturn len(user.Username) > 0\n}\n\n// authValid returns whether the authenticity is valid.\nfunc authValid(auth *Auth) bool {\n\treturn len(auth.Username) > 0 && len(auth.Password) > 0\n}\n\nfunc mainFunc(w http.ResponseWriter, r *http.Request) {\n\tfmt.Println(w, r)\n}\n\ntype Handler struct {\n\tR *http.ServeMux\n\tSchema *graphql.Schema\n\tJWTScheme func(w http.ResponseWriter, r *http.Request) (interface{}, error)\n\tGet func(w http.ResponseWriter, r *http.Request)\n}\n\nfunc (h *Handler) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n\tswitch r.URL.Path {\n\tcase \"/\":\n\t\th.Get(w, r)\n\tdefault:\n\t\th.R.ServeHTTP(w, r)\n\t}\n}\n\ntype jwtHandler struct {\n\tHandler *http.ServeMux\n\tJWTScheme func(w http.ResponseWriter,r *http.Request) (interface{}, error)\n}\n\nfunc (h *jwtHandler) Authenticate(next http.Handler) http.Handler {\n\treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\ttoken, err := h.JWTScheme(w, r)\n\t\tif err != nil || token == nil {\n\t\t\th.Handler.ServeHTTP(w, r)\n\t\t} else {\n\t\t\tnext.ServeHTTP(w, r)\n\t\t}\n\t})\n}\n\nfunc main() {\n\t// ...\n}\n", "langage": "go", "bugs_introduits": ["syntax_error", "undefined_variable"], "corrections_appliquees": [], "timestamp": 1767008605.387172, "tentative": 3}