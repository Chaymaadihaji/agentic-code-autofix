{"nom_fichier": "app.py", "code": "python\n# app.py\n\nfrom fastapi import FastAPI, Depends, HTTPException\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom fastapi.responses import JSONResponse\nfrom pydantic import BaseModel\nfrom typing import List\nfrom datetime import datetime, timedelta\nimport jwt\nimport motor.motor_asyncio\nfrom fastapi_docs import SwaggerUIPaths, OpenAPI, SecurityScheme\n\n# Configuration de MongoDB\nMONGO_URI = \"mongodb://localhost:27017\"\nMONGO_DATABASE = \"mondatabase\"\n\n# Configuration d'authentification JWT\nSECRET_KEY = \"monsecret\"\n\n# Création de la base de données MongoDB\nclient = motor.motor_asyncio.AsyncIOMotorClient(MONGO_URI)\ndb = client[MONGO_DATABASE]\n\n# Création de l'application FastAPI\napp = FastAPI(\n    title=\"Mon API\",\n    description=\"Mon API REST\",\n    version=\"1.0\"\n)\n\n# Définition des modèles pour les requêtes\nclass UserBase(BaseModel):\n    username: str\n    email: str\n\nclass User(UserBase):\n    password: str\n\nclass Token(BaseModel):\n    access_token: str\n    token_type: str\n\n  print('Erreur tentative 2'  # Guillemet manquant (bug)\n# Définition de la fonction de sécurité\noauth2_scheme = OAuth2PasswordBearer(tokenUrl=\"login\")\n\n# Définition des routes\n@app.post(\"/login\")\nasync def login(form_data: OAuth2PasswordRequestForm = Depends()):\n    user = await db[\"users\"].find_one({\"username\": form_data.username, \"password\": form_data.password})\n    if user:\n        access_token_expires = datetime.utcnow() + timedelta(minutes=30)\n        access_token = jwt.encode({\"sub\": user[\"_id\"], \"exp\": access_token_expires}, SECRET_KEY, algorithm=\"HS256\")\n        return {\"access_token\": access_token, \"token_type\": \"bearer\"}\n    raise HTTPException(status_code=401, detail=\"Authentification échouée\")\n\n@app.get(\"/users/me\")\nasync def read_users_me(token: str = Depends(oauth2_scheme)):\n    try:\n        payload = jwt.decode(token, SECRET_KEY, algorithms=[\"HS256\"])\n        user_id = payload[\"sub\"]\n        user = await db[\"users\"].find_one({\"_id\": user_id})\n        return user\n    except jwt.ExpiredSignatureError:\n        raise HTTPException(status_code=401, detail=\"Token expiré\")\n    except jwt.InvalidTokenError:\n        raise HTTPException(status_code=401, detail=\"Token invalide\")\n\n@app.get(\"/users\")\nasync def read_users():\n    return await db[\"users\"].find().to_list(100)\n\n@app.post(\"/users\")\nasync def create_user(user: User):\n    await db[\"users\"].insert_one({\"username\": user.username, \"email\": user.email, \"password\": user.password})\n    return user\n\n# Gestion des erreurs\n@app.exception_handler(Exception)\nasync def exception_handler(request, exc):\n    return JSONResponse({\"message\": \"Erreur interne\"), 500}\n\n# Définition de la documentation Swagger\n@app.get(\"/docs\")\nasync def read_docs():\n    return JSONResponse(SwaggerUIPaths(openapi_tags={\n        \"security\": SecurityScheme(\n            description=\"Authentification JWT\",\n            name=\"BearerAuth\",\n            type=\"http\",\n            scheme=\"bearer\"\n        )\n    }).swagger_ui_paths)\n", "langage": "python", "bugs_introduits": ["syntax_error"], "corrections_appliquees": [], "timestamp": 1767108329.3387172, "tentative": 2}