{"nom_fichier": "models.py", "code": "# models.py\n\nfrom flask import Flask, render_template, request, session, redirect, url_for\nfrom flask_sqlalchemy import SQLAlchemy\nfrom flask_login import LoginManager, UserMixin, login_required, login_user, logout_user, current_user\nfrom flask_wtf import FlaskForm\nfrom wtforms import StringField, PasswordField, SubmitField\nfrom wtforms.validators import DataRequired, Email, EqualTo\nfrom flask_bcrypt import Bcrypt\nfrom flask_smorest import Blueprint, abort\nfrom flask import jsonify\nfrom itsdangerous import URLSafeTimedSerializer\nfrom twilio.rest import Client\nimport requests\nimport json\nfrom datetime import datetime, timedelta\n\napp = Flask(__name__)\napp.config['SECRET_KEY'] = 'secret_key'\napp.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///database.db'\ndb = SQLAlchemy(app)\nbcrypt = Bcrypt(app)\nlogin_manager = LoginManager(app)\nlogin_manager.login_view = 'login'\n\nclass User(UserMixin, db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    username = db.Column(db.String(20), unique=True, nullable=False)\n    email = db.Column(db.String(120), unique=True, nullable=False)\n    password = db.Column(db.String(120), nullable=False)\n    history = db.relationship('History', backref='user', lazy=True)\n\nclass History(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)\n    date = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)\n\nclass RegistrationForm(FlaskForm):\n    username = StringField('Username', validators=[DataRequired()])\n    email = StringField('Email', validators=[DataRequired(), Email()])\n    password = PasswordField('Password', validators=[DataRequired()])\n    confirm_password = PasswordField('Confirm Password', validators=[DataRequired(), EqualTo('password')])\n    submit = SubmitField('Sign Up')\n\nclass LoginForm(FlaskForm):\n    email = StringField('Email', validators=[DataRequired(), Email()])\n    password = PasswordField('Password', validators=[DataRequired()])\n    submit = SubmitField('Login')\n\nclass ResetForm(FlaskForm):\n    email = StringField('Email', validators=[DataRequired(), Email()])\n    submit = SubmitField('Reset Password')\n\n@login_manager.user_loader\ndef load_user(user_id):\n    return User.query.get(int(user_id))\n\n@app.route('/')\ndef index():\n    return render_template('index.html')\n\n@app.route('/register', methods=['GET', 'POST'])\ndef register():\n    form = RegistrationForm()\n    if form.validate_on_submit():\n        hashed_password = bcrypt.generate_password_hash(form.password.data).decode('utf-8')\n        user = User(username=form.username.data, email=form.email.data, password=hashed_password)\n        db.session.add(user)\n        db.session.commit()\n        return redirect(url_for('login'))\n    return render_template('register.html', form=form)\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    form = LoginForm()\n    if form.validate_on_submit():\n        user = User.query.filter_by(email=form.email.data).first()\n        if user and bcrypt.check_password_hash(user.password, form.password.data):\n            login_user(user)\n            return redirect(url_for('index'))\n    return render_template('login.html', form=form)\n\n@app.route('/logout')\ndef logout():\n    logout_user()\n    return redirect(url_for('index'))\n\n@app.route('/reset', methods=['GET', 'POST'])\ndef reset():\n    form = ResetForm()\n    if form.validate_on_submit():\n        user = User.query.filter_by(email=form.email.data).first()\n        if user:\n            token = URLSafeTimedSerializer(app.config['SECRET_KEY']).dumps(user.id, salt='reset-salt')\n            client = Client('your_account_sid', 'your_auth_token')\n            message = client.messages.create(\n                from_='your_twilio_number',\n                body=f'Reset link: http://localhost:5000/reset/{token}',\n                to='recipient_number'\n            )\n            return redirect(url_for('index'))\n    return render_template('reset.html', form=form)\n\n@app.route('/reset/<token>')\ndef reset_token(token):\n    serializer = URLSafeTimedSerializer(app.config['SECRET_KEY'])\n    try:\n        user_id = serializer.loads(token, salt='reset-salt', max_age=1800)\n        user = User.query.get(user_id)\n        if user:\n            return render_template('reset_password.html', user=user)\n    except:\n        abort(404)\n\n@app.route('/reset_password/<user_id>', methods=['POST'])\ndef reset_password(user_id):\n    user = User.query.get(user_id)\n    if user:\n        new_password = request.form['new_password']\n        hashed_password = bcrypt.generate_password_hash(new_password).decode('utf-8')\n        user.password = hashed_password\n        db.session.commit()\n        return redirect(url_for('login'))\n\n@app.route('/history')\n@login_required\ndef history():\n    history = History.query.filter_by(user_id=current_user.id).all()\n    return render_template('history.html', history=history)\n\nif __name__ == \"__main__\":\n    app.run(debug=True)\n", "timestamp": 1766865252.0114536}