{"nom_fichier": "main.py", "code": "# main.py\n\nfrom flask import Flask, render_template, request, redirect, url_for, flash\nfrom flask_login import LoginManager, UserMixin, login_required, login_user, logout_user, current_user\nfrom flask_wtf import FlaskForm\nfrom wtforms import StringField, PasswordField, SubmitField\nfrom wtforms.validators import DataRequired, Email, EqualTo\nfrom flask_sqlalchemy import SQLAlchemy\nfrom flask_bcrypt import Bcrypt\nimport json\nfrom flask import jsonify\nfrom flask import make_response\nimport smtplib\nfrom email.message import EmailMessage\nfrom random import randint\n\napp = Flask(__name__)\napp.config['SECRET_KEY'] = 'secret_key'\napp.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///database.db'\ndb = SQLAlchemy(app)\nbcrypt = Bcrypt(app)\nlogin_manager = LoginManager(app)\n\nclass User(UserMixin, db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    email = db.Column(db.String(100), unique=True, nullable=False)\n    password = db.Column(db.String(100), nullable=False)\n    connections = db.relationship('Connection', backref='user', lazy=True)\n\nclass Connection(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)\n    ip_address = db.Column(db.String(100), nullable=False)\n    timestamp = db.Column(db.DateTime, nullable=False)\n\nclass RegisterForm(FlaskForm):\n    email = StringField('Email', validators=[DataRequired(), Email()])\n    password = PasswordField('Password', validators=[DataRequired()])\n    confirm_password = PasswordField('Confirm Password', validators=[DataRequired(), EqualTo('password')])\n    submit = SubmitField('Register')\n\nclass LoginForm(FlaskForm):\n    email = StringField('Email', validators=[DataRequired(), Email()])\n    password = PasswordField('Password', validators=[DataRequired()])\n    submit = SubmitField('Login')\n\nclass ForgotPasswordForm(FlaskForm):\n    email = StringField('Email', validators=[DataRequired(), Email()])\n    submit = SubmitField('Send')\n\nclass ResetPasswordForm(FlaskForm):\n    password = PasswordField('Password', validators=[DataRequired()])\n    confirm_password = PasswordField('Confirm Password', validators=[DataRequired(), EqualTo('password')])\n    submit = SubmitField('Reset')\n\n@login_manager.user_loader\ndef load_user(user_id):\n    return User.query.get(int(user_id))\n\n@app.route('/')\ndef index():\n    return render_template('index.html')\n\n@app.route('/register', methods=['GET', 'POST'])\ndef register():\n    form = RegisterForm()\n    if form.validate_on_submit():\n        hashed_password = bcrypt.generate_password_hash(form.password.data).decode('utf-8')\n        user = User(email=form.email.data, password=hashed_password)\n        db.session.add(user)\n        db.session.commit()\n        flash('Account created successfully', 'success')\n        return redirect(url_for('login'))\n    return render_template('register.html', form=form)\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    form = LoginForm()\n    if form.validate_on_submit():\n        user = User.query.filter_by(email=form.email.data).first()\n        if user and bcrypt.check_password_hash(user.password, form.password.data):\n            login_user(user)\n            flash('Logged in successfully', 'success')\n            return redirect(url_for('dashboard'))\n        else:\n            flash('Invalid email or password', 'danger')\n    return render_template('login.html', form=form)\n\n@app.route('/forgot_password', methods=['GET', 'POST'])\ndef forgot_password():\n    form = ForgotPasswordForm()\n    if form.validate_on_submit():\n        user = User.query.filter_by(email=form.email.data).first()\n        if user:\n            code = randint(100000, 999999)\n            msg = EmailMessage()\n            msg.set_content(f'Your reset code is: {code}')\n            msg['Subject'] = 'Reset code'\n            msg['From'] = 'your_email@gmail.com'\n            msg['To'] = form.email.data\n            with smtplib.SMTP_SSL('smtp.gmail.com', 465) as smtp:\n                smtp.login('your_email@gmail.com', 'your_password')\n                smtp.send_message(msg)\n            flash('Reset code sent successfully', 'success')\n            return redirect(url_for('reset_password', code=code))\n    return render_template('forgot_password.html', form=form)\n\n@app.route('/reset_password/<int:code>', methods=['GET', 'POST'])\ndef reset_password(code):\n    form = ResetPasswordForm()\n    if form.validate_on_submit():\n        user = User.query.filter_by(email=request.args.get('email')).first()\n        if user:\n            hashed_password = bcrypt.generate_password_hash(form.password.data).decode('utf-8')\n            user.password = hashed_password\n            db.session.commit()\n            flash('Password reset successfully', 'success')\n            return redirect(url_for('login'))\n    return render_template('reset_password.html', form=form)\n\n@app.route('/dashboard')\n@login_required\ndef dashboard():\n    connections = Connection.query.all()\n    return render_template('dashboard.html', connections=connections)\n\n@app.route('/logout')\n@login_required\ndef logout():\n    logout_user()\n    flash('Logged out successfully', 'success')\n    return redirect(url_for('index'))\n\n@app.errorhandler(404)\ndef page_not_found(e):\n    return render_template('404.html'), 404\n\nif __name__ == \"__main__\":\n    app.run(debug=True)\n", "timestamp": 1766865280.4310997}