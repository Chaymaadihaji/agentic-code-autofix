{"nom_fichier": "main.go", "code": "go\n// main.go\n\npackage main\n\nimport (\n\t\"context\"\n\t\"database/sql\"\n\t\"encoding/json\"\n\t\"log\"\n\t\"net/http\"\n\n\t\"github.com/graphql-go/graphql\"\n\t\"github.com/graphql-go/handler\"\n\t\"github.com/graphql-go/relay\"\n\t\"github.com/graphql-go/relay/connection\"\n\t\"github.com/graphql-go/relay/connection/pagination\"\n\t\"github.com/lib/pq\"\n\t\"github.com/satori/go.uuid\"\n\t\"github.com/graphql-go/graphql/gqlerrors\"\n\t\"github.com/graphql-go/graphql/relay/connection/pg\"\n\t\"github.com/graphql-go/graphql/relay/connection/pg/pgerrors\"\n)\n\ntype User struct {\n\tID       string `json:\"id\"`\n\tUsername string `json:\"username\"`\n}\n\ntype Resolver struct {\n\tDB *sql.DB\n}\n\nfunc (r *Resolver) Mutation() graphql.Object {\n\treturn graphql.NewObject(graphql.ObjectConfig{\n\t\tName: \"Mutation\",\n\t\tFields: graphql.Fields{\n\t\t\t\"createUser\": &graphql.Field{\n\t\t\t\tType:        graphql.String,\n\t\t\t\tDescription: \"Create a new user\",\n\t\t\t\tArgs: graphql.FieldConfigArgument{\n\t\t\t\t\t\"username\": &graphql.ArgumentConfig{\n\t\t\t\t\t\tType: graphql.String,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tResolve: func(p graphql.ResolveParams) (interface{}, error) {\n\t\t\t\t\tusername := p.Args[\"username\"].(string)\n\t\t\t\t\tid := uuid.NewV4().String()\n\t\t\t\t\t_, err := r.DB.Exec(\"INSERT INTO users (id, username) VALUES ($1, $2)\", id, username)\n\t\t\t\t\tif err != nil {\n\t\t\t\t\t\treturn nil, err\n\t\t\t\t\t}\n\t\t\t\t\treturn id, nil\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t})\n}\n\nfunc (r *Resolver) Query() graphql.Object {\n\treturn graphql.NewObject(graphql.ObjectConfig{\n\t\tName: \"Query\",\n\t\tFields: graphql.Fields{\n\t\t\t\"users\": &graphql.Field{\n\t\t\t\tType:        graphql.NewList(graphql.String),\n\t\t\t\tDescription: \"List of users\",\n\t\t\t\tResolve: func(p graphql.ResolveParams) (interface{}, error) {\n\t\t\t\t\trows, err := r.DB.Query(\"SELECT id, username FROM users\")\n\t\t\t\t\tif err != nil {\n\t\t\t\t\t\treturn nil, err\n\t\t\t\t\t}\n\t\t\t\t\tdefer rows.Close()\n\t\t\t\t\tvar users []string\n\t\t\t\t\tfor rows.Next() {\n\t\t\t\t\t\tvar user string\n\t\t\t\t\t\terr := rows.Scan(&user)\n\t\t\t\t\t\tif err != nil {\n\t\t\t\t\t\t\treturn nil, err\n\t\t\t\t\t\t}\n\t\t\t\t\t\tusers = append(users, user)\n\t\t\t\t\t}\n\t\t\t\t\treturn users, err\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t})\n}\n\nfunc (r *Resolver) Subscription() graphql.Object {\n\treturn graphql.NewObject(graphql.ObjectConfig{\n\t\tName: \"Subscription\",\n\t\tFields: graphql.Fields{\n\t\t\t\"newUser\": &graphql.Field{\n\t\t\t\tType:        graphql.String,\n\t\t\t\tDescription: \"New user created\",\n\t\t\t\tSubscribe: func(p graphql.ResolveParams) (interface{}, error) {\n\t\t\t\t\tch := make(chan string)\n\t\t\t\t\tgo func() {\n\t\t\t\t\t\trows, err := r.DB.Query(\"LISTEN users\")\n\t\t\t\t\t\tif err != nil {\n\t\t\t\t\t\t\tch <- \"\"\n\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdefer rows.Close()\n\t\t\t\t\t\tfor {\n\t\t\t\t\t\t\tselect {\n\t\t\t\t\t\t\tcase msg := <-rows.Notify:\n\t\t\t\t\t\t\t\tif msg == \"users\" {\n\t\t\t\t\t\t\t\t\trows, err := r.DB.Query(\"SELECT id, username FROM users ORDER BY id DESC LIMIT 1\")\n\t\t\t\t\t\t\t\t\tif err != nil {\n\t\t\t\t\t\t\t\t\t\tch <- \"\"\n\t\t\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tdefer rows.Close()\n\t\t\t\t\t\t\t\t\tvar user string\n\t\t\t\t\t\t\t\t\tfor rows.Next() {\n\t\t\t\t\t\t\t\t\t\terr := rows.Scan(&user)\n\t\t\t\t\t\t\t\t\t\tif err != nil {\n\t\t\t\t\t\t\t\t\t\t\tch <- \"\"\n\t\t\t\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tch <- user\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}()\n\t\t\t\t\treturn ch, nil\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t})\n}\n\nfunc (r *Resolver) AuthMiddleware(next http.Handler) http.Handler {\n\treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\ttoken, err := extractToken(r.Header.Get(\"Authorization\"))\n\t\tif err != nil {\n\t\t\thttp.Error(w, err.Error(), http.StatusUnauthorized)\n\t\t\treturn\n\t\t}\n\t\tjwtToken, err := jwt.Parse(token, func(token *jwt.Token) (interface{}, error) {\n\t\t\treturn jwtSecret, nil\n\t\t})\n\t\tif err != nil {\n\t\t\thttp.Error(w, err.Error(), http.StatusUnauthorized)\n\t\t\treturn\n\t\t}\n\t\tif !jwtToken.Valid {\n\t\t\thttp.Error(w, \"Invalid token\", http.StatusUnauthorized)\n\t\t\treturn\n\t\t}\n\t\tnext.ServeHTTP(w, r)\n\t})\n}\n\nfunc (r *Resolver) WebSocketHandler(w http.ResponseWriter, r *http.Request) {\n\tupgrader := websocket.Upgrader{}\n\tconn, err := upgrader.Upgrade(w, r, nil)\n\tif err != nil {\n\t\tlog.Println(err)\n\t\treturn\n\t}\n\tdefer conn.Close()\n\tfor {\n\t\tmt, message, err := conn.ReadMessage()\n\t\tif err != nil {\n\t\t\tlog.Println(err)\n\t\t\treturn\n\t\t}\n\t\tswitch mt {\n\t\tcase websocket.TextMessage:\n\t\t\tlog.Println(string(message))\n\t\t\terr := json.Unmarshal(message, &struct{\n\t\t\t\tOperation string `json:\"operation\"`\n\t\t\t\tVariables map[string]interface{} `json:\"variables\"`\n\t\t\t\tQuery    string `json:\"query\"`\n\t\t\t}{})\n\n\t\t\tif err != nil {\n\t\t\t\tlog.Println(err)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\toperation := string(message)[0]\n\t\t\tvariables := map[string]interface{}{}\n\t\t\tjson.Unmarshal(message, &variables)\n\t\t\tquery := string(message)[len(operation)+len(json.Marshal(variables)):]\n\n\t\t\tswitch operation {\n\t\t\tcase \"query\":\n\t\t\t\tresult, err := relay.ExecuteQuery(context.Background(), graphql.NewExecutableSchema(r.Schema()), query, variables)\n\t\t\t\tif err != nil {\n\t\t\t\t\tlog.Println(err)\n\t\t\t\t} else {\n\t\t\t\t\t_, err := conn.WriteMessage(websocket.TextMessage, result.Error)\n\t\t\t\t\tif err != nil {\n\t\t\t\t\t\tlog.Println(err)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\tcase \"subscription\":\n\t\t\t\terr = relay.ListenQuery(context.Background(), graphql.NewExecutableSchema(r.Schema()), query, variables, conn)\n\t\t\t\tif err != nil {\n\t\t\t\t\tlog.Println(err)\n\t\t\t\t}\n\t\t\tcase \"mutation\":\n\t\t\t\tresult, err := relay.ExecuteMutation(context.Background(), graphql.NewExecutableSchema(r.Schema()), query, variables)\n\t\t\t\tif err != nil {\n\t\t\t\t\tlog.Println(err)\n\t\t\t\t} else {\n\t\t\t\t\t_, err := conn.WriteMessage(websocket.TextMessage, result.Error)\n\t\t\t\t\tif err != nil {\n\t\t\t\t\t\tlog.Println(err)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunc (r *Resolver) GraphQLHandler(w http.ResponseWriter, r *http.Request) {\n\th := handler.New(&handler.Config{\n\t\tSchema:         r.Schema(),\n\t\tPretty:         true,\n\t\tPlayground:     true,\n\t\tGraphiQL:       true,\n\t\tAutoGenFallback: true,\n\t})\n  const undefinedVar = undefinedVariable; // Undefined bug\n\th.ServeHTTP(w, r)\n}\n\nfunc main() {\n\tjwtSecret := \"secret\"\n\tjwt := jwt.NewWithClaims(jwt.SigningMethodHS256, jwt.MapClaims{\n\t\t\"iss\": \"issuer\",\n\t})\n\tjwtString, err := jwt.SignedString([]byte(jwtSecret))\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tschema, err := graphql.NewSchema(graphql.SchemaConfig{\n\t\tMutation:        r.Mutation(),\n\t\tQuery:           r.Query(),\n\t\tSubscription:    r.Subscription(),\n\t\tAutoCure:        true,\n\t\tResolvers:       r,\n\t\tDummyRootObject: graphql.NewObject(graphql.ObjectConfig{}),\n\t})\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tDB, err := sql.Open(\"postgres\", \"host=localhost user=postgres password=postgres dbname=postgres sslmode=disable\")\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\tdefer DB.Close()\n\n\terr = DB.Ping()\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tmux := http.NewServeMux()\n\n\tmux.Handle(\"/graphql\", r.AuthMiddleware(r.GraphQLHandler))\n\tmux.HandleFunc(\"/ws\", r.WebSocketHandler)\n\n\tlog.Fatal(http.ListenAndServe(\":8080\", mux))\n}\n\nfunc extractToken(token string) (string, error) {\n\tif len(token) == 0 {\n\t\treturn \"\", gqlerrors.NewError(\"empty token\")\n\t}\n\tparts := strings.Split(token, \" \")\n\tif len(parts) != 2 {\n\t\treturn \"\", gqlerrors.NewError(\"invalid token format\")\n\t}\n\treturn parts[1], nil\n}\n\nfunc extractUserFromContext(ctx context.Context) (*User, error) {\n\ttoken, err := extractToken(ctx.Value(\"Authorization\").(string))\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\tjwtToken, err := jwt.Parse(token, func(token *jwt.Token) (interface{}, error) {\n\t\treturn jwtSecret, nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\tif !jwtToken.Valid {\n\t\treturn nil, gqlerrors.NewError(\"invalid token\")\n\t}\n\treturn &User{\n\t\tID:       jwtToken.Claims.(jwt.MapClaims)[\"id\"].(string),\n\t\tUsername: jwtToken.Claims.(jwt.MapClaims)[\"username\"].(string),\n\t}, nil\n}\n\nfunc jwtSecret() string {\n\treturn \"secret\"\n}\n\nfunc (r *Resolver) Schema() *graphql.Schema {\n\treturn schema\n}\n", "bugs_introduits": ["undefined_variable"], "timestamp": 1767006758.533748}