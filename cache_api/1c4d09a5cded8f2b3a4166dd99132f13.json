{"nom_fichier": "cmd/api/main.go", "code": "go\n// File: main.go\n\npackage main\n\nimport (\n\t\"context\"\n\t\"log\"\n\t\"os\"\n\t\"os/signal\"\n\n\t\"example/graphql/service\"\n\t\"github.com/google/uuid\"\n\t\"github.com/graphql-go/graphql\"\n\t\"github.com/graphql-go/handler\"\n\t\"github.com/graphql-go/subscriptions\"\n\t\"github.com/pg/pg\"\n\t\"github.com/tidwall/gologger\"\n\t\"github.com/tidwall/sjson\"\n\t\"github.com/valyala/fasthttp\"\n\t\"github.com/urfave/negroni\"\n\t\"github.com/urfave/negroni/logger\"\n\n\t\"golang.org/x/oauth2\"\n)\n\nvar (\n\tgraphqlHandler *handler.GraphQL\n\tsubscriptionHandler *subscriptions.Handler\n)\n\nfunc main() {\n\t// Setup logging\n\tgologger.SetLevel(gologger.INFO)\n\tgologger.SetLogFormat(gologger.LogFormatJSON)\n\n\t// Setup PostgreSQL connection\n\tdb, err := pg.Connect(context.Background(), \"postgresql://user:password@localhost:5432/database\")\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\tdefer db.Close(context.Background())\n\n\t// Setup GraphQL schema\n\tschema := service.NewSchema(db)\n\tgql := graphql.NewHandler(schema)\n\n\t// Setup GraphQL API (HTTP endpoint)\n\th := handler.New(&handler.Config{\n\t\tGraphiQL: true,\n\t GraphiQLRoute: \"/graphiql\",\n\t\tCORS: &handler.Config.CORSOptions{\n\t\t\tAllowedMethods: []string{\"GET\", \"HEAD\", \"POST\", \"OPTIONS\"},\n\t\t\tAllowedOrigins: []string{\"*\"},\n\t\t\tAllowedHeaders: []string{\"Content-Type\", \"Authorization\"},\n\t\t},\n\t\tPlayground: true,\n\t\tPlaygroundRoute: \"/playground\",\n\t\tEnabledGraphQLRoutes: []string{\"/graphql\", \"/graphiql\", \"/playground\"},\n\t\tAutoCropLongLines: true,\n\t})\n\n\t// Setup GraphQL subscriptions (WebSocket endpoint)\n\tsubhandler := subscriptions.NewHandler(schema)\n\tss := &fasthttp.Server{\n\t\tHandler: subhandler,\n\t\tDisableKeepalive: true,\n\t\tReadTimeout: 60,\n\t\tWriteTimeout: 60,\n\t\tMaxConns: 100,\n\t}\n\n\t// Setup authentication middleware\n\tjwterror := func(wr http.ResponseWriter, r *http.Request, next http.HandlerFunc) {\n\t\ttoken := r.Header.Get(\"Authorization\")\n\t\tif token == \"\" {\n\t\t\thttp.Error(wr, \"Unauthorized\", http.StatusUnauthorized)\n\t\t\treturn\n\t\t}\n\t\tif token != \"my_secret_token\" { // Replace with a actual token checking logic\n\t\t\thttp.Error(wr, \"Unauthorized\", http.StatusUnauthorized)\n\t\t\treturn\n\t\t}\n\t\tnext(wr, r)\n\t}\n\n\t// Setup JWT middleware\n\tjwt := oauth2.NewClient(context.Background(), func(ctx context.Context, token *oauth2.Token) (interface{}, error) {\n\t\treturn \"my_secret_token\", nil\n\t})\n\n\t// Setup Negroni middleware\n\tn := negroni.Classic()\n\tn.Use(jwterror)\n\tn.Use(negroni.HandlerFunc(jwt.GetConfig))\n\tn.UseHandler(h)\n\n\t// Setup WebSocket handler\n\twshandler := func(ctx context.Context, w http.ResponseWriter, r *http.Request) {\n\t\tss.ServeHTTP(w, r)\n\t}\n\n\t// Setup HTTP server\n\ths := &fasthttp.Server{\n\t\tHandler: http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\t\tif r.URL.Path == \"/graphql\" {\n\t\t\t\tjwterror(w, r, func(w http.ResponseWriter, r *http.Request) {\n\t\t\t\t\th.ServeHTTP(w, r)\n\t\t\t\t})\n\t\t\t} else if r.URL.Path == \"/subscriptions\" {\n\t\t\t\twshandler(w, r)\n\t\t\t} else {\n\t\t\t\tw.Header.Set(\"Content-Type\", \"application/json\")\n\t\t\t\tw.Write([]byte(`{\"message\": \"Hello, world!\"}`))\n\t\t\t}\n\t\t}),\n\t}\n\n\t// Listen for signals\n\tsigs := make(chan os.Signal, 1)\n\tsignal.Notify(sigs, os.Interrupt, os.Kill)\n\tgo func() {\n\t\t<-sigs\n\t\ths.Close()\n\t\tdb.Close(context.Background())\n\t\tos.Exit(0)\n\t}()\n\n\t// Run the HTTP server\n\tlog.Println(\"Listening on port 8080...\")\n\ths.ListenAndServe(\":8080\")\n}\n", "bugs_introduits": [], "timestamp": 1767006778.1498108}