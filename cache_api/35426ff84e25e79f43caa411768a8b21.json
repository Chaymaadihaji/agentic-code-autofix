{"nom_fichier": "app.py", "code": "import os\nimport json\nfrom flask import Flask, request, jsonify\nfrom flask_sqlalchemy import SQLAlchemy\nfrom flask_jwt_extended import JWTManager, jwt_required, create_access_token\nfrom werkzeug.security import generate_password_hash, check_password_hash\nfrom fpdf import FPDF\nimport pytz\nfrom datetime import datetime\n\napp = Flask(__name__)\napp.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///bibliotheque.db'\napp.config['JWT_SECRET_KEY'] = 'secret-key'\ndb = SQLAlchemy(app)\njwt = JWTManager(app)\n\nclass Livre(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    titre = db.Column(db.String(100), nullable=False)\n    auteur = db.Column(db.String(100), nullable=False)\n    editeur = db.Column(db.String(100), nullable=False)\n    stock = db.Column(db.Integer, nullable=False)\n\nclass Membre(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    nom = db.Column(db.String(100), nullable=False)\n    prenom = db.Column(db.String(100), nullable=False)\n    email = db.Column(db.String(100), nullable=False)\n    mot_de_passe = db.Column(db.String(100), nullable=False)\n\nclass Emprunt(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    livre_id = db.Column(db.Integer, db.ForeignKey('livre.id'), nullable=False)\n    membre_id = db.Column(db.Integer, db.ForeignKey('membre.id'), nullable=False)\n    date_emprunt = db.Column(db.DateTime, nullable=False)\n    date_retour = db.Column(db.DateTime, nullable=False)\n\n@app.route('/login', methods=['POST'])\ndef login():\n    email = request.json['email']\n    mot_de_passe = request.json['mot_de_passe']\n    membre = Membre.query.filter_by(email=email).first()\n    if membre and check_password_hash(mot_de_passe, membre.mot_de_passe):\n        access_token = create_access_token(identity=membre.id)\n        return jsonify(access_token=access_token)\n    return jsonify({'error': 'Mauvais email ou mot de passe'}), 401\n\n@app.route('/livres', methods=['GET'])\n@jwt_required\ndef get_livres():\n    livres = Livre.query.all()\n    return jsonify([{'id': livre.id, 'titre': livre.titre, 'auteur': livre.auteur, 'editeur': livre.editeur, 'stock': livre.stock} for livre in livres])\n\n@app.route('/livres', methods=['POST'])\n@jwt_required\ndef create_livre():\n    titre = request.json['titre']\n    auteur = request.json['auteur']\n    editeur = request.json['editeur']\n    stock = request.json['stock']\n    livre = Livre(titre=titre, auteur=auteur, editeur=editeur, stock=stock)\n    db.session.add(livre)\n    db.session.commit()\n    return jsonify({'id': livre.id, 'titre': livre.titre, 'auteur': livre.auteur, 'editeur': livre.editeur, 'stock': livre.stock})\n\n@app.route('/livres/<int:livre_id>', methods=['PUT'])\n@jwt_required\ndef update_livre(livre_id):\n    livre = Livre.query.get(livre_id)\n    titre = request.json['titre']\n    auteur = request.json['auteur']\n    editeur = request.json['editeur']\n    stock = request.json['stock']\n    livre.titre = titre\n    livre.auteur = auteur\n    livre.editeur = editeur\n    livre.stock = stock\n    db.session.commit()\n    return jsonify({'id': livre.id, 'titre': livre.titre, 'auteur': livre.auteur, 'editeur': livre.editeur, 'stock': livre.stock})\n\n@app.route('/livres/<int:livre_id>', methods=['DELETE'])\n@jwt_required\ndef delete_livre(livre_id):\n    livre = Livre.query.get(livre_id)\n    db.session.delete(livre)\n    db.session.commit()\n    return jsonify({'message': 'Livre supprimé'})\n\n@app.route('/membres', methods=['GET'])\n@jwt_required\ndef get_membres():\n    membres = Membre.query.all()\n    return jsonify([{'id': membre.id, 'nom': membre.nom, 'prenom': membre.prenom, 'email': membre.email} for membre in membres])\n\n@app.route('/membres', methods=['POST'])\n@jwt_required\ndef create_membre():\n    nom = request.json['nom']\n    prenom = request.json['prenom']\n    email = request.json['email']\n    mot_de_passe = generate_password_hash(request.json['mot_de_passe'])\n    membre = Membre(nom=nom, prenom=prenom, email=email, mot_de_passe=mot_de_passe)\n    db.session.add(membre)\n    db.session.commit()\n    return jsonify({'id': membre.id, 'nom': membre.nom, 'prenom': membre.prenom, 'email': membre.email})\n\n@app.route('/membres/<int:membre_id>', methods=['PUT'])\n@jwt_required\ndef update_membre(membre_id):\n    membre = Membre.query.get(membre_id)\n    nom = request.json['nom']\n    prenom = request.json['prenom']\n    email = request.json['email']\n    mot_de_passe = generate_password_hash(request.json['mot_de_passe'])\n    membre.nom = nom\n    membre.prenom = prenom\n    membre.email = email\n    membre.mot_de_passe = mot_de_passe\n    db.session.commit()\n    return jsonify({'id': membre.id, 'nom': membre.nom, 'prenom': membre.prenom, 'email': membre.email})\n\n@app.route('/membres/<int:membre_id>', methods=['DELETE'])\n@jwt_required\ndef delete_membre(membre_id):\n    membre = Membre.query.get(membre_id)\n    db.session.delete(membre)\n    db.session.commit()\n    return jsonify({'message': 'Membre supprimé'})\n\n@app.route('/emprunts', methods=['GET'])\n@jwt_required\ndef get_emprunts():\n    emprunts = Emprunt.query.all()\n    return jsonify([{'id': emprunt.id, 'livre_id': emprunt.livre_id, 'membre_id': emprunt.membre_id, 'date_emprunt': emprunt.date_emprunt, 'date_retour': emprunt.date_retour} for emprunt in emprunts])\n\n@app.route('/emprunts', methods=['POST'])\n@jwt_required\ndef create_emprunt():\n    livre_id = request.json['livre_id']\n    membre_id = request.json['membre_id']\n    date_emprunt = datetime.now(pytz.utc)\n    date_retour = date_emprunt + datetime.timedelta(days=14)\n    emprunt = Emprunt(livre_id=livre_id, membre_id=membre_id, date_emprunt=date_emprunt, date_retour=date_retour)\n    db.session.add(emprunt)\n    db.session.commit()\n    return jsonify({'id': emprunt.id, 'livre_id': emprunt.livre_id, 'membre_id': emprunt.membre_id, 'date_emprunt': emprunt.date_emprunt, 'date_retour': emprunt.date_retour})\n\n@app.route('/emprunts/<int:emprunt_id>', methods=['PUT'])\n@jwt_required\ndef update_emprunt(emprunt_id):\n    emprunt = Emprunt.query.get(emprunt_id)\n    livre_id = request.json['livre_id']\n    membre_id = request.json['membre_id']\n    date_emprunt = request.json['date_emprunt']\n    date_retour = request.json['date_retour']\n    emprunt.livre_id = livre_id\n    emprunt.membre_id = membre_id\n    emprunt.date_emprunt = date_emprunt\n    emprunt.date_retour = date_retour\n    db.session.commit()\n    return jsonify({'id': emprunt.id, 'livre_id': emprunt.livre_id, 'membre_id': emprunt.membre_id, 'date_emprunt': emprunt.date_emprunt, 'date_retour': emprunt.date_retour})\n\n@app.route('/emprunts/<int:emprunt_id>', methods=['DELETE'])\n@jwt_required\ndef delete_emprunt(emprunt_id):\n    emprunt = Emprunt.query.get(emprunt_id)\n    db.session.delete(emprunt)\n    db.session.commit()\n    return jsonify({'message': 'Emprunt supprimé'})\n\n@app.route('/rapport', methods=['GET'])\n@jwt_required\ndef generer_rapport():\n    pdf = FPDF()\n    pdf.add_page()\n    pdf.set_font(\"Arial\", size=15)\n    pdf.cell(200, 10, txt=\"Rapport bibliothèque\", ln=True, align='C')\n    pdf.output(\"rapport.pdf\")\n    return jsonify({'message': 'Rapport généré'})\n\nif __name__ == \"__main__\":\n    db.create_all()\n    app.run(debug=True)\n", "timestamp": 1766864136.9434917}