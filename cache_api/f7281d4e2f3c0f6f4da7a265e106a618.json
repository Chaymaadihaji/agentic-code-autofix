{"nom_fichier": "models.py", "code": "python\n# Importation des modules nécessaires\nfrom fastapi import FastAPI, Depends, HTTPException\nfrom pydantic import BaseModel\nfrom typing import List\nfrom fastapi import Form\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom passlib.context import CryptContext\nfrom pydantic import EmailStr\nfrom jose import jwt\nfrom datetime import datetime, timedelta\n\n# Définition des Constantes\nSECRET_KEY = \"d5a7f0e2b6c9a8f7e5d3c2b1a0\"\nALGORITHM = \"HS256\"\nACCESS_TOKEN_EXPIRES_HOURS = 24\n\n# Configuration MongoDB\nMongoClient = 'mongodb://localhost:27017/'\nDB_NAME = 'mydatabase'\nCOLLECTION_NAME = 'mycollection'\n\n# Création de l'application FastAPI\napp = FastAPI(\n    title=\"Mon API avec FastAPI\",\n    description=\"API REST créée avec FastAPI et MongoDB\",\n    version=\"1.0\",\n    terms_of_service=\"https://www.example.com/policies/terms/\",\n    contact={\n        \"name\": \"Jean Doe\",\n        \"email\": \"jean.doe@example.com\",\n        \"url\": \"https://www.example.com/about/contact/\",\n    },\n    license={\n        \"name\": \"License: MIT\",\n        \"url\": \"https://opensource.org/licenses/MIT\",\n    },\n    dependencies=[Depends(get_db)],\n)\n\n# Définition d'un modèle de données\nclass User(BaseModel):\n    id: int\n    email: EmailStr\n\nclass Post(BaseModel):\n    user_id: int\n    title: str\n    content: str\n\nclass UserSchema(BaseModel):\n    username: str\n    email: EmailStr\n    password: str\n\n# Définition d'un espace de travail pour MongoDB\nfrom pymongo import MongoClient\n\nclient = MongoClient(MongoClient)\ndb = client[DB_NAME]\nusers = db[COLLECTION_NAME]\n\n# Fonctions helpers\ndef get_db():\n    while True:\n        db = client[DB_NAME]\n        db_user = db[COLLECTION_NAME].find_one({'email': \"user1@example.com\"})\n        if db_user:\n            yield db, db_user\n\ndef verify_password(plain_password, hashed_password):\n    return CryptContext(schemes=[\"bcrypt\"], default=\"bcrypt\").verify(plain_password, hashed_password)\n\ndef authenticate_user(user_db, user_credentials):\n    if (user_db[\"password\"]) == (authenticate(user_credentials[\"password\"])):\n        return db_user\n    return None\n\ndef create_access_token(data: dict, expires_delta: timedelta | None = None):\n    to_encode = data.copy()\n    if expires_delta:\n        expire = datetime.utcnow() + expires_delta\n    else:\n        expire = datetime.utcnow() + timedelta(minutes=15)\n    to_encode.update({\"exp\": expire})\n    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)\n    return encoded_jwt\n\ndef generate_password_hash(password: str):\n    return CryptContext(schemes=[\"bcrypt\"], default=\"bcrypt\").hash(password)\n\n# Définition d'une fonction pour générer un token d'accès JWT\nasync def token_authentication(token: str = Depends()):\n    from jose import jwt\n    from datetime import datetime, timedelta\n\n    try:\n        data = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])\n    except:\n        raise HTTPException(status_code=401, detail=\"Token non valide\")\n\n    if data['exp'] < datetime.utcnow().timestamp():\n        raise HTTPException(status_code=401, detail=\"Token expiré\")\n\n    return data\n\n# Définition d'une fonction pour la recherche de données\nasync def get_user(id: int):\n    try:\n        user = users.find_one({\"id\": id})\n        return user\n    except Exception as e:\n        raise HTTPException(status_code=400, detail=str(e))\n\n# Définition des routes de notre API\n@app.get(\"/user/{user_id}\", response_model=UserSchema)\ndef read_user(user_id: int, token: str = Depends(token_authentication)):\n    user = await get_user(user_id)\n    if not user:\n        raise HTTPException(status_code=404, detail=\"User not found\")\n    return user\n@app.post(\"/post\", response_model=Post, description=\"Créer une nouvelle publication\")\nasync def create_post(form_data: Post = Form(description=\"Formulaire de publication\")):\n    await users.insert_one(form_data)\n    return form_data\n\n@app.get(\"/token\", response_model=UserSchema)\nasync def login_for_access_token(username: str = Form(\"username\"), password: str = Form(\"password\")):\n    user_db = db_user\n    if not user_db:\n        raise HTTPException(status_code=401, detail=\"Utilisateur non trouvé\")\n    if not verify_password(password, user_db[\"password\"]):\n        raise HTTPException(status_code=401, detail=\"Mot de passe incorrect\")\n    access_token_expires = timedelta(hours=ACCESS_TOKEN_EXPIRES_HOURS)\n    access_token = create_access_token(data={\"sub\": username}, expires_delta=access_token_expires)\n    return {\"access_token\": access_token, \"token_type\": \"bearer\"}\n", "langage": "python", "bugs_introduits": [], "corrections_appliquees": [], "timestamp": 1767108468.0702505, "tentative": 4}