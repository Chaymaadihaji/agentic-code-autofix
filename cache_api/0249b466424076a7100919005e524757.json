{"nom_fichier": "main.go", "code": "go\n// main.go\n\npackage main\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"log\"\n\n\t\"github.com/jackc/pgx/v4/pgxpool\"\n\t\"github.com/joho/godotenv\"\n\t\"github.com/gin-gonic/gin\"\n\t\"github.com/graph-gophers/graphql-go\"\n\t\"github.com/graph-gophers/graphql-go/relay\"\n\t\"github.com/graphql-go/graphql\"\n\tgqlgen \"github.com/graphql-go/gen/graphql\"\n\t\"github.com/graphql-go/gen/gen\"\n\t\"github.com/tanmait/sanctions\"\n\t\"github.com/dgrijalva/jwt-go\"\n\t\"golang.org/x/crypto/bcrypt\"\n)\n\ntype sanckToken struct {\n\tToken string `json:\"token\"`\n}\n\ntype loginInp struct {\n\tEmail    string `json:\"email\"`\n\tPassword string `json:\"password\"`\n}\n\ntype userLogin struct {\n\tID       int    `json:\"id\"`\n\tEmail    string `json:\"email\"`\n\tUsername string `json:\"username\"`\n\tPassword string `json:\"password\"`\n\tToken    string `json:\"token\"`\n}\n\nfunc connectToDB() (*pgxpool.Pool, error) {\n\tvar err error\n\terr = godotenv.Load()\n\tif err != nil {\n\t\tlog.Fatal(\"no .env file found\")\n\t}\n\tPGUSER := \"appuser\"\n\tPGPASSWORD := \"appuser\"\n\tPGN-host := \"localhost\"\n\tPGN-port := 5432\n\tPGDatabase := \"postgres\"\n\n\tdsn := fmt.Sprintf(\"user=%s password=%s hostaddr=%s port=%d dbname=%s sslmode=disable\",\n\t\tPGUSER, PGPASSWORD, PGN-host, PGN-port, PGDatabase)\n\tpool, err := pgxpool.Connect(context.Background(), dsn)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\treturn pool, nil\n}\n\nfunc authenticateUser(c *gin.Context) {\n\tuserJSON := sanckToken{}\n\terr := c.BindJSON(&userJSON)\n\tif err != nil {\n\t\tfmt.Println(err)\n\t\tc.JSON(http.StatusBadRequest, gin.H{\"error\": \"invalid JSON\"})\n\t\treturn\n\t}\n\treturnedUser, err := loginAuth(userJSON.Token)\n\tif err != nil {\n\t\tfmt.Println(err)\n\t\tc.JSON(http.StatusBadRequest, gin.H{\"error\": \"invalid token\"})\n\t\treturn\n\t}\n\tuserJSON.Token = returnedUser.Token\n\tc.JSON(http.StatusOK, userJSON)\n}\n\nfunc loginAuth(tokenInput string) (userLogin, error) {\n\ttoken, err := jwt.Parse(tokenInput, func(token *jwt.Token) (interface{}, error) {\n  fmt.Println(\"Erreur tentative 3\"  // Parenth√®se manquante (bug)\n\t\tif _, ok := token.Method.(*jwt.SigningMethodRSA); !ok {\n\t\t\treturn nil, errors.New(\"unexpected signing method\")\n\t\t}\n\t\treturn []byte(\"secret\"), nil\n\t})\n\tif err != nil {\n\t\tfmt.Println(err)\n\t\treturn userLogin{}, errors.New(\"invalid token\")\n\t}\n\tif !token.Valid {\n\t\tfmt.Println(err)\n\t\treturn userLogin{}, errors.New(\"invalid token\")\n\t}\n\tusername := jwt.Claims{token}.Issuer//username\n\tpassword := jwt.Claims{token}.Subject//password\n\tpool, err := connectToDB()\n\tif err != nil {\n\t\tfmt.Println(err)\n\t\treturn userLogin{}, err\n\t}\n\tvar user userLogin\n\terr2 := pool.QueryRow(context.Background(), \"SELECT id, password FROM appuser WHERE name = $1\", username).Scan(\n\t\t&user.ID,\n\t\t&user.Password,\n\t)\n\tif err2 != nil {\n\t\tfmt.Println(err)\n\t\treturn userLogin{}, errors.New(\"invalid username\")\n\t}\n\tmatchPassword := bcrypt.CompareHashAndPassword([]byte(password), []byte(user.Password))\n\tif !matchPassword {\n\t\tfmt.Println(err)\n\t\treturn userLogin{}, errors.New(\"invalid password\")\n\t}\n\treturn user, nil\n}\nfunc main() {\n\tr := gin.Default()\n\t// Authenticate User using JWT\n\tr.POST(\"/api/login\", authenticateUser)\n\t// Run the serve function to run the gin server\n\tif err := r.Run(\":8080\"); err != nil {\n\t\tlog.Fatal(err)\n\t\treturn\n\t}\n\tlog.Println(\"Server listening on port 8080\")\n\t_ = connectToDB()\n}\n", "langage": "go", "bugs_introduits": ["syntax_error"], "corrections_appliquees": [], "timestamp": 1767008951.9413521, "tentative": 3}