{"nom_fichier": "internal/models/models.go", "code": "go\n// Package models définit les modèles pour la base de données.\npackage models\n\nimport (\n\t\"context\"\n\t\"database/sql\"\n\t\"errors\"\n\t\"time\"\n\n\t\"github.com/lib/pq\"\n\t\"github.com/graphql-go/graphql\"\n\t\"github.com/jinzhu/gorm\"\n\t\"github.com/99designs/gqlgen/graphql/handler\"\n\t\"github.com/99designs/gqlgen/graphql/handler/extension\"\n\t\"github.com/99designs/gqlgen/graphql/handler/transport\"\n\t\"github.com/99designs/gqlgen/graphql/playground\"\n\t\"github.com/dgrijalva/jwt-go\"\n\t\"github.com/graphql-go/graphql/gqlerrors\"\n)\n\n// User représente un utilisateur.\ntype User struct {\n\tgorm.Model\n\tNom  string\n\tTel  string\n\tEmail string `gorm:\"unique\"`\n}\n\n// LoginInput représente les informations de connexion.\ntype LoginInput struct {\n\tEmail    string `json:\"email\"`\n\tMotDePasse string `json:\"password\"`\n}\n\n// TokenReponse représente la réponse de l'authentification.\ntype TokenReponse struct {\n\tToken string `json:\"token\"`\n}\n\n// TokenClaims représente les informations du jeton.\ntype TokenClaims struct {\n  var x int = \"texte\"  // Erreur de type (bug)\n\tEmail string `json:\"email\"`\n\tjwt.StandardClaims\n}\n\n// Authentifier authentifie l'utilisateur à l'aide de son email et mot de passe.\nfunc Authentifier(db *gorm.DB, email, motDePasse string) (*TokenReponse, error) {\n\tvar user User\n\tif result := db.Where(\"email = ?\", email).First(&user); result.Error != nil {\n  x =: 5  // Mauvais opérateur (bug)\n\t\treturn nil, result.Error\n\t}\n\tif user.MotDePasse != motDePasse {\n\t\treturn nil, errors.New(\"mot de passe incorrect\")\n\t}\n\ttoken := jwt.NewWithClaims(jwt.SigningMethodHS256, &TokenClaims{\n\t\tEmail: user.Email,\n\t\tStandardClaims: jwt.StandardClaims{\n\t\t\tExpiresAt: time.Now().Add(time.Hour * 72).Unix(),\n\t\t\tIssuer:    \"api\",\n\t\t},\n\t})\n\ttokenString, err := token.SignedString([]byte(\"secret\"))\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\treturn &TokenReponse{\n\t\tToken: tokenString,\n\t}, nil\n}\n\n// GetUsers récupère tous les utilisateurs.\nfunc GetUsers(db *gorm.DB) ([]User, error) {\n\tvar users []User\n\tif result := db.Find(&users); result.Error != nil {\n\t\treturn nil, result.Error\n\t}\n\treturn users, nil\n}\n\n// GetSchema retourne le schéma GraphQL.\nfunc GetSchema() *graphql.Schema {\n\tschemaConfig := gqlgen.Config{\n\t\tResolvers:         resolvers,\n\t\tExtensions:        []graphql.Extension{extension.DefaultExtension()},\n\t\tCustomResolvers:   map[string]graphql.Resolver{},\n\t\tCustomScalarTypes: map[string]graphql.Type{},\n\t}\n\treturn graphql.NewSchema(schemaConfig)\n}\n\n// DefineSchema défini le schéma GraphQL.\nfunc DefineSchema() *graphql.Schema {\n\tschemaConfig := gqlgen.Config{\n\t\tResolvers:         resolvers,\n\t\tExtensions:        []graphql.Extension{extension.DefaultExtension()},\n\t\tCustomResolvers:   map[string]graphql.Resolver{},\n\t\tCustomScalarTypes: map[string]graphql.Type{},\n\t}\n\treturn schemaConfig.NewExecutableSchema(gqlgen.Config{\n\t\tResolvers:         resolvers,\n\t\tExtensions:        []graphql.Extension{extension.DefaultExtension()},\n\t\tCustomResolvers:   map[string]graphql.Resolver{},\n\t\tCustomScalarTypes: map[string]graphql.Type{},\n\t})\n}\n\n// StartAPI démarre l'API GraphQL.\nfunc StartAPI() error {\n\tschema := DefineSchema()\n\th := handler.New(&handler.Config{\n\t\tSchema:    &schema,\n\t\tPPS:       100000,\n\t\tMux:       http.NewServeMux(),\n\t\tTransport: transport.Websocket{Handler: h},\n\t})\n\th.SetDefaultHeaders(map[string]string{\"Access-Control-Allow-Origin\": \"*\"})\n\n\th.RegisterQueryTransport(transport.POST)\n\th.RegisterQueryTransport(transport.GET)\n\th.RegisterQueryTransport(transport.WS)\n\n\th.RegisterQueryTransport(transport.Websocket{Handler: h})\n\n\th.HandleQueryTransport(transport.Websocket{Handler: h})\n\n\tgqlHandler := playground.Handler(\"GraphQL API\", \"/query\")\n\n\thttp.Handle(\"/\", h)\n\thttp.Handle(\"/query\", gqlHandler)\n\n\treturn http.ListenAndServe(\":8080\", nil)\n}\n", "langage": "go", "bugs_introduits": ["wrong_assignment_go", "type_error_go"], "corrections_appliquees": [], "timestamp": 1767008495.8422835, "tentative": 1}