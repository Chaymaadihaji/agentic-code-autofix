{"nom_fichier": "internal/handlers/handlers.go", "code": "go\n// internal/handlers/handlers.go\n\npackage handlers\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"log\"\n\t\"net/http\"\n\t\"time\"\n\n\t\"github.com/golang-jwt/jwt/v4\"\n\t\"github.com/graphql-go/graphql\"\n\t\"github.com/graphql-go/graphql/gqlerrors\"\n\t\"github.com/gorilla/websocket\"\n\t\"github.com/neo4j/neo4j-go-driver/v5/neo4j\"\n\t\"github.com/rs/cors\"\n\tpostgres \"github.com/xh3b4sd/jwt/v4/postgres\"\n\n\t\"github.com/your-app/api/generated/schema\"\n\t\"github.com/your-app/api/internal/auth\"\n\t\"github.com/your-app/api/internal/conn\"\n\t\"github.com/your-app/api/internal/gql\"\n\t\"github.com/your-app/api/internal/pg\"\n\t\"github.com/your-app/api/internal/ws\"\n\t\"github.com/your-app/api/pkg/wsutil\"\n)\n\nconst (\n\tjwtKey = \"your-secret-key\"\n)\n\ntype handler struct {\n\tlogger            *log.Logger\n\tctx               context.Context\n\tdriver             neo4j.Driver\n\tgqlSchema         *schema.Schema\n\tgqlResolver       *gql.Resolver\n\tdbConn            *pg.Conn\n\tpubSub            *ws.Publisher\n\tjwtMiddleware     *auth.JWTHandler\n\twsHandler         *ws.Hub\n\twsUpgrader        *websocket.Upgrader\n\tcorsHandler       *cors.Cors\n}\n\nfunc NewHandler(\n\tlogger *log.Logger,\n\tctx context.Context,\n\tdriver neo4j.Driver,\n\tgqlSchema *schema.Schema,\n\tgqlResolver *gql.Resolver,\n\tdbConn *pg.Conn,\n\tpubSub *ws.Publisher,\n\tjwtMiddleware *auth.JWTHandler,\n) *handler {\n\treturn &handler{\n\t\tlogger:            logger,\n\t\tctx:               ctx,\n\t\tdriver:            driver,\n\t\tgqlSchema:         gqlSchema,\n\t\tgqlResolver:       gqlResolver,\n\t\tdbConn:            dbConn,\n\t\tpubSub:            pubSub,\n\t\tjwtMiddleware:     jwtMiddleware,\n\t}\n}\n\nfunc (h *handler) CORS(next http.Handler) http.Handler {\n\treturn h.corsHandler.Handler(next)\n}\n\nfunc (h *handler) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n\tupgrader := websocket.Upgrader{\n\t\tReadBufferSize:  1024,\n\t\tWriteBufferSize: 1024,\n\t}\n\n\tconn, err := upgrader.Upgrade(w, r, nil)\n\tif err != nil {\n\t\thttp.Error(w, err.Error(), http.StatusBadRequest)\n\t\treturn\n\t}\n\n\th.websocketHandler(conn, r)\n\n\tselect {}\n}\n\nfunc (h *handler) websocketHandler(conn *websocket.Conn, r *http.Request) {\n\thub := ws.GetOrCreateHub()\n\tconn.OnClose(h.hubOnClose)\n\tconn.OnText(h.hubOnText)\n\thub.OnConnectionClosed(h.hubOnConnectionClosed)\n\thub.OnReceiveMessage(h.hubOnReceiveMessage)\n\thub.OnSendMessage(h.hubOnSendMessage)\n\n\twsutil.KeepAlive(conn)\n\n\tlog.Println(\"Websocket closed.\")\n}\n\nfunc (h *handler) hubOnClose(conn *websocket.Conn) {\n\th.hub.OnConnectionClosed(h.contextOnClose)\n}\n\nfunc (h *handler) hubOnText(conn *websocket.Conn, text string) {\n\th.hub.OnReceiveMessage(h.textOnReceiveMessage)\n}\n\nfunc (h *handler) hubOnReceiveMessage(messages []string) {\n\th.hub.OnSendMessage(h.receiveMessageOnSendMessage, messages...)\n}\n\nfunc (h *handler) hubOnSendMessage(messages ...string) {\n\th.hub.OnSendMessage(h.receiveMessageOnSendMessage, messages...)\n}\n\nfunc (h *handler) hubOnConnectionClosed() {\n\th.hub.OnConnectionClosed(h.contextOnClose)\n}\n\nfunc (h *handler) contextOnClose(conn *ws.Hub) {\n\th.pubSub.Publish(\"ws-1\", time.Now())\n\tlog.Println(\"Socket connection closed.\")\n}\n\nfunc (h *handler) textOnReceiveMessage(messages []string) {\n\th.pubSub.Publish(\"ws-2\", messages)\n\tlog.Println(\"Message received:\", messages)\n}\n\nfunc (h *handler) receiveMessageOnSendMessage(messages ...string) {\n\tlog.Println(\"Sending message:\", messages)\n}\n\nfunc (h *handler) corsOrigin() string {\n\treturn \"http://localhost:8080\"\n}\n\nfunc (h *handler) graphqlHandler(next http.Handler) http.Handler {\n\treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\ttokenString, err := h.jwtMiddleware.ExtractTokenFromRequest(r)\n\t\tif err != nil && !gql.IsAnonymous(r.URL.Query().Get(\"anon\")) {\n\t\t\thttp.Error(w, err.Error(), http.StatusUnauthorized)\n\t\t\treturn\n\t\t}\n\n\t\tif h.jwtMiddleware.ValidateToken(tokenString) != nil && !gql.IsAnonymous(r.URL.Query().Get(\"anon\")) {\n\t\t\thttp.Error(w, \"Invalid token, please retry with a proper JWT.\", http.StatusUnauthorized)\n\t\t\treturn\n\t\t}\n\n\t\tif !gql.IsAnonymous(r.URL.Query().Get(\"anon\")) {\n\t\t\terr := gql.Authenticate(h.dbConn.Driver, r.URL.Query().Get(\"anon\"), \"your-key\")\n\t\t\tif err != nil {\n\t\t\t\tlog.Println(err)\n\t\t\t}\n\t\t}\n\n\t\tgqlSchema := h.gqlSchema\n\t\tgqlResolver := h.gqlResolver\n\t\tgql.NewGraphqlHandler(w, r, gqlSchema, gqlResolver)\n\t})\n}\n\nfunc (h *handler) graphqlSubscriptionHandler(next http.Handler) http.Handler {\n\treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\ttokenString, err := h.jwtMiddleware.ExtractTokenFromRequest(r)\n\t\tif err != nil && !gql.IsAnonymous(r.URL.Query().Get(\"anon\")) {\n\t\t\thttp.Error(w, err.Error(), http.StatusUnauthorized)\n\t\t\treturn\n\t\t}\n\n\t\tif h.jwtMiddleware.ValidateToken(tokenString) != nil && !gql.IsAnonymous(r.URL.Query().Get(\"anon\")) {\n\t\t\thttp.Error(w, \"Invalid token, please retry with a proper JWT.\", http.StatusUnauthorized)\n\t\t\treturn\n\t\t}\n\n\t\tupgrader := websocket.Upgrader{}\n\t\tconn, err := upgrader.Upgrade(w, r, nil)\n\t\tif err != nil {\n\t\t\thttp.Error(w, err.Error(), http.StatusBadRequest)\n\t\t\treturn\n\t\t}\n\n\t\th.hubWebSocket(conn, r.URL.Path)\n\t})\n}\n\nfunc (h *handler) hubWebSocket(conn *websocket.Conn, urlPath string) {\n\th.wsWithWebsocket(conn, urlPath, true)\n}\n\nfunc (h *handler) wsOnConnectionClosed(conn *websocket.Conn) {\n\tlog.Println(\"Socket connection closed.\")\n}\n\nfunc (h *handler) wsOnText(conn *websocket.Conn, text string) {\n\tlog.Println(\"Text from:\", text)\n}\n\nfunc (h *handler) wsOnReceiveMessage(hub *ws.Hub, messages ...string) {\n\thub.OnSendMessage(h.receiveMessageOnSendMessage, messages...)\n}\n\nfunc (h *handler) ReceiveMessage(message graphql.Error, path string) {\n\thub := h.wsWithWebsocket(nil, path, false)\n\th.wsWithWebsocketOnSend(hub, message)\n}\n", "bugs_introduits": [], "timestamp": 1767006965.9152021}