{"nom_fichier": "main.java", "code": "java\n// main.java\npackage com.api.example;\n\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.boot.web.servlet.support.SpringBootServletInitializer;\n\n@SpringBootApplication\npublic class Main extends SpringBootServletInitializer {\n\n    public static void main(String[] args) {\n        SpringApplication.run(Main.class, args);\n    }\n}\n\n// ApplicationConfig.java\npackage com.api.example.config;\n\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.authentication.AuthenticationManager;\nimport org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\nimport org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;\nimport org.springframework.security.crypto.password.PasswordEncoder;\nimport org.springframework.security.oauth2.provider.token.TokenEnhancer;\nimport org.springframework.security.oauth2.provider.token.TokenEnhancerChain;\nimport org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;\nimport org.springframework.security.oauth2.provider.token.store.JwtTokenStore;\n\nimport com.api.example.security.JwtUserDetailsService;\nimport com.api.example.security.MyUserDetailsService;\n\n@Configuration\n@EnableWebSecurity\npublic class ApplicationConfig extends WebSecurityConfigurerAdapter {\n\n    private final MyUserDetailsService userDetailsService;\n\n    @Autowired\n    public ApplicationConfig(MyUserDetailsService userDetailsService) {\n        this.userDetailsService = userDetailsService;\n    }\n\n    @Bean\n    public PasswordEncoder passwordEncoder() {\n        return new BCryptPasswordEncoder();\n    }\n\n    @Bean\n    @Override\n    protected AuthenticationManager authenticationManager() throws Exception {\n        return super.authenticationManager();\n    }\n\n    @Override\n    protected void configure(AuthenticationManagerBuilder auth) throws Exception {\n        auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());\n    }\n\n    @Override\n    protected void configure(HttpSecurity http) throws Exception {\n        http.authorizeRequests()\n                .antMatchers(\"/login\").permitAll()\n                .anyRequest().authenticated()\n                .and()\n                .csrf().disable()\n                .oauth2Login()\n                .loginPage(\"/login\")\n                .and()\n                .oauth2AuthorizationServer()\n                .tokenEnhancerChain(new TokenEnhancerChain())\n                .tokenEnhancer(jwtTokenEnhancer())\n                .tokenStore(jwtTokenStore());\n    }\n\n    @Bean\n    public JwtTokenStore jwtTokenStore() {\n        return new JwtTokenStore(jwtAccessTokenConverter());\n    }\n\n    @Bean\n    public JwtAccessTokenConverter jwtAccessTokenConverter() {\n        JwtAccessTokenConverter converter = new JwtAccessTokenConverter();\n        converter.setSigningKey(\"secret\");\n        return converter;\n    }\n\n    @Bean\n    public TokenEnhancer jwtTokenEnhancer() {\n        return new MyTokenEnhancer();\n    }\n}\n\n// MyUserDetailsService.java\npackage com.api.example.security;\n\nimport org.springframework.security.core.authority.SimpleGrantedAuthority;\nimport org.springframework.security.core.userdetails.UserDetails;\nimport org.springframework.security.core.userdetails.UserDetailsService;\nimport org.springframework.security.core.userdetails.UsernameNotFoundException;\nimport org.springframework.security.core.userdetails.User;\n\nimport com.api.example.model.UserEntity;\n\nimport java.util.Arrays;\nimport java.util.List;\n\npublic class MyUserDetailsService implements UserDetailsService {\n\n    private final UserService userService;\n\n    @Autowired\n    public MyUserDetailsService(UserService userService) {\n        this.userService = userService;\n    }\n\n    @Override\n    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {\n        UserEntity user = userService.getUserByUserName(username);\n        if (user == null) {\n            throw new UsernameNotFoundException(\"User not found\");\n        }\n        return new User(user.getUserName(), user.getPassword(), getAuthorities(user.getRoles()));\n    }\n\n    private List<SimpleGrantedAuthority> getAuthorities(List<String> roles) {\n        return roles.stream()\n                .map(role -> new SimpleGrantedAuthority(role))\n                .toList();\n    }\n}\n\n// UserService.java\npackage com.api.example.service;\n\nimport com.api.example.model.UserEntity;\n\npublic interface UserService {\n    UserEntity getUserByUserName(String username);\n}\n\n// UserRepository.java\npackage com.api.example.repository;\n\nimport com.api.example.model.UserEntity;\n\nimport org.springframework.data.jpa.repository.JpaRepository;\nimport org.springframework.stereotype.Repository;\n\n@Repository\npublic interface UserRepository extends JpaRepository<UserEntity, Long> {\n}\n\n// UserEntity.java\npackage com.api.example.model;\n\nimport javax.persistence.Entity;\nimport javax.persistence.GeneratedValue;\nimport javax.persistence.GenerationType;\nimport javax.persistence.Id;\n\n@Entity\npublic class UserEntity {\n\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Long id;\n\n    private String userName;\n\n    private String password;\n\n    private List<String> roles;\n\n    public Long getId() {\n        return id;\n    }\n\n    public void setId(Long id) {\n        this.id = id;\n    }\n\n    public String getUserName() {\n        return userName;\n    }\n\n    public void setUserName(String userName) {\n        this.userName = userName;\n    }\n\n    public String getPassword() {\n        return password;\n    }\n\n    public void setPassword(String password) {\n        this.password = password;\n    }\n\n    public List<String> getRoles() {\n        return roles;\n    }\n\n    public void setRoles(List<String> roles) {\n        this.roles = roles;\n    }\n}\n\n// MyTokenEnhancer.java\npackage com.api.example.security;\n\nimport org.springframework.security.oauth2.provider.token.DefaultTokenServices;\nimport org.springframework.security.oauth2.provider.token.TokenEnhancer;\n\npublic class MyTokenEnhancer implements TokenEnhancer {\n\n    @Override\n    public OAuth2AccessToken enhance(OAuth2AccessToken accessToken, OAuth2Authentication authentication) {\n        UserEntity user = (UserEntity) authentication.getPrincipal();\n        ((DefaultTokenServices) accessToken.getValue()).setAccessTokenValiditySeconds(30 * 60);\n        return accessToken;\n    }\n}\n\n// SwaggerConfig.java\npackage com.api.example.config;\n\nimport springfox.documentation.builders.PathSelectors;\nimport springfox.documentation.builders.RequestHandlerSelectors;\nimport springfox.documentation.service.ApiInfo;\nimport springfox.documentation.service.ApiKey;\nimport springfox.documentation.service.AuthorizationScope;\nimport springfox.documentation.service.SecurityReference;\nimport springfox.documentation.service.SecurityScheme;\nimport springfox.documentation.spi.DocumentationType;\nimport springfox.documentation.spi.service.contexts.SecurityContext;\nimport springfox.documentation.spring.web.plugins.Docket;\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n\nimport java.util.ArrayList;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Set;\n\n@Configuration\npublic class SwaggerConfig {\n\n    @Bean\n    public Docket api() {\n        return new Docket(DocumentationType.SWAGGER_2)\n                .select()\n                .apis(RequestHandlerSelectors.any())\n                .paths(PathSelectors.any())\n                .build()\n                .apiInfo(apiInfo());\n    }\n\n    private ApiInfo apiInfo() {\n        return new ApiInfo(\n                \"API\",\n                \"API\",\n                \"1.0\",\n                \"\",\n                \"\",\n                \"\",\n                \"\",\n                new ArrayList<>()\n        );\n    }\n\n    @Bean\n    public ApiKey apiKey() {\n        return new ApiKey(\"Bearer\", \"Authorization\", \"header\");\n    }\n\n    @Bean\n    public SecurityContext securityContext() {\n        return SecurityContext.builder()\n                .securityReferences(defaultAuth())\n                .build();\n    }\n\n    List<SecurityReference> defaultAuth() {\n        AuthorizationScope authorizationScope = new AuthorizationScope(\"global\", \"accessEverything\");\n        AuthorizationScope[] authorizationScopes = new AuthorizationScope[1];\n        authorizationScopes[0] = authorizationScope;\n        return Arrays.asList(new SecurityReference(\"Bearer\", authorizationScopes));\n    }\n}\n", "langage": "java", "bugs_introduits": ["undefined_variable", "syntax_error"], "corrections_appliquees": [], "timestamp": 1767105650.4535067, "tentative": 1}