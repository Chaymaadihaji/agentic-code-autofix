{"nom_fichier": "main.java", "code": "java\n// main.java\n\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.security.authentication.AuthenticationManager;\nimport org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\nimport org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;\nimport org.springframework.security.crypto.password.PasswordEncoder;\n\nimport io.swagger.v3.oas.models.ExternalDocumentation;\nimport io.swagger.v3.oas.models.OpenAPI;\nimport io.swagger.v3.oas.models.info.Info;\nimport io.swagger.v3.oas.models.info.License;\n\nimport javax.sql.DataSource;\n\n@SpringBootApplication\n@EnableWebSecurity\npublic class ApiApplication extends WebSecurityConfigurerAdapter {\n\n    @Autowired\n    private UserDetailsService userDetailsService;\n\n    @Override\n    protected void configure(AuthenticationManagerBuilder auth) throws Exception {\n        auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());\n    }\n\n    @Override\n    protected void configure(HttpSecurity http) throws Exception {\n        http.csrf().disable().authorizeRequests().antMatchers(\"/api/auth/**\").permitAll().anyRequest().authenticated();\n    }\n\n    @Bean\n    public PasswordEncoder passwordEncoder() {\n        return new BCryptPasswordEncoder();\n    }\n\n    @Bean\n    public DataSource dataSource() {\n        return DataSourceBuilder.create().driverClassName(\"org.postgresql.Driver\")\n                .url(\"jdbc:postgresql://localhost:5432/api\")\n                .username(\"user\")\n                .password(\"password\")\n                .build();\n    }\n\n    public static void main(String[] args) {\n        SpringApplication.run(ApiApplication.class, args);\n    }\n}\n\n@Service\npublic class AuthService {\n\n    private final AuthenticationManager authenticationManager;\n    private final PasswordEncoder passwordEncoder;\n    private final UserRepository userRepository;\n\n    @Autowired\n    public AuthService(AuthenticationManager authenticationManager, PasswordEncoder passwordEncoder, UserRepository userRepository) {\n        this.authenticationManager = authenticationManager;\n        this.passwordEncoder = passwordEncoder;\n        this.userRepository = userRepository;\n    }\n\n    public String login(String username, String password) {\n        try {\n            Authentication authentication = authenticationManager.authenticate(new UsernamePasswordAuthenticationToken(username, password));\n            return Jwts.builder().setSubject(username).setIssuedAt(new Date()).signWith(SignatureAlgorithm.HS256, \"secretkey\").compact();\n        } catch (BadCredentialsException e) {\n            return \"Bad credentials\";\n        }\n    }\n\n    public User register(String username, String email, String password) {\n        User user = new User(username, email);\n        user.setPassword(passwordEncoder.encode(password));\n        return userRepository.save(user);\n    }\n}\n\n@RestController\n@RequestMapping(\"/api\")\npublic class UserController {\n\n    private final UserService userService;\n\n    @Autowired\n    public UserController(UserService userService) {\n        this.userService = userService;\n    }\n\n    @GetMapping(\"/users\")\n    public List<User> getUsers() {\n        return userService.getUsers();\n    }\n\n    @GetMapping(\"/users/{id}\")\n    public User getUser(@PathVariable Long id) {\n        return userService.getUser(id);\n    }\n\n    @PostMapping(\"/users\")\n    public User create(@RequestBody User user) {\n        return userService.save(user);\n    }\n\n    @PutMapping(\"/users/{id}\")\n    public User update(@PathVariable Long id, @RequestBody User user) {\n        return userService.update(id, user);\n    }\n\n    @DeleteMapping(\"/users/{id}\")\n    public void delete(@PathVariable Long id) {\n        userService.delete(id);\n    }\n}\n\n@Data\n@Entity\npublic class User {\n\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Long id;\n\n    @Column(length = 20)\n    private String username;\n\n    @Column(length = 50)\n    private String email;\n\n    @Column(length = 60, nullable = false)\n    private String password;\n\n    // Getters and setters...\n}\n\n// UserDetailsService implementation\n@Service\npublic class CustomUserDetailsService implements UserDetailsService {\n\n    @Autowired\n    private UserRepository userRepository;\n\n    @Override\n    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {\n        User user = userRepository.findByUsername(username);\n        if (user == null) {\n            throw new UsernameNotFoundException(username);\n        }\n        return new User(user.getUsername(), user.getPassword(), getAuthorities(\"USER\"));\n    }\n\n    private List<GrantedAuthority> getAuthorities(String... roles) {\n        List<GrantedAuthority> authorities = new ArrayList<>();\n        for (String role : roles) {\n            authorities.add(new SimpleGrantedAuthority(role));\n        }\n        return authorities;\n    }\n}\n\n// Repositories\n@Repository\npublic interface UserRepository extends JpaRepository<User, Long> {\n\n    @Query(\"SELECT u FROM User u WHERE u.username = :username\")\n    Optional<User> findByUsername(@Param(\"username\") String username);\n}\n\n// Swagger\n@Configuration\npublic class SwaggerConfig implements WebMvcConfigurer {\n\n    @Bean\n    public Docket api() {\n        return new Docket(DocumentationType.OAUTH2)\n                .apiInfo(apiInfo())\n                .securityContexts(Arrays.asList(securityContext()))\n                .securitySchemes(Arrays.asList(apiKey()))\n                .select()\n                .apis(Requests.class)\n                .build();\n    }\n\n    private ApiInfo apiInfo() {\n        return new ApiInfoBuilder()\n                .title(\"API Documentation\")\n                .description(\"API Documentation\")\n                .version(\"1.0\")\n                .license(\"Apache 2.0\")\n                .licenseUrl(\"http://www.apache.org/licenses/LICENSE-2.0\")\n                .contact(new Contact(\"Author\", \"https://www.author.com\", \"author@example.com\"))\n                .build();\n    }\n\n    private SecurityContext securityContext() {\n        return SecurityContext.builder()\n                .securityReferences(Arrays.asList(new SecurityReference(\"Bearer\", new Authority[] { new Authority(\"ROLE_USER\") })))\n                .build();\n    }\n\n    private ApiKey apiKey() {\n        return new ApiKey(\"Bearer\", \"Authorization\", \"header\");\n    }\n}\n\n// Tests\n@RunWith(SpringRunner.class)\n@SpringBootTest\npublic class ApiApplicationTests {\n\n    @Autowired\n    private WebApplicationContext wac;\n\n    privateMockMvc mockMvc;\n\n    @Before\n    public void setup() {\n        this.mockMvc = MockMvcBuilders.webAppContextSetup(this.wac).build();\n        User user = new User();\n        user.setUsername(\"username\");\n        user.setEmail(\"email@example.com\");\n        user.setPassword(\"password\");\n        userRepository.save(user);\n    }\n\n    @Test\n    void loginTest() throws Exception {\n        mockMvc.perform(post(\"/api/auth/login\")\n                .param(\"username\", \"username\")\n                .param(\"password\", \"password\"))\n                .andExpect(status().isOk())\n                .andExpect(content().string(\"eyJhbGciOiJIUzI1NiJ9\"));\n    }\n\n    @Test\n    void registerTest() throws Exception {\n        mockMvc.perform(post(\"/api/users\")\n                .contentType(MediaType.APPLICATION_JSON)\n                .content(\"{\\\"username\\\":\\\"newuser\\\",\\\"email\\\":\\\"newuser@example.com\\\",\\\"password\\\":\\\"newpassword\\\"}\"))\n                .andExpect(status().isCreated())\n                .andExpect(content().string(\"{\\\"id\\\":1,\\\"username\\\":\\\"newuser\\\",\\\"email\\\":\\\"newuser@example.com\\\"}\"));\n    }\n}\n", "langage": "java", "bugs_introduits": ["syntax_error", "undefined_variable"], "corrections_appliquees": [], "timestamp": 1767105691.6611648, "tentative": 3}