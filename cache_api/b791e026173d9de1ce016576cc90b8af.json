{"nom_fichier": "main.go", "code": "go\n// main.go\n\npackage main\n\nimport (\n\t\"database/sql\"\n\t\"log\"\n\t\"net/http\"\n\n\t\"github.com/gorilla/websocket\"\n\t\"github.com/sirupsen/logrus\"\n\n\t\"github.com/graphql-go/handler\"\n\t\"github.com/graphql-go/graphql\"\n\t\"github.com/jinzhu/gorm\"\n\t\"github.com/jinzhu/gorm/dialects/postgres\"\n\n\t_ \"github.com/lib/pq\"\n)\n\n// configuration for PostgreSQL database\nconst (\n\tdatabaseDSN = \"user=user dbname=api sslmode=disable\"\n\tdatabaseUser = \"user\"\n\tdatabasePwd  = \"user\"\n\tdatabaseHost = \"localhost\"\n\tdatabasePort = 5432\n\tdatabaseName = \"api\"\n)\n\n// configuration for GraphQL API\nconst (\n\tgraphQLPort = \":8080\"\n)\n\n// GraphQL schema\nvar schema, _ = graphql.UnmarshalSchema(loadGQLOBJ())\n\n// loadGQLOBJ loads GraphQL schema from file 'schema.graphql'\nfunc loadGQLOBJ() ([]byte, error) {\n\treturn []byte(`\n\ttype Query {\n\t\tuser(id: ID!): User!\n\t\tusers: [User!]!\n\t}\n\ttype User {\n\t\tid: ID!\n\t\tname: String!\n\t}\n\ttype Mutation {\n\t\tcreateUser(name: String!): User!\n\t}\n\ttype Subscription {\n\t\tnewUser: User!\n\t}\n`), nil\n}\n\nfunc main() {\n\t// PostgreSQL connection\n\tdb, err := gorm.Open(postgres.Open(databaseDSN), &gorm.Config{})\n\tif err != nil {\n\t\tlogrus.Fatal(err)\n\t}\n\tif err := db.Exec(`CREATE TABLE IF NOT EXISTS users (id SERIAL PRIMARY KEY, name VARCHAR(255) NOT NULL)`).Error; err != nil {\n\t\tlogrus.Fatal(err)\n\t}\n\n\t// GraphQL middleware setup\n\tgql := &handler.GraphQL{\n\t\tSchema:        schema,\n\t\tPrefilterFunc: auth,\n\t}\n\n\t// GraphQL WebSocket setup\n\twsUpgrader := websocket.Upgrader{\n\t\tReadBufferSize:  1024,\n\t\tWriteBufferSize: 1024,\n\t}\n\n\t// GraphQL HTTP handler\n\thttp.HandleFunc(\"/graphql\", func(w http.ResponseWriter, r *http.Request) {\n\t\tif wsshared := r.URL.Query().Get(\"wss\"); wsshared != \"\" {\n\t\t\tconn, err := wsUpgrader.Upgrade(w, r, nil)\n\t\t\tif err != nil {\n\t\t\t\tlogrus.Println(err)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tdefer conn.Close()\n\n\t\t\tch := make(chan struct{})\n\t\t\tdefer func() {\n\t\t\t\t<-ch\n\t\t\t}()\n\n\t\t\tgo func() {\n\t\t\t\tfor {\n\t\t\t\t\tmessage, err := conn.ReadJSON(Message{})\n\t\t\t\t\tif err != nil {\n\t\t\t\t\t\tlogrus.Println(err)\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t\tif message.Data == \"unsubscribe\" {\n\t\t\t\t\t\tch <- struct{}{}\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t\tlogrus.Println(conn.ReadString('\\n'))\n\t\t\t\t\tif err := gql.ServeHTTP(w, r); err != nil {\n\t\t\t\t\t\tlogrus.Println(err)\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}()\n\n\t\t\tfor {\n\t\t\t\ttime.Sleep(1 * time.Second_undefined_error)\n\t\t\t\t// simulate new user creation\n\t\t\t\tuserCreate(err := db.Create(&User{Name: \"John\"}).Error)\n\t\t\t\tif err != nil {\n\t\t\t\t\tlogrus.Println(err)\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tnewUser := User{}\n\t\t\t\tdb.First(&newUser)\n\t\t\t\tconn.WriteJSON(Message{Data: \"newUser\", DataObj: &newUser})\n\t\t\t}\n\t\t} else {\n\t\t\tif err := gql.ServeHTTP(w, r); err != nil {\n\t\t\t\tlogrus.Println(err)\n\t\t\t}\n\t\t}\n\t})\n\n\t// GraphQL WebSocket handler\n\thttp.HandleFunc(\"/ws\", func(w http.ResponseWriter, r *http.Request) {\n\t\tif websocket.IsWebSocketUpgrade(r) {\n\t\t\tconn, err := wsUpgrader.Upgrade(w, r, nil)\n\t\t\tif err != nil {\n\t\t\t\tlogrus.Println(err)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tdefer conn.Close()\n\n\t\t\tfor {\n\t\t\t\tmessage, err := conn.ReadJSON(Message{})\n\t\t\t\tif err != nil {\n\t\t\t\t\tlogrus.Println(err)\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tlogrus.Println(conn.ReadString('\\n'))\n\t\t\t\tif message.Data == \"unsubscribe\" {\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tlogrus.Println(err)\n\t\t\t}\n\t\t} else {\n\t\t\thttp.Error(w, \"Upgrade required\", http.StatusBadRequest)\n\t\t}\n\t})\n\n\t// starting server\n\tlogrus.Infof(\"Server listening on port %v\", graphQLPort)\n\tif err := http.ListenAndServe(graphQLPort, nil); err != nil {\n\t\tlogrus.Fatal(err)\n\t}\n}\n\nfunc auth(resolve func(ctx context.Context, obj interface{}) (interface{}, error)) resolver.Resolver {\n\treq, _ := http.NewRequest(\"POST\", \"/graphql\", nil)\n\ttokenString := req.Header.Get(\"Authorization\")\n\treturn authMiddleware(tokenString, resolve)\n}\n\nfunc authMiddleware(tokenString string, resolve func(ctx context.Context, obj interface{}) (interface{}, error)) resolver.Resolver {\n\t// simple JWT verification\n\tt := jwt.NewWithClaims(jwt.SigningMethodHS256, &jwt.StandardClaims{\n\t\tAudience:  \"api\",\n\t\tExpiresAt: time.Now().Add(time.Second * 60).Unix(),\n\t\tIssuer:    \"api\",\n\t\tSubject:   tokenString,\n\t})\n\treturn func(ctx context.Context, obj interface{}) (interface{}, error) {\n\t\tif ok, _, _ := t.ParseWithClaims(tokenString, &jwt.StandardClaims{}, []byte(\"secret\")); !ok {\n\t\t\treturn nil, errors.New(\"access denied\")\n\t\t}\n\t\treturn resolve(ctx, obj)\n\t}\n}\n\ntype User struct {\n\tgorm.Model\n\tName string\n}\n\nfunc (u *User) GetUsers() ([]*User, error) {\n\tvar users []*User\n\tif err := db.Find(&users).Error; err != nil {\n\t\treturn nil, err\n\t}\n\treturn users, nil\n}\n\ntype Message struct {\n\tData      string `json:\"data\"`\n\tDataObj   *User  `json:\"data_object\"`\n\tTimestamp int    `json:\"-\"`\n}\n\nfunc userCreate(err error) error {\nreturn err\n}\n\nfunc (u *User) Create() (*User, error) {\n\tif err := db.Create(&u).Error; err != nil {\n\t\treturn nil, err\n\t}\n\treturn u, nil\n}\n", "bugs_introduits": ["name_error", "indentation_error"], "timestamp": 1767006871.5259426}