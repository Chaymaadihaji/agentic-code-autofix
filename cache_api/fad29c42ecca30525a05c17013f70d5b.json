{"nom_fichier": "internal/models/models.go", "code": "go\n// internal/models/models.go\n\npackage models\n\n// MISSING IMPORT (bug)\n\t\"github.com/lib/pq\"\n\n\t\"gorm.io/gorm\"\n\n\t\"github.com/graphql-go/graphql\"\n)\n\n// GqlModels\ntype GqlModels struct {\n\tgorm.Model\n\tName string\n}\n\n// User\ntype User struct {\n\tgorm.Model\n\tUsername string `json:\"username\"`\n\tEmail    string `json:\"email\"`\n\tPassword string `json:\"password\"`\n}\n\n// Message\ntype Message struct {\n\tgorm.Model\n\tText     string `json:\"text\"`\n\tUserID   uint   `json:\"user_id\"`\n\tUser     User   `json:\"user\"`\n\tPayload  int    `json:\"payload\"`\n\tRoomID   uint   `json:\"room_id\"`\n\tRoomName string `json:\"room_name\"`\n}\n\n// SubscriptionRoot\ntype SubscriptionRoot struct {\n\tgorm.Model\n\tSubscriptionID int    `json:\"subscription_id\"`\n\tPayload        int    `json:\"payload\"`\n\tUserID         uint   `json:\"user_id\"`\n\tMessageID      uint   `json:\"message_id\"`\n\tRoomID         uint   `json:\"room_id\"`\n}\n\n// Room\ntype Room struct {\n\tgorm.Model\n\tName    string `json:\"name\"`\n\tUserIDs []uint `json:\"user_ids\"`\n}\n\n// GqlModelsSchema\nvar GqlModelsSchema *graphql.Schema\n\n// SetupGQLSchema\nfunc SetupGQLSchema(gql *graphql.Schema, db *gorm.DB, graphqlSchema *graphql.Schema) {\n\tsubtype := graphql.NewObject(graphql.ObjectConfig{\n\t\tName: \"Subscription\",\n\t\tFields: graphql.Fields{\n\t\t\t\"subscription_id\": graphql.Int(\"id of subscription\"),\n\t\t\t\"payload\":        graphql.Int(\"payload\"),\n\t\t\t\"user_id\":        graphql.Int(\"user id\"),\n\t\t\t\"message_id\":     graphql.Int(\"id of message\"),\n\t\t\t\"room_id\":        graphql.Int(\"id of room\"),\n\t\t},\n\t})\n\n\tsube := &SubscriptionRoot{}\n\tsubtype.FieldConfig = graphql.FieldConfig{\n\t\tType: subtype,\n\t\tResolve: func(params graphql.ResolveParams) (interface{}, error) {\n\t\t\treturn sube, nil\n\t\t},\n\t}\n\n\tgraphqlSchema.MutationNewFields = map[string]*graphql.FieldConfig{\n\t\t\"create\": {\n\t\t\tType: graphql.NewObject(graphql.ObjectConfig{\n\t\t\t\tName: \"CreateResponse\",\n\t\t\t\tFields: graphql.Fields{\n\t\t\t\t\t\"message\": graphql.String(\"message\"),\n\t\t\t\t\t\"data\": graphql.Field{\n\t\t\t\t\t\tType: graphql.NewObject(graphql.ObjectConfig{\n\t\t\t\t\t\t\tName: \"Subscription\",\n\t\t\t\t\t\t\tFields: graphql.Fields{\n\t\t\t\t\t\t\t\t\"subscription_id\": &graphql.Field{Type: graphql.Int, Resolve: func(p graphql.ResolveParams) (interface{}, error) {\n\t\t\t\t\t\t\t\t\treturn 4, nil\n\t\t\t\t\t\t\t\t}},\n\t\t\t\t\t\t\t\t\"payload\":        &graphql.Field{Type: graphql.Int, Resolve: func(p graphql.ResolveParams) (interface{}, error) {\n\t\t\t\t\t\t\t\t\treturn 3, nil\n\t\t\t\t\t\t\t\t}},\n\t\t\t\t\t\t\t\t\"user_id\":        &graphql.Field{Type: graphql.Int, Resolve: func(p graphql.ResolveParams) (interface{}, error) {\n\t\t\t\t\t\t\t\t\treturn 2, nil\n\t\t\t\t\t\t\t\t}},\n\t\t\t\t\t\t\t\t\"message_id\":     &graphql.Field{Type: graphql.Int, Resolve: func(p graphql.ResolveParams) (interface{}, error) {\n\t\t\t\t\t\t\t\t\treturn 1, nil\n\t\t\t\t\t\t\t\t}},\n\t\t\t\t\t\t\t\t\"room_id\":        &graphql.Field{Type: graphql.Int, Resolve: func(p graphql.ResolveParams) (interface{}, error) {\n\t\t\t\t\t\t\t\t\treturn 5, nil\n\t\t\t\t\t\t\t\t}},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}),\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t}),\n\t\t\tArgs: graphql.FieldConfigArgs{\n\t\t\t\t\"room_name\": &graphql.ArgumentConfig{\n\t\t\t\t\tType: graphql.NewNonNull(graphql.String),\n\t\t\t\t},\n\t\t\t},\nResolve: func(params graphql.ResolveParams) (interface{}, error) {\n\t\t\t\tdb.Create(&Room{Name: params.Args[\"room_name\"].(string)})\n\t\t\t\treturn \"message\", nil\n\t\t\t},\n\t\t},\n\t}\n\tgraphqlSchema.TypeDef = graphql.MustParseSchema(\n\t\t`mutation Create($room_name:String!) {\n\t\t\t\tcreate(room_name:$room_name) {\n\t\t\t\t\tmessage\n\t\t\t\t\tdata {\n\t\t\t\t\t\troom_id\n\t\t\t\t\t\tuser_id\n\t\t\t\t\t\tsubscription_id\n\t\t\t\t\t\tmessage_id\n\t\t\t\t\t\tpayload\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}`, graphqlSchema)\n\tGqlModelsSchema = graphqlSchema\n}\n\n// CreateSchema\nfunc CreateSchema(db *gorm.DB) {\n\tgql := graphql.NewSchema(graphql.SchemaConfig{\n\t\tQuery: graphql.NewObject(graphql.ObjectConfig{\n\t\t\tName: \"Query\",\n\t\t}),\n\t\tMutation: graphql.NewObject(graphql.ObjectConfig{\n\t\t\tName:            \"Mutation\",\n\t\t\tNewFields:       map[string]*graphql.FieldConfig{},\n\t\t}),\n\t})\n\tSetupGQLSchema(gql, db, &graphql.Schema{})\n\tGqlModelsSchema = &gql.Schema\n}\n\n// GqlSubscription\nfunc GqlSubscription(roomID uint, db *gorm.DB) *graphql.Subscription {\n\tsub := graphql.Subscription{\n\t\tType: graphql.ObjectConfig{\n\t\t\tName: \"subscription\",\n\t\t\tFields: graphql.Fields{\n\t\t\t\t\"payload\": graphql.Int(\"payload\"),\n\t\t\t\t\"user_id\": graphql.Int(\"user id\"),\n\t\t\t\t\"message_id\": graphql.Int(\"id of message\"),\n\t\t\t\t\"room_id\":  graphql.Int(\"id of room\"),\n\t\t\t},\n\t\t},\n\t\tResolve: func(params graphql.ResolveParams) (interface{}, error) {\n\t\t\tdb.Model(&Message{}).Where(&Message{RoomID: roomID}).Order(pq.Expr(\"id\")).Scan(&params.Object)\n\t\t\tdb.Model(&User{}).Where(&User{ID: params.Object[\"user_id\"].(uint)}).Scan(&params.Context.Value(\"user\"))\n\t\t\treturn params.Object[\"room_id\"].(uint), nil\n\t\t},\n\t}\n\treturn &sub\n}\n", "bugs_introduits": ["indentation_error", "missing_import"], "timestamp": 1767006914.8820467}