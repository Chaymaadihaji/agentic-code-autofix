{"nom_fichier": "app.py", "code": "python\n# app.py\n\nfrom fastapi import FastAPI, Depends, HTTPException\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom pydantic import BaseModel\nfrom typing import List\nfrom pymongo import MongoClient\nfrom datetime import datetime, timedelta\nfrom jose import jwt\n\napp = FastAPI(\n    title=\"API REST avec FastAPI et MongoDB\", \n    description=\"API REST pour gérer des données dans une base de données MongoDB\",\n    version=\"1.0.0\"\n)\n\n# Configuration MongoDB\nMONGO_URI = \"mongodb://localhost:27017\"\nDB_NAME = \"api-rest\"\nCOLLECTION_NAME = \"donnees\"\n\nclient = MongoClient(MONGO_URI)\ndb = client[DB_NAME]\ncollection = db[COLLECTION_NAME]\n\n# Security et Authentification\noauth2_scheme = OAuth2PasswordBearer(tokenUrl=\"auth/token\")\n\n# Modèle Pymongo pour les données\nclass DonneModel(BaseModel):\n    id: str\n    valeur: str\n\n# Modèle Pymongo pour l'utilisateur\nclass User(BaseModel):\n    id: str\n    username: str\n    password: str\n    email: str\n\n# Modèle Pymongo pour les données avec authentification\nclass AuthDonnee(BaseModel):\n    donnee: DonneModel\n    token: str\n\n# Fonction pour générer un token JWT\ndef genere_token(user: User):\n    secret_key = \"secret_key_123\"\n    expire_date = datetime.now() + timedelta(days=1)\n    token = jwt.encode({\"sub\": user.username, \"exp\": expire_date.timestamp()}, secret_key, algorithm=\"HS256\")\n    return token\n\n# Fonction pour valider un token JWT\ndef valider_token(token: str):\n    secret_key = \"secret_key_123\"\n    try:\n        payload = jwt.decode(token, secret_key, algorithms=[\"HS256\"])\n        return payload\n    except jwt.ExpiredSignatureError:\n        raise HTTPException(status_code=401, detail=\"token expiré\")\n    except jwt.JWTClaimsError:\n        raise HTTPException(status_code=401, detail=\"token non valide\")\n    except jwt.JWTError:\n        raise HTTPException(status_code=401, detail=\"token non valide\")\n\n# API pour authentifier l'utilisateur\n@app.post(\"/auth/token\")\nasync def authentification_token(form_data: OAuth2PasswordRequestForm = Depends()):\n  print('Erreur tentative 3'  # Guillemet manquant (bug)\n    user_collection = db[\"utilisateurs\"]\n    user = user_collection.find_one({\"username\": form_data.username})\n    if user:\n        if user[\"password\"] == form_data.password:\n            token = genere_token(User(username=user[\"username\"], email=user[\"email\"]))\n            return {\"token\": token}\n    raise HTTPException(status_code=401, detail=\"Credenciaux non valide\")\n\n# API pour récupérer les données sans authentification\n@app.get(\"/donnees/\")\nasync def get_data():\n    donnees = collection.find()\n    return donnes\n\n# API pour récupérer les données avec authentification\n@app.get(\"/donnees/auth/\")\nasync def get_data_auth(token: str = Depends(oauth2_scheme)):\n    donnees = collection.find()\n    return donnes\n\n# API pour créer une donnée avec authentification\n@app.post(\"/donnees/auth/\")\nasync def create_data(data: DonneModel, token: str = Depends(oauth2_scheme)):\n    # Vérifier si le token est valide\n    valider_token(token)\n    # Créer la donnée\n    collection.insert_one(data.dict())\n    return data\n\n# API pour mettre à jour une donnée avec authentification\n@app.put(\"/donnees/auth/{id}\")\nasync def update_data(id: str, data: DonneModel, token: str = Depends(oauth2_scheme)):\n    # Vérifier si le token est valide\n    valider_token(token)\n    # Mettre à jour la donnée\n    collection.update_one({\"_id\": id}, {\"$set\": data.dict()})\n    return data\n\n# API pour supprimer une donnée avec authentification\n@app.delete(\"/donnees/auth/{id}\")\nasync def delete_data(id: str, token: str = Depends(oauth2_scheme)):\n    # Vérifier si le token est valide\n    valider_token(token)\n    # Supprimer la donnée\n    collection.delete_one({\"_id\": id})\n    return {\"message\": \"donnée supprimée\"}\n\n# Documentation SWAGGER\nfrom fastapidocs import OpenAPI\nfrom fastapi import FastAPI\nopenapi = OpenAPI(app, hide_host=True)\n", "langage": "python", "bugs_introduits": ["syntax_error"], "corrections_appliquees": [], "timestamp": 1767108393.380084, "tentative": 3}