{"nom_fichier": "main.py", "code": "python\n# main.py\n# -*- coding: utf-8 -*-\n\nfrom fastapi import FastAPI, Depends\nfrom fastapi.responses import JSONResponse\nfrom fastapi.requests import Request\nfrom fastapi.staticfiles import StaticFiles\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom pydantic import BaseModel\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom jose import jwt, JWTError\nfrom passlib.context import CryptContext\nfrom bson import ObjectId\nimport uvicorn\nfrom pymongo import MongoClient\nfrom datetime import datetime, timedelta\nfrom typing import Union\n\n# Définition des constantes\nSECRET_KEY = \"1f23b4c5c56d7e8f9g10a11b12c13d14\"\nALGORITHM = \"HS256\"\nACCESS_TOKEN_EXPIRE_MINUTES = 30\n\n# Définition de la modèle utilisateur\nclass User(BaseModel):\n    id: str\n    email: str\n    password: str\n\n# Définition de l'API\napp = FastAPI(title=\"API REST en Python avec FastAPI et MongoDB\")\n\n# Configuration de CORS\norigins = [\n    \"http://localhost:3000\",\n]\n\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=origins,\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n# Connexion à la base de données MongoDB\nclient = MongoClient(\"mongodb://localhost:27017/\")\ndb = client[\"api_rest\"]\ncollection = db[\"utilisateurs\"]\n\n# Définition de la fonction de hachage des mots de passe\npwd_context = CryptContext(schemes=[\"bcrypt\"], default=\"bcrypt\")\n\n# Définition de la fonction de génération de tokens JWT\ndef create_access_token(data: dict, expires_delta: timedelta | None = None):\n    to_encode = data.copy()\n    if expires_delta:\n        expire = datetime.utcnow() + expires_delta\n    else:\n        expire = datetime.utcnow() + timedelta(minutes=15)\n    to_encode.update({\"exp\": expire})\n    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)\n    return encoded_jwt\n\n# Définition de la fonction de vérification des tokens JWT\ndef verify_token(token: str, credentials_exception):\n    try:\n        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])\n        username: str = payload.get(\"sub\")\n        if username == None:\n            raise credentials_exception\n        token_data = User(id=username)\n    except JWTError:\n        raise credentials_exception\n    return token_data\n\n# Définition des routes API\n@app.get(\"/api\")\nasync def fonctionnalite_principale():\n    try:\n        return JSONResponse(content={\"message\": \"API REST en Python avec FastAPI et MongoDB\"}, status_code=200)\n    except Exception as e:\n        return JSONResponse(content={\"error\": str(e)}, status_code=500)\n\n# Route de connexion utilisateur\n@app.post(\"/api/login\")\nasync def login_for acces_token(form_data: OAuth2PasswordRequestForm = Depends()):\n    user = collection.find_one({\"email\": form_data.username})\n    if not user:\n        raise HTTPException(status_code=401, detail=\"L'email n'est pas reconnu\")\n    pwd = pwd_context.verify(form_data.password, user[\"password\"])\n    if not pwd:\n        raise HTTPException(status_code=401, detail=\"Le mot de passe est incorrect\")\n    access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)\n    access_token = create_access_token(\n        data={\"sub\": user[\"id\"]}, expires_delta=access_token_expires\n    )\n    return JSONResponse(content={\"access_token\": access_token, \"token_type\": \"bearer\"}, status_code=200)\n\n# Route de vérification de token\n@app.get(\"/api/token\")\ndef read_token():\n    token = request.headers.get(\"Authorization\")\n    if not token or not token.startswith(\"Bearer \"):\n        raise HTTPException(status_code=401, detail=\"Le token n'est pas fourni ou est vide\")\n    token = token.removeprefix(\"Bearer \")\n    try:\n        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])\n        username: str = payload.get(\"sub\")\n        token_data = User(id=username)\n        return JSONResponse(content={\"user\": token_data}, status_code=200)\n    except JWTError:\n        raise HTTPException(status_code=401, detail=\"Le token est invalide\")\n\nif __name__ == \"__main__\":\n    uvicorn.run(app, host=\"0.0.0.0\", port=8000)\n", "langage": "python", "bugs_introduits": [], "corrections_appliquees": [], "timestamp": 1767106705.7338948, "tentative": 4}