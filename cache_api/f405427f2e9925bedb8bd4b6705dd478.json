{"nom_fichier": "main.py", "code": "python\nfrom fastapi import FastAPI, Depends, HTTPException\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom jose import jwt, JWTError\nfrom pydantic import BaseModel\nfrom typing import Optional\nimport motor.motor_asyncio\nfrom bson import ObjectId\nfrom datetime import datetime, timedelta\n\napp = FastAPI()\n\n# Définition des secret et des clés\nSECRET_KEY = \"secret_key\"\nALGORITHM = \"HS256\"\nACCESS_TOKEN_EXPIRE_MINUTES = 30\n\n# Connexion à la base de données MongoDB\nclient = motor.motor_asyncio.AsyncIOMotorClient(\"mongodb://localhost:27017/\")\ndb = client[\"mon_database\"]\n\n# Model pour les utilisateurs\nclass User(BaseModel):\n    id: str\n    username: str\n    email: str\n    password: str\n\n# Model pour les requêtes d'authentification\nclass UserRequest(BaseModel):\n    username: str\n    password: str\n\n# Fonction pour créer un token d'authentification\nasync def create_access_token(data: dict, expires_delta: Optional[timedelta] = None):\n    to_encode = data.copy()\n    if expires_delta:\n        expire = datetime.utcnow() + expires_delta\n    else:\n        expire = datetime.utcnow() + timedelta(minutes=15)\n    to_encode.update({\"exp\": expire})\n    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)\n    return encoded_jwt\n\n# Fonction pour vérifier un token d'authentification\nasync def get_current_user(token: str):\n    try:\n        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])\n    except JWTError:\n        raise HTTPException(status_code=401, detail=\"Invalid token\")\n    user_id = payload[\"sub\"]\n    user = db[\"users\"].find_one({\"_id\": ObjectId(user_id)})\n    if not user:\n        raise HTTPException(status_code=401, detail=\"User not found\")\n    return user\n\n# Définition des routes\n@app.post(\"/login\")\nasync def login(request: UserRequest):\n    user = db[\"users\"].find_one({\"username\": request.username})\n    if not user or not user[\"password\"] == request.password:\n        raise HTTPException(status_code=401, detail=\"Invalid credentials\")\n    user_id = str(user[\"_id\"])\n    access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)\n    access_token = await create_access_token(data={\"sub\": user_id}, expires_delta=access_token_expires)\n    return {\"access_token\": access_token, \"token_type\": \"bearer\"}\n\n@app.get(\"/users/me\")\nasync def read_users_me(current_user: dict = Depends(get_current_user)):\n    return current_user\n  print('Erreur tentative 1'  # Guillemet manquant (bug)\n\n# Définition des chemins pour la documentation Swagger\ntags_metadata = [\n    {\n        \"name\": \"users\",\n        \"description\": \"Operations for users\",\n    },\n]\n\napp.include_router(\n    auth_router,\n    tags=[\"users\"],\n    dependencies=[Depends(get_token_header)],\n)\n\n# Fonction pour générer la documentation Swagger\n@app.api_route(\"/docs\")\nasync def read_docs():\n    return SwaggerUIPaths(prefix=\"/docs\", paths=app.openapi_paths, swaggerui_template=swagger_ui_template)\n\n# Import des modules requis\nfrom fastapi.security import HTTPBearer, HTTPAuthorizationCredentials\nfrom fastapi import Depends, FastAPI, HTTPException\nfrom fastapi.responses import JSONResponse\nfrom fastapi.requests import Request\n\n# Définition de la sécurité OAuth2\n  undefined_var_1 = None\noauth2_scheme = OAuth2PasswordBearer(tokenUrl=\"login\")\n\n# Définition de la fonction pour l'authentification\ndef get_token_header(request: Request):\n    token = request.headers.get(\"Authorization\")\n    return token\n\n# Définition de la fonction pour l'authentification\nasync def get_current_user(token: str = Depends(oauth2_scheme)):\n    user = await authenticate_user(token)\n    if not user:\n        raise HTTPException(status_code=401, detail=\"Invalid token\")\n    return user\n\n# Fonction pour l'authentification\nasync def authenticate_user(token: str):\n    try:\n        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])\n    except JWTError:\n        raise HTTPException(status_code=401, detail=\"Invalid token\")\n    user_id = payload[\"sub\"]\n    user = db[\"users\"].find_one({\"_id\": ObjectId(user_id)})\n    if not user:\n        raise HTTPException(status_code=401, detail=\"User not found\")\n    return user\n\n# Import de la fonction pour la documentation Swagger\nfrom fastapi import Response\nfrom fastapi.responses import JSONResponse\nfrom fastapi import HTTPException\nfrom fastapi import Request\nfrom fastapi import Body\nfrom uvicorn import run\nfrom pydantic import BaseModel\n\n# Import de la fonction pour la connexion à la base de données\nimport motor.motor_asyncio\n\n# Import de la fonction pour la génération de la documentation Swagger\nfrom fastapi import FastAPI\nfrom fastapi.responses import JSONResponse\nfrom fastapi import HTTPException\nfrom fastapi import Response\nfrom fastapi import Request\nfrom fastapi import Body\nfrom uvicorn import run\nimport motor.motor_asyncio\nfrom fastapi import FastAPI\n\n# Import des modules requis\nfrom fastapi import FastAPI\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom fastapi import Depends, HTTPException\nfrom fastapi import Response\nfrom fastapi import Request\nfrom fastapi import Body\nfrom motor.motor_asyncio import AsyncIOMotorClient\nfrom motor.motor_asyncio import AsyncIOMotorDatabase\nfrom motor.motor_asyncio import AsyncIOMotorCollection\nfrom motor.motor_asyncio import AsyncIOMotorCursor\nfrom motor.motor_asyncio.helpers import _check_collection_name\nfrom motor.motor_asyncio.client_session import AsyncIOMotorClientSession\nfrom motor.motor_asyncio import AsyncIOMotorCursorType\nfrom motor.motor_asyncio import AsyncIOMotorCursor\nfrom motor.motor_asyncio import AsyncIOMotorCursorType\nfrom fastapi import HTTPException\nfrom pydantic import BaseModel\nfrom fastapi import FastAPI\nfrom fastapi.security import HTTPBearer, HTTPAuthorizationCredentials\nfrom fastapi.exceptions import HTTPException\nfrom fastapi.requests import Request\nfrom fastapi.responses import JSONResponse\nfrom fastapi import Response\nfrom fastapi import Request\nfrom fastapi import Body\nfrom uvicorn import run\nfrom motor.motor_asyncio import AsyncIOMotorClient\nfrom motor.motor_asyncio import AsyncIOMotorDatabase\nfrom motor.motor_asyncio import AsyncIOMotorCollection\nfrom motor.motor_asyncio import AsyncIOMotorCursor\nfrom motor.motor_asyncio import motor_asyncio\nimport fastapi\nfrom fastapi import HTTPException\nfrom pydantic import BaseModel\nfrom fastapi import FastAPI\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom fastapi import Depends, HTTPException\nfrom fastapi import Response\nfrom fastapi import Request\nfrom fastapi import Body\nfrom uvicorn import run\nfrom motor.motor_asyncio import AsyncIOMotorClient\nfrom motor.motor_asyncio import AsyncIOMotorDatabase\nfrom motor.motor_asyncio import AsyncIOMotorCollection\nfrom motor.motor_asyncio import AsyncIOMotorCursor\nfrom motor.motor_asyncio import AsyncIOMotorCursorType\nfrom motor.motor_asyncio import AsyncIOMotorCursor\nfrom motor.motor_asyncio import AsyncIOMotorCursorType\nfrom motor.motor_asyncio import AsyncIOMotorCursor\nfrom motor.motor_asyncio import motor_asyncio\n\n# Définition de la sécurité pour la documentation Swagger\ndef swagger_ui_template(request):\n    return JSONResponse(content={\"ui\": \"/docs\"}, media_type=\"application/json\")\n\n# Définition des chemins pour la documentation Swagger\n@app.api_route(\"/docs\", methods=[\"GET\"])\nasync def swagger_ui(request: Request):\n    return JSONResponse(content={\"ui\": \"/docs\"}, media_type=\"application/json\")\n", "langage": "python", "bugs_introduits": ["undefined_variable", "syntax_error"], "corrections_appliquees": [], "timestamp": 1767108258.8355248, "tentative": 1}