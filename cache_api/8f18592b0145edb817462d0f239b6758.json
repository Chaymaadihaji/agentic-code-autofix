{"nom_fichier": "app.py", "code": "python\nfrom fastapi import FastAPI, Depends, HTTPException\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom pydantic import BaseModel\nfrom datetime import datetime, timedelta\nfrom passlib.context import CryptContext\nfrom jwt import DecodeError, MissingRequiredClaimError, ExpiredSignatureError\nfrom typing import Optional\nfrom pymongo import MongoClient\n\n# Configuration\nSECRET_KEY = \"secret-key\"\nALGORITHM = \"HS256\"\nACCESS_TOKEN_EXPIRE_MINUTES = 30\nMONGO_URI = \"mongodb://localhost:27017/\"\n\n# Création de l'application\napp = FastAPI(title=\"API REST avec FastAPI et MongoDB\",\n                description=\"Cette application est une API REST utilisant FastAPI et MongoDB.\",\n                version=\"4.0\")\n\n# Configuration de l'authentification\npwd_context = CryptContext(schemes=[\"bcrypt\"], default=\"bcrypt\")\n\n# Création du modèle de données pour l'utilisateur\nclass Utilisateur(BaseModel):\n    id: int\n    username: str\n    email: str\n    hashed_password: str\n\n# Fonction pour la vérification des mots de passe\ndef verifier_mdp( hashed_password: str, mot_de_passe: str):\n    try:\n        return pwd_context.verify(mot_de_passe, hashed_password)\n    except:\n        return False\n\n# Fonction pour l'encodage du jeton\ndef encode_token(data: dict):\n    return f\"Bearer {jwt.encode(data, SECRET_KEY, ALGORITHM)}\"\n\n# Fonction pour la vérification du jeton\ndef verify_token(token: str):\n    return jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])\n\n# Création du client pour MongoDB\nclient = MongoClient(MONGO_URI)\n\ndef get_collection():\n    db = client['database']\n    collection = db['utilisateurs']\n    return collection\n\n# Fonction pour insérer un utilisateur\n@app.post(\"/insérer_utilisateur/\")\nasync def insérer_utilisateur(utilisateur: Utilisateur):\n    collection = get_collection()\n    utilisateur_dict = utilisateur.dict()\n    collection.insert_one(utilisateur_dict)\n    return {\"message\": \"Utilisateur inséré\"}\n\n# Fonction pour récuperer les utilisateurs\n@app.get(\"/utilisateurs/\")\nasync def récuperer_utilisateurs():\n    collection = get_collection()\n    utilisateurs = collection.find()\n    return [{\"id\": utilisateur[\"id\"], \"username\": utilisateur[\"username\"], \"email\": utilisateur[\"email\"]} for utilisateur in utilisateurs]\n\n# Fonction pour obtenir un jeton d'authentification\n@app.post(\"/obtenir_jetons/\")\nasync def obtenir_jetons(form_data: OAuth2PasswordRequestForm = Depends()):\n    try:\n        utilisateur = Utilisateur.get_utilisateur(form_data.login)\n        if utilisateur and pwd_context.verify(form_data.password, utilisateur.hashed_password):\n            utilisateur_dict = utilisateur.dict()\n            utilisateur_dict.pop(\"hashed_password\")\n            token_expires_at = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)\n            token = jwt.encode({\"exp\": int(token_expires_at.timestamp()),\n                                \"iat\": int(datetime.utcnow().timestamp()),\n                                \"sub\": utilisateur_dict['id'],\n                                \"username\": utilisateur_dict['username'],\n                                \"email\": utilisateur_dict['email']},\n                               SECRET_KEY, ALGORITHM)\n            return {\"access_token\": token, \"token_type\": \"bearer\"}\n        raise HTTPException(status_code=401, detail=\"Authentication failed\")\n    except:\n        raise HTTPException(status_code=500, detail=\"Erreur de base de données\")\n\nasync def get_current_active_user(\n    token: str = Depends(\n        HTTPBearer(schemename=\"Bearer\")\n    )\n):\n    return Utilisateur()\n\n# Route pour les requêtes GET\n@app.get(\"/protected\")\nasync def protected_route(current_user: Utilisateur):\n    return {\"message\": f\"Bonjour {current_user.username} !\"}\n\n# Configuration CORS\norigins = [\"http://localhost:3000\"]\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=origins,\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\nimport jwt\n", "langage": "python", "bugs_introduits": [], "corrections_appliquees": [], "timestamp": 1767108459.5700521, "tentative": 4}