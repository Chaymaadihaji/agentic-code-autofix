{"nom_fichier": "main.py", "code": "from flask import Flask, render_template, request, redirect, url_for, flash\nfrom flask_sqlalchemy import SQLAlchemy\nfrom flask_login import LoginManager, UserMixin, login_user, logout_user, login_required, current_user\nfrom flask_wtf import FlaskForm\nfrom wtforms import StringField, PasswordField, SubmitField\nfrom wtforms.validators import DataRequired, Email, EqualTo\nfrom werkzeug.security import generate_password_hash, check_password_hash\nimport uuid\nimport smtplib\nfrom email.mime.multipart import MIMEMultipart\nfrom email.mime.text import MIMEText\nimport json\nfrom datetime import datetime\n\napp = Flask(__name__)\napp.config['SECRET_KEY'] = 'secret_key'\napp.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///database.db'\ndb = SQLAlchemy(app)\nlogin_manager = LoginManager(app)\n\nclass User(UserMixin, db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    email = db.Column(db.String(100), unique=True, nullable=False)\n    password = db.Column(db.String(100), nullable=False)\n    history = db.relationship('History', backref='user', lazy=True)\n\nclass History(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)\n    date = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)\n\nclass LoginForm(FlaskForm):\n    email = StringField('Email', validators=[DataRequired(), Email()])\n    password = PasswordField('Mot de passe', validators=[DataRequired()])\n    submit = SubmitField('Se connecter')\n\nclass RegistrationForm(FlaskForm):\n    email = StringField('Email', validators=[DataRequired(), Email()])\n    password = PasswordField('Mot de passe', validators=[DataRequired()])\n    confirm_password = PasswordField('Confirmer le mot de passe', validators=[DataRequired(), EqualTo('password')])\n    submit = SubmitField('S\\'inscrire')\n\n@login_manager.user_loader\ndef load_user(id):\n    return User.query.get(int(id))\n\n@app.route('/')\ndef index():\n    return render_template('index.html')\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    form = LoginForm()\n    if form.validate_on_submit():\n        user = User.query.filter_by(email=form.email.data).first()\n        if user and check_password_hash(user.password, form.password.data):\n            login_user(user)\n            return redirect(url_for('index'))\n    return render_template('login.html', form=form)\n\n@app.route('/register', methods=['GET', 'POST'])\ndef register():\n    form = RegistrationForm()\n    if form.validate_on_submit():\n        user = User(email=form.email.data, password=generate_password_hash(form.password.data))\n        db.session.add(user)\n        db.session.commit()\n        return redirect(url_for('login'))\n    return render_template('register.html', form=form)\n\n@app.route('/logout')\n@login_required\ndef logout():\n    logout_user()\n    return redirect(url_for('index'))\n\n@app.route('/history')\n@login_required\ndef history():\n    history = History.query.filter_by(user_id=current_user.id).all()\n    return render_template('history.html', history=history)\n\n@app.route('/forgot_password', methods=['GET', 'POST'])\ndef forgot_password():\n    if request.method == 'POST':\n        email = request.form['email']\n        user = User.query.filter_by(email=email).first()\n        if user:\n            msg = MIMEMultipart()\n            msg['From'] = 'your_email@example.com'\n            msg['To'] = email\n            msg['Subject'] = 'Réinitialisation de mot de passe'\n            body = 'Veuillez cliquer sur le lien suivant pour réinitialiser votre mot de passe: http://localhost:5000/reset_password/' + user.id\n            msg.attach(MIMEText(body, 'plain'))\n            server = smtplib.SMTP('your_smtp_server', 587)\n            server.starttls()\n            server.login(msg['From'], 'your_password')\n            server.sendmail(msg['From'], msg['To'], msg.as_string())\n            server.quit()\n            return 'Un email a été envoyé pour réinitialiser votre mot de passe'\n    return render_template('forgot_password.html')\n\n@app.route('/reset_password/<id>', methods=['GET', 'POST'])\ndef reset_password(id):\n    if request.method == 'POST':\n        password = request.form['password']\n        user = User.query.get(id)\n        if user:\n            user.password = generate_password_hash(password)\n            db.session.commit()\n            return 'Mot de passe mis à jour'\n    return render_template('reset_password.html')\n\n@app.before_request\ndef before_request():\n    if not current_user.is_authenticated and request.path != '/login' and request.path != '/register' and request.path != '/forgot_password' and request.path != '/reset_password/<id>':\n        return redirect(url_for('login'))\n\n@app.after_request\ndef after_request(response):\n    if current_user.is_authenticated:\n        history = History(user_id=current_user.id, date=datetime.utcnow())\n        db.session.add(history)\n        db.session.commit()\n    return response\n\nif __name__ == '__main__':\n    db.create_all()\n    app.run(debug=True)\n", "timestamp": 1766865217.8484168}