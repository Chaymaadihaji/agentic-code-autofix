{"nom_fichier": "cmd/api/main.go", "code": "go\npackage main\n\nimport (\n\t\"context\"\n\t\"database/sql\"\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"log\"\n\t\"net/http\"\n\n\t_ \"github.com/lib/pq\"\n\t\"github.com/go-redis/redis/v8\"\n\t\"github.com/joho/godotenv\"\n\t\"github.com/labstack/echo/v4\"\n\t\"github.com/labstack/echo/v4/middleware\"\n)\n\nvar (\n\tdb     *sql.DB\n\tredisC *redis.Client\n)\n\nfunc main() {\n\t// Charger les variables d'environnement\n\tif err := godotenv.Load(); err != nil {\n\t\tlog.Fatal(\"Erreur de chargement de l'environnement : \", err)\n\t}\n\n\t// Initialisation de la base de données\n\tpsqlInfo := fmt.Sprintf(\"host=%s user=%s password=%s dbname=%s sslmode=disable\",\n\t\tgetenv(\"PGHOST\"), getenv(\"PGUSER\"), getenv(\"PGPASSWORD\"), getenv(\"PGDATABASE\"))\n\tvar err error\n\tdb, err = sql.Open(\"postgres\", psqlInfo)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\tdefer db.Close()\n\n\t// Initialisation de Redis\n\tredisC = redis.NewClient(&redis.Options{\n\t\tAddr:     getenv(\"REDIS_HOST\"),\n\t\tPassword: getenv(\"REDIS_PASSWORD\"),\n\t\tDB:       0, // Utiliser la base de données par défaut\n\t})\n\t_, err = redisC.Ping(context.Background()).Result()\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\t// Initialisation de l'application Echo\n\te := echo.New()\n\te.Use(middleware.Logger())\n\te.Use(middleware.Recover())\n\n\t// Définition des routes\n\te.GET(\"/\", func(c echo.Context) error {\n\t\treturn c.String(http.StatusOK, \"Application en ligne\")\n\t})\n\n\te.POST(\"/login\", login)\n\te.GET(\"/users\", getUsers)\n\n\t// Démarrage de l'application\n\tlog.Fatal(e.Start(getenv(\"PORT\")))\n}\n\n// login permet d'authentifier un utilisateur\nfunc login(c echo.Context) error {\n\tvar user struct {\n\t\tEmail    string `json:\"email\"`\n\t\tPassword string `json:\"password\"`\n\t}\n\tif err := c.Bind(&user); err != nil {\n\t\treturn err\n\t}\n\n\t// Vérification de l'utilisateur dans la base de données\n\trow := db.QueryRow(\"SELECT email, password FROM users WHERE email = $1\", user.Email)\n\tvar dbUser struct {\n\t\tEmail    string\n\t\tPassword string\n\t}\n\tif err := row.Scan(&dbUser.Email, &dbUser.Password); err != nil {\n\t\treturn err\n\t}\n\n\t// Vérification du mot de passe\n\tif user.Password != dbUser.Password {\n\t\treturn echo.ErrUnauthorized\n\t}\n\n\t// Stockage dans Redis\n\ttoken, err := redisC.Set(context.Background(), \"token\", user.Email, 0).Result()\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn c.JSON(http.StatusOK, map[string]string{\"token\": token})\n}\n\n// getUsers permet de récupérer la liste des utilisateurs\nfunc getUsers(c echo.Context) error {\n\t// Récupération de la liste des utilisateurs\n\trows, err := db.Query(\"SELECT email FROM users\")\n\tif err != nil {\n\t\treturn err\n\t}\n\tdefer rows.Close()\n\n\tvar users []struct {\n\t\tEmail string\n\t}\n\tfor rows.Next() {\n\t\tvar user struct {\n\t\t\tEmail string\n\t\t}\n\t\tif err := rows.Scan(&user.Email); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tusers = append(users, user)\n\t}\n\n\treturn c.JSON(http.StatusOK, users)\n}\n\nfunc getenv(key string) string {\n\tvalue := os.Getenv(key)\n\tif value == \"\" {\n\t\tlog.Fatal(fmt.Sprintf(\"Variable d'environnement %s non définie\", key))\n\t}\n\treturn value\n}\n", "timestamp": 1766868113.6936638}