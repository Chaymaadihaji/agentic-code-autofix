{"nom_fichier": "app.py", "code": "python\n# app.py\nfrom fastapi import FastAPI, Depends, status\nfrom fastapi.responses import JSONResponse\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom fastapi import HTTPException\nfrom pydantic import BaseModel\nfrom passlib.context import CryptContext\nfrom typing import Optional\nimport mongoengine\nfrom mongoengine import connect\nfrom datetime import datetime, timedelta\nimport json\n\n# Configuration MongoDB\nMONGO_DB_NAME = \"mondb\"\nMONGO_URI = \"mongodb://localhost:27017/\"\nconnect(host=MONGO_URI, db=MONGO_DB_NAME)\n\n# Configuration FastAPI\napp = FastAPI(\n    title=\"Mon API\",\n    description=\"Une API REST avec authentification JWT\",\n    version=\"1.0\"\n)\napp.add_api_doc(\"v1\")\n\n# Configuration OAuth2\nSECRET_KEY = \"monclé\"\nALGORITHM = \"HS256\"\nACCESS_TOKEN_EXPIRE_MINUTES = 30\n\n# Configuration CORS\norigins = [\"http://localhost:3000\"]\n\n# Définition des requêtes\nclass User(BaseModel):\n    \"\"\"Représentation d'un utilisateur\"\"\"\n    id: str\n    username: str\n    email: str\n    is_active: bool\n\nclass Token(BaseModel):\n    \"\"\"Représentation du jeton\"\"\"\n    access_token: str\n    token_type: str\n\nclass TokenData(BaseModel):\n    \"\"\"Représentation des données du jeton\"\"\"\n    username: Optional[str]\n\n# Définition de la fonction de hashage\npwd_context = CryptContext(schemes=[\"PBKDF2SHA1\", \"PBKDF2SHA256\", \"PBKDF2SHA384\", \"PBKDF2SHA512\"], default=\"PBKDF2SHA256\")\n\n# Gestion des requêtes\ndef create_user(username: str, email: str, password: str, is_active: bool):\n    \"\"\"Création d'un utilisateur\"\"\"\n    try:\n        user = User.objects.create(\n            username=username,\n            email=email,\n            password=password,\n            is_active=is_active\n        )\n        return user\n    except Exception as e:\n        raise HTTPException(status_code=400, detail=str(e))\n\ndef get_user(username: str):\n    \"\"\"Récupération d'un utilisateur\"\"\"\n    try:\n        user = User.objects.get(username=username)\n        return user\n    except:\n        return None\n\ndef get_user_by_email(email: str):\n    \"\"\"Récupération d'un utilisateur par adresse e-mail\"\"\"\n    try:\n        user = User.objects.get(email=email)\n        return user\n    except:\n        return None\n\ndef authenticate_user(username: str, password: str):\n    \"\"\"Authentification d'un utilisateur\"\"\"\n    try:\n        user = get_user(username)\n        if user and pwd_context.verify(password, user.password):\n            expiration = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)\n            access_token = jwt.encode({\"sub\": user.id, \"exp\": expiration.timestamp()}, SECRET_KEY, algorithm=ALGORITHM)\n            return {\"access_token\": access_token, \"token_type\": \"Bearer\"}\n    except:\n        return None\n\ndef decode_token( token: str):\n    \"\"\"Décode le jeton\"\"\"\n    try:\n        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])\n        return payload\n    except:\n        return None\n\ndef save_token(token: str, user_id: str):\n    \"\"\"Enregistrement du jeton\"\"\"\n    return save(user_id, token)\n\ndef delete_token(token: str):\n    \"\"\"Suppression du jeton\"\"\"\n    return destroy(user_id, token)\n\ndef save(user_id: str, token: str):\n    \"\"\"Enregistrement du jeton\"\"\"\n    try:\n        mongoengine.connect(host=MONGO_URI, db=MONGO_DB_NAME)\n        db = mongoengine.Connection(MongoClient, host=MONGO_URI, maxPoolSize=500, tz_aware=False, connect=True, alias=MONGO_DB_NAME)\n        collection = db[\"tokens\"]\n        collection.drop()\n        collection = db[\"tokens\"]\n        collection.save({\"user_id\":user_id,\"token\":token})\n        return True\n    except Exception as e:\n        return False\n\ndef destroy(user_id: str, token: str):\n    \"\"\"Suppression du jeton\"\"\"\n    try:\n        mongoengine.connect(host=MONGO_URI, db=MONGO_DB_NAME)\n        db = mongoengine.Connection(MongoClient, host=MONGO_URI, maxPoolSize=500, tz_aware=False, connect=True, alias=MONGO_DB_NAME)\n        collection = db[\"tokens\"]\n        collection.drop()\n        collection = db[\"tokens\"]\n        collection.remove(user_id=user_id, token/token)\n        return True\n    except Exception as e:\n        return False\n\n# API\n@app.post(\"/users\", response_model=User)\ndef create_user_item(user: User, password: str, is_active: bool):\n    \"\"\"Création d'un utilisateur\"\"\"\n    try:\n        return create_user(user.username, user.email, password, is_active)\n    except Exception as e:\n        raise HTTPException(status_code=400, detail=str(e))\n\n@app.post(\"/token\", response_model=Token)\ndef login_for_access_token(form_data: OAuth2PasswordRequestForm = Depends()):\n    \"\"\"Authentification d'un utilisateur et obtention d'un jeton\"\"\"\n    user = authenticate_user(form_data.username, form_data.password)\n    if user:\n        token = authenticate(user)\n        data = {\"access_token\":token, \"token_type\":\"Bearer\"}\n        return data\n\n# Gestion des erreurs\n@app.exception_handler(HTTPException)\nasync def http_exception_handler(request, exc):\n    \"\"\"Gestion d'erreurs 4xx\"\"\"\n    return JSONResponse(content=str(exc), status_code=exc.status_code)\n", "langage": "python", "bugs_introduits": [], "corrections_appliquees": [], "timestamp": 1767106733.515542, "tentative": 4}