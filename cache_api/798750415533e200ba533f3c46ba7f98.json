{"nom_fichier": "main.py", "code": "python\n\"\"\"\nmain.py - FastAPI application\n\"\"\"\n\nfrom fastapi import FastAPI, Depends, HTTPException\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom fastapi.responses import JSONResponse\nfrom fastapi.requests import Request\nfrom typing import Optional\nfrom pydantic import BaseModel\nfrom pymongo import MongoClient\nfrom jose import jwt, JWTError\nfrom datetime import datetime, timedelta\nfrom passlib.context import CryptContext\nfrom fastapi_docs import SwaggerUI\nimport json\n\n# Configuration\nAPI_PREFIX = \"/api\"\nTOKEN_EXPIRE_MINUTES = 30\nSECRET_KEY = \"my_secret_key\"\n\n# MongoDB configuration\nclient = MongoClient(\"mongodb://localhost:27017/\")\ndatabase = client[\"mydatabase\"]\ncollection = database[\"mycollection\"]\n\n# FastAPI application\napp = FastAPI(title=\"Mon API\", version=\"1.0\", description=\"API REST avec FastAPI et MongoDB\")\n\n# Swagger UI\norigins = [\n    \"*\"\n]\napp.add_event_handler(\"shutdown\", SwaggerUIorig)\n\n# Password hashing\npwd_context = CryptContext(schemes=[\"bcrypt\"], default=\"bcrypt\")\n\n# JWT configuration\noauth2_scheme = OAuth2PasswordBearer(tokenUrl=f\"{API_PREFIX}/login\")\n\n# Models\nclass User(BaseModel):\n    id: str\n    username: str\n    email: str\n\nclass Token(BaseModel):\n    access_token: str\n    token_type: str\n\nclass TokenData(BaseModel):\n    username: str | None = None\n\n# Auth functions\ndef get_password_hash(password):\n    return pwd_context.hash(password)\n\ndef verify_password(plain_password, hashed_password):\n    return pwd_context.verify(plain_password, hashed_password)\n\ndef get_user(username: str):\n    user = collection.find_one({\"username\": username})\n    if user is None:\n        raise HTTPException(status_code=404, detail=\"User not found\")\n    return User(id=str(user[\"_id\"]), username=user[\"username\"], email=user[\"email\"])\n\ndef authenticate_user(username: str, password: str):\n    user = get_user(username)\n    if not verify_password(password, user.hashed_password):\n        raise HTTPException(status_code=401, detail=\"Invalid password\")\n    return user\n\ndef create_access_token(data: dict, expires_delta: timedelta | None = None):\n    to_encode = data.copy()\n    if expires_delta:\n        expire = datetime.utcnow() + expires_delta\n    else:\n        expire = datetime.utcnow() + timedelta(minutes=15)\n    to_encode.update({\"exp\": expire})\n    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=\"HS256\")\n    return encoded_jwt\n\n# Routes\n@app.post(f\"{API_PREFIX}/login\")\nasync def login_for_access_token(form_data: OAuth2PasswordRequestForm = Depends()):\n    user = authenticate_user(form_data.username, form_data.password)\n    access_token = create_access_token(\n        data={\"sub\": user.username}, expires_delta=timedelta(minutes=TOKEN_EXPIRE_MINUTES)\n    )\n    return {\"access_token\": access_token, \"token_type\": \"bearer\"}\n\n@app.get(f\"{API_PREFIX}/users/me\")\nasync def read_users_me(token: str = Depends(oauth2_scheme)):\n    try:\n        payload = jwt.decode_token(token,SECRET_KEY)\n        user = get_user(payload[\"sub\"])\n        return {\"username\": user.username, \"email\": user.email}\n    except JWTError:\n        raise HTTPException(status_code=401, detail=\"Invalid token\")\n\n@app.get(f\"{API_PREFIX}/users\")\nasync def read_users():\n    users = collection.find()\n    return [User(id=user[\"_id\"], username=user[\"username\"], email=user[\"email\"]) for user in users]\n", "langage": "python", "bugs_introduits": [], "corrections_appliquees": [], "timestamp": 1767108429.706798, "tentative": 4}