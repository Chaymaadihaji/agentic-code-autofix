{"nom_fichier": "main.py", "code": "python\n# main.py\n\n# Importations requises\nfrom fastapi import FastAPI, Depends, HTTPException\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom pydantic import BaseModel\nfrom typing import List\nfrom pymongo import MongoClient\nimport jwt\nfrom datetime import datetime, timedelta\nfrom fastapi.responses import JSONResponse\nfrom fastapi.middleware.cors import CORSMiddleware\n\n# Définitions pour la connexion MongoDB\nMONGO_URI = \"mongodb://localhost:27017\"\nCOLLECTION_NAME = \"Utilisateurs\"\n\n# Création de l'instance de FastAPI\napp = FastAPI(\n    title=\"API Utilisateurs\",\n    description=\"API REST en Python avec FastAPI et MongoDB\",\n    version=\"1.0\"\n)\n\n# Définition de la politique de CORS\norigins = [\n    \"http://localhost:8000\",\n]\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=origins,\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n# Clé secrète pour la gestion des mots de passe\nSECRET_KEY = \"secret_key\"\n\n# Définition de la classe Utilisateur\nclass Utilisateur(BaseModel):\n    id: str\n    nom: str\n    prenom: str\n    email: str\n    motdepasse: str\n\n# Définition de la collection MongoDB\nclient = MongoClient(MONGO_URI)\ndb = client[COLLECTION_NAME]\nutilisateurs = db[\"Utilisateurs\"]\n\n# Fonction de génération d'un jeton JWT\ndef generate_jwt(user_id: str):\n    return jwt.encode({\n        \"exp\": datetime.utcnow() + timedelta(minutes=30),\n        \"user_id\": user_id\n    }, SECRET_KEY, algorithm=\"HS256\")\n\n# Fonction de vérification de la validité d'un jeton JWT\ndef verify_jwt(token: str):\n    try:\n        payload = jwt.decode(token, SECRET_KEY, algorithms=[\"HS256\"])\n        return payload\n    except jwt.ExpiredSignatureError:\n        return None\n    except jwt.InvalidTokenError:\n        return None\n\n# Résolution des problèmes liés à la gestion des erreurs\n@app.exception_handler(HTTPException)\nasync def http_exception_handler(request, e):\n    return JSONResponse(status_code=e.status_code, content={\"detail\": e.detail})\n\n# API : /utilisateurs\n@app.get(\"/utilisateurs\")\nasync def get_utilisateurs():\n    try:\n        utilisateurs = list(utilisateurs.find())\n        return utilisateurs\n    except Exception as e:\n        raise HTTPException(status_code=400, detail=str(e))\n\n# API : /utilisateurs/{id_utilisateur}\n@app.get(\"/utilisateurs/{id_utilisateur}\")\nasync def get_utilisateur(id_utilisateur: str):\n    try:\n        utilisateur = utilisateurs.find_one({\"id\": id_utilisateur})\n        if utilisateur:\n            return utilisateur\n        else:\n            raise HTTPException(status_code=404, detail=\"Utilisateur non trouvé\")\n    except Exception as e:\n        raise HTTPException(status_code=400, detail=str(e))\n\n# API : POST /utilisateurs\n@app.post(\"/utilisateurs\")\nasync def create_utilisateur(utilisateur: Utilisateur):\n    try:\n        utilisateur_cree = utilizateurs.insert_one({\n            \"id\": utilisateur.id,\n            \"nom\": utilisateur.nom,\n            \"prenom\": utilisateur.prenom,\n            \"email\": utilisateur.email,\n            \"motdepasse\": utilisateur.motdepasse\n        })\n        return utilizateurs.find_one({\"_id\": utilisateur_cree.inserted_id})\n    except Exception as e:\n        raise HTTPException(status_code=400, detail=str(e))\n\n# API : POST /login\n@app.post(\"/login\")\nasync def login(username: str, password: str):\n    try:\n        utilisateur = utilisateurs.find_one({\"email\": username})\n        if utilisateur and utilisateur[\"motdepasse\"] == password:\n            utilisateur_cree = utilisateurs.find_one_and_update(\n                {\"email\": username},\n                {\"$set\": {\"login_token\": generate_jwt(username)}}\n            )\n            return utilisateur_cree\n        else:\n            raise HTTPException(status_code=401, detail=\"Mot de passe ou identifiant incorrect\")\n    except Exception as e:\n        raise HTTPException(status_code=400, detail=str(e))\n\n# API : GET /logout\n@app.get(\"/logout\")\nasync def logout(token: str):\n    try:\n        utilisateur = utilisateurs.find_one_and_update(\n            {\"login_token\": token},\n            {\"$unset\": {\"login_token\": 1}}\n        )\n        return utilisateur\n    except Exception as e:\n        raise HTTPException(status_code=401, detail=\"Déconnexion non autorisée\")\n\n# API : GET /utilisateurs/me\n@app.get(\"/utilisateurs/me\")\nasync def get_utilisateur_actuel(token: str):\n    try:\n        utilisateur = utilisateurs.find_one(\n            {\"login_token\": token}\n        )\n        if utilisateur:\n            return utilisateur\n        else:\n            raise HTTPException(status_code=401, detail=\"Accès non autorisé\")\n    except Exception as e:\n        raise HTTPException(status_code=400, detail=str(e))\n", "langage": "python", "bugs_introduits": [], "corrections_appliquees": [], "timestamp": 1767106638.542615, "tentative": 3}