{"nom_fichier": "models.py", "code": "python\n# models.py\nfrom typing import Optional\nfrom pydantic import BaseModel\nfrom datetime import datetime\nfrom bson import ObjectId\nfrom fastapi import HTTPException\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom jwt import PyJWTError\nfrom jose import jwt\nfrom pymongo import MongoClient\n\nfrom core import settings\n\nclass PyObjectId(ObjectId):\n    @classmethod\n    def __get_validators__(cls):\n        yield cls.validate\n    @classmethod\n    def validate(cls, v):\n        if not isinstance(v, ObjectId):\n            raise ValueError(\"Invalid ObjectId\")\n        return ObjectId(v)\n    @classmethod\n    def __modify_schema__(cls, field_schema):\n        field_schema.update(type=\"string\")\n\nclass UserBase(BaseModel):\n    email: str\n    password: str\n\nclass UserCreate(UserBase):\n    pass\n\nclass User(UserBase):\n    id: PyObjectId\n    username: str\n    email: str\n    created_at: datetime\n    updated_at: datetime\n\n    class Config:\n        orm_mode = True\n\nclass Token(BaseModel):\n    access_token: str\n    token_type: str\n\nclass TokenData(BaseModel):\n    email: Optional[str] = None\n\nclass PyObjectId(ObjectId):\n    @classmethod\n    def __get_validators__(cls):\n        yield cls.validate\n    @classmethod\n    def validate(cls, v):\n        if not isinstance(v, ObjectId):\n            raise ValueError(\"Invalid ObjectId\")\n        return ObjectId(v)\n    @classmethod\n    def __modify_schema__(cls, field_schema):\n        field_schema.update(type=\"string\")\n\nclass Item(BaseModel):\n    id: PyObjectId\n    title: str\n    description: str\n    owner_id: PyObjectId\n\n    class Config:\n        orm_mode = True\n\ndef get_db():\n    client = MongoClient(settings.DATABASE_URL)\n    db = client[settings.DATABASE_NAME]\n    return db\n\ndef authenticate_user(fake_db, email: str, password: str):\n    user = fake_db[\"users\"].find_one({\"email\": email})\n    if not user:\n        return False\n    if not verify_password(password, user[\"password\"]):\n        return False\n    return user\n\nasync def get_current_user(db: MongoClient, token: str):\n    try:\n        payload = jwt.decode_token(token, settings.SECRET_KEY, algorithms=[settings.ALGORITHM])\n    except PyJWTError:\n        raise HTTPException(status_code=401, detail=\"Invalid token\")\n    user = db[\"users\"].find_one({\"email\": payload[\"sub\"]})\n    if not user:\n        raise HTTPException(status_code=404, detail=\"User not found\")\n    return User(**user)\n\nasync def get_current_active_user(current_user: User = Depends(get_current_user)):\n    return current_user\n", "langage": "python", "bugs_introduits": [], "corrections_appliquees": [], "timestamp": 1767108274.6412568, "tentative": 1}