{"nom_fichier": "app.py", "code": "from flask import Flask, render_template, request, redirect, url_for, flash\nfrom flask_bcrypt import Bcrypt\nfrom flask_login import LoginManager, UserMixin, login_user, login_required, logout_user, current_user\nfrom flask_sqlalchemy import SQLAlchemy\nfrom flask_mail import Mail, Message\nfrom itsdangerous import URLSafeTimedSerializer\nimport smtplib\nfrom email.mime.multipart import MIMEMultipart\nfrom email.mime.text import MIMEText\nimport random\nimport string\nimport json\n\napp = Flask(__name__)\napp.config['SECRET_KEY'] = 'secret_key_here'\napp.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///site.db'\napp.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False\napp.config['MAIL_SERVER'] = 'smtp.gmail.com'\napp.config['MAIL_PORT'] = 587\napp.config['MAIL_USE_TLS'] = True\napp.config['MAIL_USERNAME'] = 'votre_email@gmail.com'\napp.config['MAIL_PASSWORD'] = 'votre_mot_de_passe'\n\nbcrypt = Bcrypt(app)\ndb = SQLAlchemy(app)\nlogin_manager = LoginManager(app)\nlogin_manager.login_view = 'login'\nlogin_manager.login_message_category = 'info'\n\nmail = Mail(app)\n\ns = URLSafeTimedSerializer('secret_key_here')\n\nclass Utilisateur(UserMixin, db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    nom = db.Column(db.String(20), nullable=False)\n    prenom = db.Column(db.String(20), nullable=False)\n    email = db.Column(db.String(120), unique=True, nullable=False)\n    mot_de_passe = db.Column(db.String(120), nullable=False)\n\nclass Connexion(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    utilisateur_id = db.Column(db.Integer, db.ForeignKey('utilisateur.id'), nullable=False)\n    date = db.Column(db.DateTime, nullable=False, default=db.func.current_timestamp())\n\n@login_manager.user_loader\ndef load_user(user_id):\n    return Utilisateur.query.get(int(user_id))\n\n@app.route('/')\ndef index():\n    return render_template('index.html')\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    if request.method == 'POST':\n        utilisateur = Utilisateur.query.filter_by(email=request.form['email']).first()\n        if utilisateur and bcrypt.check_password_hash(utilisateur.mot_de_passe, request.form['mot_de_passe']):\n            login_user(utilisateur)\n            return redirect(url_for('accueil'))\n    return render_template('login.html')\n\n@app.route('/register', methods=['GET', 'POST'])\ndef register():\n    if request.method == 'POST':\n        utilisateur = Utilisateur(nom=request.form['nom'], prenom=request.form['prenom'], email=request.form['email'], mot_de_passe=bcrypt.generate_password_hash(request.form['mot_de_passe']).decode('utf-8'))\n        db.session.add(utilisateur)\n        db.session.commit()\n        return redirect(url_for('login'))\n    return render_template('register.html')\n\n@app.route('/accueil')\n@login_required\ndef accueil():\n    return render_template('accueil.html')\n\n@app.route('/logout')\n@login_required\ndef logout():\n    logout_user()\n    return redirect(url_for('index'))\n\n@app.route('/historique')\n@login_required\ndef historique():\n    connexions = Connexion.query.all()\n    return render_template('historique.html', connexions=connexions)\n\n@app.route('/connexion', methods=['POST'])\n@login_required\ndef connexion():\n    connexion = Connexion(utilisateur_id=current_user.id)\n    db.session.add(connexion)\n    db.session.commit()\n    return 'Connexion enregistrée'\n\n@app.route('/validation_email', methods=['POST'])\n@login_required\ndef validation_email():\n    email = current_user.email\n    msg = MIMEMultipart()\n    msg['From'] = 'votre_email@gmail.com'\n    msg['To'] = email\n    msg['Subject'] = 'Validation de compte'\n    body = 'Cliquez sur le lien suivant pour valider votre compte : http://localhost:5000/validation/' + s.dumps(email)\n    msg.attach(MIMEText(body, 'plain'))\n    server = smtplib.SMTP('smtp.gmail.com', 587)\n    server.starttls()\n    server.login(msg['From'], 'votre_mot_de_passe')\n    text = msg.as_string()\n    server.sendmail(msg['From'], msg['To'], text)\n    server.quit()\n    return 'Email envoyé'\n\n@app.route('/validation/<token>')\ndef validation(token):\n    email = s.loads(token)\n    utilisateur = Utilisateur.query.filter_by(email=email).first()\n    utilisateur.valide = True\n    db.session.commit()\n    return 'Compte validé'\n\n@app.route('/reinitialisation_mot_de_passe', methods=['POST'])\n@login_required\ndef reinitialisation_mot_de_passe():\n    email = current_user.email\n    msg = MIMEMultipart()\n    msg['From'] = 'votre_email@gmail.com'\n    msg['To'] = email\n    msg['Subject'] = 'Réinitialisation de mot de passe'\n    body = 'Cliquez sur le lien suivant pour réinitialiser votre mot de passe : http://localhost:5000/reinitialisation/' + s.dumps(email)\n    msg.attach(MIMEText(body, 'plain'))\n    server = smtplib.SMTP('smtp.gmail.com', 587)\n    server.starttls()\n    server.login(msg['From'], 'votre_mot_de_passe')\n    text = msg.as_string()\n    server.sendmail(msg['From'], msg['To'], text)\n    server.quit()\n    return 'Email envoyé'\n\n@app.route('/reinitialisation/<token>')\ndef reinitialisation(token):\n    email = s.loads(token)\n    utilisateur = Utilisateur.query.filter_by(email=email).first()\n    utilisateur.mot_de_passe = bcrypt.generate_password_hash(request.form['mot_de_passe']).decode('utf-8')\n    db.session.commit()\n    return 'Mot de passe réinitialisé'\n\n@app.route('/protection_contre_attaques_bruteforce', methods=['POST'])\n@login_required\ndef protection_contre_attaques_bruteforce():\n    utilisateur = Utilisateur.query.filter_by(email=current_user.email).first()\n    if utilisateur.mauvais_mot_de_passe >= 5:\n        utilisateur.bloque = True\n        db.session.commit()\n        return 'Compte bloqué'\n    return 'Mauvais mot de passe'\n\n@app.route('/historique_connexions')\n@login_required\ndef historique_connexions():\n    connexions = Connexion.query.all()\n    return render_template('historique_connexions.html', connexions=connexions)\n\nif __name__ == '__main__':\n    db.create_all()\n    app.run(debug=True)\n", "timestamp": 1766865312.8344643}