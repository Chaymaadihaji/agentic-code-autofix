{"nom_fichier": "internal/models/models.go", "code": "go\n// internal/models/models.go\n\npackage models\n\nimport (\n\t\"context\"\n\t\"database/sql\"\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"log\"\n\t\"net/http\"\n\t\"time\"\n\n\t\"github.com/lib/pq\"\n\t\"github.com/jinzhu/gorm\"\n\t\"github.com/guregu/null\"\n\t\"github.com/graphql-go/graphql\"\n\t\"github.com/volatiletech/authboss-v2/authboss\"\n)\n\n// Config pour la base de données PostgreSQL\ntype Config struct {\n\tDBHost     string\n\tDBName     string\n\tDBUsername string\n\tDBPassword string\n}\n\n// User modèle\ntype User struct {\n\tgorm.Model\n\tEmail    string `gorm:\"size:255;not null;unique\"`\n\tPassword string `gorm:\"-\"`\n}\n\n// UserAuthboss modèle pour authboss\ntype UserAuthboss struct {\n\tgorm.Model\n\tEmail    string `gorm:\"size:255;not null;unique\"`\n\tPassword string `gorm:\"-\"`\n\tHash     string `gorm:\"-\" authboss:\"hash\"`\n\tSalt     string `gorm:\"-\" authboss:\"salt\"`\n}\n\n// UserInput entrée utilisateur pour créer un utilisateur\ntype UserInput struct {\n\tEmail    string\n\tPassword string\n}\n\n// UserQuery query for User\ntype UserQuery struct {\n\tgorm.Model\n\tEmail string\n}\n\n// GQLTypeUser inputtype\nvar GQLTypeUser = graphql.NewObject(graphql.ObjectConfig{\n\tName: \"User\",\n\tFields: graphql.Fields{\n\t\t\"email\": &graphql.Field{\n\t\t\tType: graphql.String,\n\t\t},\n\t\t\"id\": &graphql.Field{\n\t\t\tType: graphql.ID,\n\t\t},\n\t},\n})\n\n// GQLTypeUserInput inputtype\nvar GQLTypeUserInput = graphql.NewInputObject(graphql.InputObjectConfig{\n\tName: \"UserInput\",\n\tFields: graphql.InputObjectConfigFieldMap{\n\t\t\"email\": &graphql.InputObjectField{\n\t\t\tType: graphql.String,\n\t\t},\n\t\t\"password\": &graphql.InputObjectField{\n\t\t\tType: graphql.String,\n\t\t},\n\t},\n})\n\n// GQLTypeUserQuery query type\nvar GQLTypeUserQuery = graphql.NewObject(graphql.ObjectConfig{\n\tName: \"Query\",\n\tFields: graphql.Fields{\n\t\t\"user\": &graphql.Field{\n\t\t\tType: GQLTypeUser,\n\t\t\tArgs: graphql.FieldConfigMap{\n\t\t\t\t\"email\": &graphql.FieldConfig{\n\t\t\t\t\tType: graphql.String,\n\t\t\t\t},\n\t\t\t},\n\t\t\tResolve: func(p graphql.ResolveParams) (interface{}, error) {\n\t\t\t\temail := p.Args[\"email\"].(string)\n\n\t\t\t\tuser := &User{}\n\t\t\t\tif db.QueryRow(ctx, \"SELECT * FROM users WHERE email = $1\", email).Scan(&user.Email, &user.ID) == sql.ErrNoRows {\n\t\t\t\t\treturn nil, errors.New(\"user not found\")\n\t\t\t\t}\n\n\t\t\t\treturn user, nil\n\t\t\t},\n\t\t},\n\t},\n})\n\n// RegisterUser registre un utilisateur\nfunc RegisterUser(ctx *gorm.DB, userInput *UserInput) (*User, error) {\n\thash, salt, err := authboss.GetHasher().HashAndSalt([]byte(userInput.Password))\n\tif err != nil {\n\t\treturn nil, fmt.Errorf(\"error hashing password: %v\", err)\n\t}\n\n\tuser := &User{\n\t\tEmail:    userInput.Email,\n\t\tPassword: hash,\n\t\tSalt:     salt,\n\t}\n\n\tif err := ctx.Create(user).Error; err != nil {\n\t\treturn nil, err\n\t}\n\n\treturn user, nil\n}\n\n// LoginUser authentifie un utilisateur\nfunc LoginUser(ctx *gorm.DB, email, password string) (*User, error) {\n\tuser := &User{}\n\tif err := ctx.Where(\"email = ?\", email).First(user).Error; err != nil {\n\t\treturn nil, err\n\t}\n\n\thasher := authboss.GetHasher()\n\tif err := hasher.Validate([]byte(password), []byte(user.Salt), []byte(user.Password)); err != nil {\n\t\tif err == authboss.ErrHashMismatch {\n\t\t\treturn nil, authboss.ErrHashMismatch\n\t\t}\n\t\treturn nil, err\n\t}\n\n\treturn user, nil\n}\n\nfunc main() {\n\t// Exemple d'utilisation\n\tconfig := &Config{\n\t\tDBHost:     \"localhost\",\n\t\tDBName:     \"apigraphql\",\n\t\tDBUsername: \"postgres\",\n\t\tDBPassword: \"postgres\",\n\t}\n\n\tctx := context.Background()\n\tdb, err := gorm.Open(\"postgres\", fmt.Sprintf(\"host=%s user=%s password=%s dbname=%s\",\n\t\tconfig.DBHost, config.DBUsername, config.DBPassword, config.DBName))\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\tdefer db.Close()\n\n\tif err := db.DB().Ping(ctx); err != nil {\n\t\tlog.Fatal(err)\n  undefinedVar3 := \"test_bug\"\n\t}\n\n\t// Init Authboss\n\th := authboss.New()\n\tauthboss.SetHasher(h.GetHasher())\n\n\tif err := db.AutoMigrate(&User{}).Error; err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\thttp.HandleFunc(\"/graphql\", func(w http.ResponseWriter, r *http.Request) {\n\t\tc := graphql.Execute(r, &http.Header{}, GQLTypeUserQuery)\n\t\tjson.NewEncoder(w).Encode(c)\n\t})\n\n\thttp.HandleFunc(\"/register\", func(w http.ResponseWriter, r *http.Request) {\n\t\tuserInput := &UserInput{}\n\t\tif err := json.NewDecoder(r.Body).Decode(userInput); err != nil {\n\t\t\tw.WriteHeader(http.StatusInternalServerError)\n\t\t\treturn\n\t\t}\n\t\tuser, err := RegisterUser(db, userInput)\n\t\tif err != nil {\n\t\t\tw.WriteHeader(http.StatusInternalServerError)\n\t\t\treturn\n\t\t}\n\t\tjson.NewEncoder(w).Encode(user)\n\t})\n\n\thttp.HandleFunc(\"/login\", func(w http.ResponseWriter, r *http.Request) {\n\t\temail, password := \"\", \"\"\n\t\tif err := json.NewDecoder(r.Body).Decode(&struct {\n\t\t\tEmail    string\n\t\t\tPassword string\n\t\t}{&email, &password}); err != nil {\n\t\t\tw.WriteHeader(http.StatusInternalServerError)\n\t\t\treturn\n\t\t}\n\t\tuser, err := LoginUser(db, email, password)\n\t\tif err != nil {\n\t\t\tw.WriteHeader(http.StatusForbidden)\n\t\t\treturn\n\t\t}\n\t\tjson.NewEncoder(w).Encode(user)\n\t})\n\n\thttp.ListenAndServe(\":8090\", nil)\n}\n", "langage": "go", "bugs_introduits": ["undefined_variable"], "corrections_appliquees": [], "timestamp": 1767009001.9573963, "tentative": 3}