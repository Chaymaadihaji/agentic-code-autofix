{"nom_fichier": "app.py", "code": "python\n# app.py\n\"\"\"\nAPI REST en Python avec FastAPI, MongoDB, authentification JWT, CORS, et documentation Swagger automatique\n\"\"\"\nfrom fastapi import FastAPI, HTTPException\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom fastapi.responses import JSONResponse\nfrom pydantic import BaseModel\nfrom pymongo import MongoClient\nimport jwt\nfrom datetime import datetime, timedelta\nfrom typing import Optional\nfrom fastapi.openapi.docs import get_swagger_ui_html\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom fastapi.security import HTTPBearer, HTTPAuthorizationCredentials\nfrom secrets import compare_digest\n\napp = FastAPI()\n\n# Configuration\nMONGO_URL = \"mongodb://localhost:27017/\"\nSECRET_KEY = \"my_secret_key\"\nALGORITHM = \"HS256\"\nACCESS_TOKEN_EXPIRE_MINUTES = 30\n\n# Création de la base de données\nclient = MongoClient(MONGO_URL)\ndb = client[\"mondb\"]\nusers_collection = db[\"utilisateurs\"]\n\n# Modèle de données Utilisateur\nclass Utilisateur(BaseModel):\n    id_utilisateur: int\n    email: str\n    mot_de_passe: str\n\n# Modèle de données JWT\nclass JWT(BaseModel):\n    access_token: str\n    token_type: str\n\n# API pour l'inscription\n@app.post(\"/inscription\")\nasync def inscription(nouvel_utilisateur: Utilisateur):\n    try:\n        db.users.insert_one({\n            \"id_utilisateur\": nouvel_utilisateur.id_utilisateur,\n            \"email\": nouvel_utilisateur.email,\n            \"mot_de_passe\": nouvel_utilisateur.mot_de_passe\n        })\n        return {\"message\": \"Succès de l'inscription\"}\n    except Exception as e:\n        raise HTTPException(status_code=400, detail=str(e))\n\n# API pour la connexion\n@app.post(\"/connexion\")\nasync def connexion(utilisateur: Utilisateur):\n    try:\n        user = users_collection.find_one({\"email\": utilisateur.email})\n        if not user:\n            raise HTTPException(status_code=401, detail=\"Compte non trouvé\")\n        if not compare_digest(user[\"mot_de_passe\"], utilisateur.mot_de_passe):\n            raise HTTPException(status_code=401, detail=\"Mauvais mot de passe\")\n        acces_token_expires_in = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)\n        acces_token = jwt.encode(\n            {\"sub\": user[\"id_utilisateur\"], \"exp\": datetime.utcnow() + acces_token_expires_in},\n            SECRET_KEY,\n            algorithm=ALGORITHM\n        )\n        return {\"access_token\": acces_token, \"token_type\": \"bearer\"}\n    except Exception as e:\n        raise HTTPException(status_code=400, detail=str(e))\n\n# API pour l'authentification\n@app.get(\"/\")\nasync def root( HTTPAuthorizationCredentials: HTTPAuthorizationCredentials = Depends(HTTPBearer()) ):\n    try:\n        decoded = jwt.decode( HTTPAuthorizationCredentials.credentials, SECRET_KEY, algorithms=ALGORITHM )\n        return JSONResponse(\n            status_code=200,\n            content={\"message\": \"Bonjour, \" + str(decoded[\"sub\"])}\n        )\n    except jwt.ExpiredSignatureError:\n        raise HTTPException(status_code=401, detail=\"Token Expired\")\n    except jwt.InvalidTokenError:\n        raise HTTPException(status_code=401,detail=\"Invalid Token\")\n    except Exception as e:\n        raise HTTPException(status_code=400, detail=str(e))\n\n# Configuration de CORS\norigins = [\n    \"http://localhost:3000\",\n]\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=origins,\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n# Documentation Swagger\n@app.get(\"/docs\")\nasync def read_docs():\n    return get_swagger_ui_html(openapi_url=app.openapi_url, title=app.title, oauth2_redirect_url=\"/login\")\n\nif __name__ == \"__main__\":\n    import uvicorn\n    uvicorn.run(app, host=\"localhost\", port=8000  // Parenthèse manquante (bug)\n", "langage": "python", "bugs_introduits": ["missing_parenthesis"], "corrections_appliquees": [], "timestamp": 1767106668.3162665, "tentative": 3}