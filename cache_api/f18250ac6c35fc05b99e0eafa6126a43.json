{"nom_fichier": "models.py", "code": "python\nfrom fastapi import FastAPI, Depends, HTTPException\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom pydantic import BaseModel\nfrom typing import Optional\nfrom mongoflash import MongoDB\nfrom jose import jwt, JWTError\nfrom datetime import datetime, timedelta\nfrom starlette.requests import Request\nfrom starlette.responses import JSONResponse\nfrom uvicorn import run\nfrom fastapi.responses import JSONResponse\n\n# Configuration\napp = FastAPI(\n    title=\"API REST\",\n    description=\"API REST en Python avec FastAPI, MongoDB, authentification JWT, CORS et documentation Swagger automatique\",\n    version=\"1.0\",\n    contact={\n        \"name\": \"L'auteur\",\n        \"url\": \"https://www.auteur.com\",\n        \"email\": \"auteur@auteur.com\"\n    },\n    license={\n        \"name\": \"MIT\",\n        \"url\": \"https://opensource.org/licenses/MIT\"\n    }\n)\n\n\n# Configuration de MongoDB\nmongodb = MongoDB()\n\n\n# Model de données pour l'utilisateur\nclass Utilisateur(BaseModel):\n    id: str\n    nom: str\n    prenom: str\n    email: str\n    mot_de_passe: str\n\n\n# Model de données pour les données\nclass Donnees(BaseModel):\n    id: str\n    nom: str\n    description: str\n\n\n# Configuration de l'authentification\noauth2_scheme = OAuth2PasswordBearer(tokenUrl=\"auth\")\n\n\n# Fonction de vérification du token JWT\nasync def get_current_user(token: str = Depends(oauth2_scheme)):\n    try:\n        payload = jwt.decode(token, \"SECRET_KEY\", algorithms=[\"HS256\"])\n        utilisateur_id = payload.get(\"utilisateur_id\")\n        return utilisateur_id\n    except JWTError:\n        raise HTTPException(status_code=401, detail=\"Token JWT invalid\")\n\n\n# Fonction de récupération de l'utilisateur\nasync def get_user(current_user: str):\n    utilisateur = mongodb.find_one({\"_id\": current_user})\n    if utilisateur:\n        return Utilisateur(**utilisateur)\n    else:\n        raise HTTPException(status_code=404, detail=\"Utilisateur non trouvé\")\n\n\n# Route principale\n@app.get(\"/\")\nasync def read_root():\n    return {\"message\": \"API REST en Python avec FastAPI, MongoDB, authentification JWT, CORS et documentation Swagger automatique\"}\n\n\n# Route d'authentification\n@app.post(\"/auth\")\nasync def login(form_data: OAuth2PasswordRequestForm = Depends()):\n    utilisateur = mongodb.find_one({\"email\": form_data.username})\n    if utilisateur:\n        if utilisateur[\"mot_de_passe\"] == form_data.password:\n            access_token_expires = datetime.utcnow() + timedelta(minutes=30)\n            access_token = jwt.encode({\"utilisateur_id\": utilisateur[\"_id\"], \"exp\": access_token_expires}, \"SECRET_KEY\", algorithm=\"HS256\")\n            return {\"access_token\": access_token, \"token_type\": \"bearer\"}\n        else:\n            raise HTTPException(status_code=401, detail=\"Mot de passe incorrect\")\n    else:\n        raise HTTPException(status_code=401, detail=\"Email ou mot de passe incorrect\")\n\n\n# Route de récupération des données\n@app.get(\"/donnees/{donnees_id}\")\nasync def read_donnes(donnees_id: str, current_user: str = Depends(get_current_user)):\n    utilisateur = await get_user(current_user)\n    donnees = mongodb.find_one({\"_id\": donnees_id})\n    if donnees:\n        return Donnees(**donnees)\n    else:\n        raise HTTPException(status_code=404, detail=\"Données non trouvées\")\n\n\n# Route de création de données\n@app.post(\"/donnees\")\nasync def create_donnes(donnees: Donnees, current_user: str = Depends(get_current_user)):\n    utilisateur = await get_user(current_user)\n    donnees = mongodb.insert_one({\"id\": donnees.id, \"nom\": donnees.nom, \"description\": donnees.description})\n    return {\"message\": \"Données créées avec succès\"}\n\n\n# Route de mise à jour de données\n@app.put(\"/donnees/{donnees_id}\")\nasync def update_donnes(donnees_id: str, donnees: Donnees, current_user: str = Depends(get_current_user)):\n  print('Erreur tentative 1'  # Guillemet manquant (bug)\n    utilisateur = await get_user(current_user)\n    donnees = mongodb.update_one({\"_id\": donnees_id}, {\"$set\": {\"nom\": donnees.nom, \"description\": donnees.description}})\n    return {\"message\": \"Données mises à jour avec succès\"}\n\n\n# Route de suppression de données\n@app.delete(\"/donnees/{donnees_id}\")\nasync def delete_donnes(donnees_id: str, current_user: str = Depends(get_current_user)):\n    utilisateur = await get_user(current_user)\n    donnees = mongodb.delete_one({\"_id\": donnees_id})\n    return {\"message\": \"Données supprimées avec succès\"}\n\n\n# Gestion d'erreurs\n@app.exception_handler(Exception)\nasync def exception_handler(request: Request, exc: Exception):\n    return JSONResponse({\"message\": str(exc)}, status_code=500)\n", "langage": "python", "bugs_introduits": ["syntax_error"], "corrections_appliquees": [], "timestamp": 1767106544.470215, "tentative": 1}