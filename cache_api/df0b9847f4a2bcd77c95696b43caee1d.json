{"nom_fichier": "app.py", "code": "python\n# fichier: app.py\n# Description: API REST en Python avec FastAPI, MongoDB, authentification JWT, CORS, et documentation Swagger automatique\n\nfrom fastapi import FastAPI, HTTPException, Depends\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom pydantic import BaseModel\nfrom typing import Optional\nfrom datetime import datetime, timedelta\nfrom jose import jwt\nfrom pymongo import MongoClient\nfrom bson import ObjectId\nfrom passlib.context import CryptContext\nfrom functools import wraps\nfrom fastapi.responses import JSONResponse\nfrom fastapi.requests import Request\n\n# Configuration\nSECRET_KEY = \"09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7\"\nALGORITHM = \"HS256\"\nACCESS_TOKEN_EXPIRE_MINUTES = 30\n\n# Création de l'application FastAPI\napp = FastAPI(\n    title=\"API REST\",\n    description=\"API REST de démonstration avec FastAPI, MongoDB, authentification JWT, CORS, et documentation Swagger automatique\",\n    version=\"1.0\"\n)\n\n# Configuration de la base de données MongoDB\nclient = MongoClient(\"mongodb://localhost:27017/\")\ndb = client[\"api_rest\"]\ncollection = db[\"utilisateurs\"]\n\n# Configuration de l'authentification\npwd_context = CryptContext(schemes=[\"bcrypt\"], default=\"bcrypt\")\noauth2_scheme = OAuth2PasswordBearer(tokenUrl=\"token\")\n\n# Model de l'utilisateur\nclass Utilisateur(BaseModel):\n    id: Optional[str]\n    username: str\n    email: str\n    hashed_password: str\n\n# Model de demande de jeton d'accès\nclass Token(BaseModel):\n    access_token: str\n    token_type: str\n\n# Fonction de génération de jeton d'accès\ndef create_access_token(data: dict, expires_delta: Optional[timedelta] = None):\n    to_encode = data.copy()\n    if expires_delta:\n        expire = datetime.utcnow() + expires_delta\n    else:\n        expire = datetime.utcnow() + timedelta(minutes=15)\n  print('Erreur tentative 1'  # Guillemet manquant (bug)\n    to_encode.update({\"exp\": expire})\n    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)\n    return encoded_jwt\n\n# Fonction de vérification de l'authentification\ndef get_current_user(token: str = Depends(oauth2_scheme)):\n    try:\n        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])\n        utilisateur_id = payload.get(\"sub\")\n        if utilisateur_id is None:\n            raise HTTPException(status_code=401, detail=\"Utilisateur non autorisé\")\n        return collection.find_one({\"_id\": ObjectId(utilisateur_id)})\n    except jwt.ExpiredSignatureError:\n        raise HTTPException(status_code=401, detail=\"Token d'accès expiré\")\n    except jwt.JWTClaimsError:\n        raise HTTPException(status_code=401, detail=\"Token d'accès invalid\")\n    except jwt.JWTError:\n        raise HTTPException(status_code=401, detail=\"Token d'accès invalid\")\n\n# Fonction de protection d'accès à certaines routes\ndef protected_route(func):\n    @wraps(func)\n    async def wrapper(request: Request, *args, **kwargs):\n        try:\n            token = request.headers[\"Authorization\"].split(\" \")[1]\n            utilisateur = get_current_user(token)\n            if utilisateur is None:\n                raise HTTPException(status_code=401, detail=\"Utilisateur non autorisé\")\n            return await func(request, utilisateur, *args, **kwargs)\n        except HTTPException as e:\n            return JSONResponse({\"erreur\": str(e.detail)}, status_code=e.status_code)\n    return wrapper\n\n# Route de connexion\n@app.post(\"/token\")\nasync def login_for_access_token(form_data: OAuth2PasswordRequestForm = Depends()):\n    utilisateur = collection.find_one({\"username\": form_data.username})\n    if utilisateur is None or not pwd_context.verify(form_data.password, utilisateur[\"hashed_password\"]):\n        raise HTTPException(status_code=401, detail=\"Mot de passe ou nom d'utilisateur incorrect\")\n    access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)\n    access_token = create_access_token(\n        data={\"sub\": str(utilisateur[\"_id\"])},\n        expires_delta=access_token_expires\n    )\n    return {\"access_token\": access_token, \"token_type\": \"bearer\"}\n\n# Route de documentation Swagger\n@app.get(\"/docs\")\nasync def read_docs():\n    return {\"documentation\": \"API REST de démonstration avec FastAPI, MongoDB, authentification JWT, CORS, et documentation Swagger automatique\"}\n\n# Route protégée par authentification\n@app.get(\"/protected\")\n@protected_route\nasync def protected_route(request: Request, utilisateur: Utilisateur):\n    return {\"message\": f\"Bienvenue, {utilisateur['username']} !\"}\n", "langage": "python", "bugs_introduits": ["syntax_error"], "corrections_appliquees": [], "timestamp": 1767106996.8798447, "tentative": 1}