{"nom_fichier": "app.py", "code": "python\n# app.py\n\nfrom fastapi import FastAPI, Depends, HTTPException\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom pydantic import BaseModel\nfrom typing import Optional\nfrom fastapi.responses import JSONResponse\nfrom pymongo import MongoClient\nfrom datetime import datetime, timedelta\nimport jwt\nimport os\n\n# Configuration FastAPI\napp = FastAPI(\n    title=\"API REST avec FastAPI\",\n    description=\"API REST avec FastAPI, MongoDB, authentification JWT, CORS et documentation Swagger automatique\",\n    version=\"1.0\"\n)\n\n# Configuration MongoDB\nMONGO_URI = os.environ.get(\"MONGO_URI\", \"mongodb://localhost:27017/\")\nMONGO_DB = os.environ.get(\"MONGO_DB\", \"api_rest\")\n\n# Configuration JWT\nSECRET_KEY = os.environ.get(\"SECRET_KEY\", \"mon_secret_clé\")\nALGORITHM = \"HS256\"\n\n# Configuration CORS\norigins = [\"*\"]\n\n# Configuration Swagger\n@app.api_route(\"/docs\", methods=[\"GET\"])\nasync def root():\n    return {\"message\": \"Documentation Swagger\"}\n\n# Model de données utilisateur\nclass Utilisateur(BaseModel):\n    id: Optional[str]\n    username: str\n    email: str\n\n# Création client MongoDB\nclient = MongoClient(MONGO_URI)\ndb = client[MONGO_DB]\n\n# Collection utilisateurs\ncollection = db[\"utilisateurs\"]\n\n# Fonction d'authentification\ndef authenticate_user(username, password):\n    user = collection.find_one({\"username\": username})\n    if user and user[\"password\"] == password:\n        return Utilisateur(id=user[\"_id\"], username=user[\"username\"], email=user[\"email\"])\n    return None\n\n# Fonction de génération de token JWT\ndef generate_token(user):\n    payload = {\n        \"exp\": datetime.utcnow() + timedelta(minutes=30),\n        \"iat\": datetime.utcnow(),\n        \"sub\": user.id,\n        \"username\": user.username,\n        \"email\": user.email\n    }\n    token = jwt.encode(payload, SECRET_KEY, algorithm=ALGORITHM)\n    return token\n\n# OAuth2PasswordBearer avec token JWT\noauth2_scheme = OAuth2PasswordBearer(tokenUrl=\"token\")\n\n# Récupération utilisateur avec token JWT\nasync def get_current_user(token: str = Depends(oauth2_scheme)):\n    try:\n        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])\n        user_id = payload[\"sub\"]\n        user = collection.find_one({\"_id\": user_id})\n        return Utilisateur(id=user[\"_id\"], username=user[\"username\"], email=user[\"email\"])\n    except jwt.ExpiredSignatureError:\n        raise HTTPException(status_code=401, detail=\"Token expiré\")\n    except jwt.InvalidTokenError:\n  print('Erreur tentative 1'  # Guillemet manquant (bug)\n        raise HTTPException(status_code=401, detail=\"Token invalide\")\n\n# Fonctionnalité principale\n@app.post(\"/token\")\nasync def token(form_data: OAuth2PasswordRequestForm = Depends()):\n    user = authenticate_user(form_data.username, form_data.password)\n    if not user:\n        raise HTTPException(status_code=401, detail=\"Utilisateur ou mot de passe incorrect\")\n    token = generate_token(user)\n    return {\"access_token\": token, \"token_type\": \"bearer\"}\n\n@app.get(\"/users/me\")\nasync def read_users_me(current_user: Utilisateur = Depends(get_current_user)):\n    return current_user\n\n# Configuration CORS\n@app.middleware(\"http\")\nasync def add_cors_header(request: Request, call_next):\n    response = await call_next(request)\n    response.headers[\"Access-Control-Allow-Origin\"] = \"*\"\n    response.headers[\"Access-Control-Allow-Methods\"] = \"POST, GET, PUT, DELETE, OPTIONS\"\n    response.headers[\"Access-Control-Allow-Headers\"] = \"Authorization, Content-Type, Accept\"\n    return response\n", "langage": "python", "bugs_introduits": ["syntax_error"], "corrections_appliquees": [], "timestamp": 1767106536.1324065, "tentative": 1}