{"nom_fichier": "models.py", "code": "python\n# models.py\nfrom typing import Optional\nfrom pydantic import BaseModel\nfrom fastapi import FastAPI, Depends\nfrom fastapi.security import OAuth2PasswordBearer\nfrom passlib.context import CryptContext\nfrom pymongo import MongoClient\nfrom datetime import datetime, timedelta\n\n# configuration\napp = FastAPI(title=\"Mon API\", version=\"1.0\")\nsecurity = OAuth2PasswordBearer(tokenUrl=\"token\")\n\n# MongoDB\nclient = MongoClient(\"mongodb://localhost:27017/\")\ndb = client[\"mydatabase\"]\nusers_collection = db[\"users\"]\n\n# configuration authentification\npwd_context = CryptContext(schemes=[\"bcrypt\"], default=\"bcrypt\")\naccess_token_expires = timedelta(minutes=60)\n\n# schema pour user\nclass UserBase(BaseModel):\n    username: str\n    email: str\n\nclass User(UserBase):\n    password: str\n    id: Optional[str] = None\n\nclass Token(BaseModel):\n    access_token: str\n    token_type: str\n\nclass TokenData(BaseModel):\n    username: Optional[str] = None\n\n# méthode pour obtenir les données de connexion JWT\ndef get_user(db, username: str):\n    return db_users_collection.find_one({\"username\": username})\n\ndef get_user_id(current_user: dict = Depends(get_current_active_user)):\n    return current_user[\"id\"]\n\ndef get_db():\n    db = {\"_id\": \"id\", \"username\": \"username\", \"email\": \"email\", \"password\": \"password\"}\n    try:\n        yield db\n    finally:\n        pass\n\ndef get_current_active_user(db: dict = Depends(get_db), token: str = Depends(security)):\n    try:\n        payload = jwt.decode(token, app.secret_key, algorithms=[app.algorithm])\n        username: str = payload.get(\"sub\")\n        token_data = TokenData(username=username)\n    except PyJWTError:\n        raise HTTPException(status_code=401, detail=\"La connexion est expirée\")\n    user = get_user(db, username=token_data.username)\n    if not user:\n        raise HTTPException(status_code=401, detail=\"L'utilisateur n'existe pas\")\n    return {\"id\": user[\"id\"], \"username\": user[\"username\"], \"email\": user[\"email\"]}\n\n# gestion des erreurs\n@app.exception_handler(HTTPException)\nasync def http_handler(request, exc):\n    return FastAPI.http_exception_handler(\n        exc, request, data={\"error\": f\"Erreur {exc.status_code}: {exc.detail}\"}\n    )\n\n@app.exception_handler(Exception)\nasync def default_handler(request, exc):\n    return FastAPI.default_exception_handler(exc, request, data={\"error\": f\"Erreur non identifiée {exc}\"})\n\n# API\n@app.post(\"/token\")\nasync def login_for_access_token(username: str, password: str):\n    user = get_user(db=users_collection, username=username)\n    if not user:\n        raise HTTPException(status_code=401, detail=\"L'utilisateur n'existe pas\")\n    if not pwd_context.verify(password, user[\"password\"]):\n        raise HTTPException(status_code=401, detail=\"Mot de passe incorrect\")\n    access_token_expires_delta = timedelta(minutes=60)\n    access_token = jwt.encode(\n        {\"sub\": username, \"exp\": datetime.utcnow() + access_token_expires_delta}, app.secret_key, app.algorithm\n    )\n    return {\"access_token\": access_token, \"token_type\": \"bearer\"}\n\n@app.get(\"/users/me\")\nasync def read_users_me(current_user: dict = Depends(get_current_active_user)):\n    return current_user\n", "langage": "python", "bugs_introduits": [], "corrections_appliquees": [], "timestamp": 1767106676.1259403, "tentative": 3}