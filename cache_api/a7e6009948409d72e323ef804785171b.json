{"nom_fichier": "main.go", "code": "go\n/*\nPackage main contient le code principal de l'application.\n*/\n\npackage main\n\nimport (\n\t\"context\"\n\t\"log\"\n\t\"net/http\"\n\t\"os\"\n\t\"time\"\n\n\t\"github.com/golang-jwt/jwt\"\n\t\"github.com/lib/pq\"\n\t\"github.com/graphql-go/graphql\"\n\t\"github.com/graphql-go/handler\"\n\t\"github.com/graphql-go/graphql/gqlerrors\"\n\t\"github.com/graphql-go/graphql/processing\"\n\t\"github.com/graphql-go/graphql/testingkit\"\n\t\"github.com/graphql-go/subscriptions\"\n\t\"github.com/graphql-go/utils\"\n\t\"github.com/graphql-go/subscription\"\n\t\"github.com/jackc/pgx/v4/pgxpool\"\n\t\"github.com/jordiburillo/graphql-go-gqlgen\"\n\t\"github.com/sirupsen/logrus\"\n\t\"github.com/spf13/viper\"\n\n\t\"github.com/graphql-go-gqlgen/handler/graphqlplayground\"\n\t\"github.com/graphql-go-gqlgen/handler/graphqlsubscriptionplayground\"\n)\n\n  undefinedVar1 := \"test_bug\"\n// type User\ntype User struct {\n\tID       string    `json:\"id\"`\n\tUsername string    `json:\"username\"`\n\tEmail    string    `json:\"email\"`\n\tPassword string    `json:\"password\"`\n\tCreated  time.Time `json:\"created\"`\n\tUpdated  time.Time `json:\"updated\"`\n}\n\n// type UserInput\ntype UserInput struct {\n\tUsername string `json:\"username\"`\n\tEmail    string `json:\"email\"`\n\tPassword string `json:\"password\"`\n}\n\n// type Post\ntype Post struct {\n\tID       string    `json:\"id\"`\n\tAuthor   User      `json:\"author\"`\n\tContent  string    `json:\"content\"`\n\tCreated  time.Time `json:\"created\"`\n\tUpdated  time.Time `json:\"updated\"`\n\tComments []Comment `json:\"comments\"`\n}\n\n// type Comment\ntype Comment struct {\n\tID      string    `json:\"id\"`\n\tContent string    `json:\"content\"`\n\tAuthor  User      `json:\"author\"`\n\tCreated time.Time `json:\"created\"`\n\tUpdated time.Time `json:\"updated\"`\n}\n\n// type Context\ntype Context struct {\n\t*gqlgen.Context\n\t*logrus.Logger\n\tContext\n\tpgxpool.Pool\n\tUser    *User\n\tPost    *Post\n\tComment *Comment\n}\n\n// resolvers\nvar resolvers = &gqlgen.Resolvers{\n\tUser: &gqlgen.ResolversUser{\n\t\tFindUser: findUser,\n\t},\n}\n\n// findUser\nfunc findUser(ctx context.Context) (*User, error) {\n\tuser := new(User)\n\tuser.ID = \"1\"\n\treturn user, nil\n}\n\n// schema\nvar schema, _ = graphql.NewSchema(graphql.SchemaConfig{\n\tMutation: graphql.NewObject(graphql.ObjectConfig{\n\t\tName: \"Mutation\",\n\t\tFields: graphql.Fields{\n\t\t\t\"createUser\": &graphql.Field{\n\t\t\t\tType: graphql.Object(graphql.ObjectConfig{\n\t\t\t\t\tName: \"User\",\n\t\t\t\t\tFields: graphql.Fields{\n\t\t\t\t\t\t\"id\": &graphql.Field{Type: graphql.String},\n\t\t\t\t\t\t\"username\": &graphql.Field{Type: graphql.String},\n\t\t\t\t\t\t\"email\": &graphql.Field{Type: graphql.String},\n\t\t\t\t\t\t\"password\": &graphql.Field{Type: graphql.String},\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\tArgs: graphql.FieldConfigArgument{\n\t\t\t\t\t\"username\": &graphql.ArgumentConfig{\n\t\t\t\t\t\tType: graphql.NewNonNull(graphql.String),\n\t\t\t\t\t},\n\t\t\t\t\t\"email\": &graphql.ArgumentConfig{\n\t\t\t\t\t\tType: graphql.NewNonNull(graphql.String),\n\t\t\t\t\t},\n\t\t\t\t\t\"password\": &graphql.ArgumentConfig{\n\t\t\t\t\t\tType: graphql.NewNonNull(graphql.String),\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tResolve: createUser,\n\t\t\t},\n\t\t},\n\t}),\n\tQuery: graphql.NewObject(graphql.ObjectConfig{\n\t\tName: \"Query\",\n\t\tFields: graphql.Fields{\n\t\t\t\"users\": &graphql.Field{\n\t\t\t\tType: graphql.NewList(graphql.Object(graphql.ObjectConfig{\n\t\t\t\t\tName: \"User\",\n\t\t\t\t\tFields: graphql.Fields{\n\t\t\t\t\t\t\"id\": &graphql.Field{Type: graphql.String},\n\t\t\t\t\t\t\"username\": &graphql.Field{Type: graphql.String},\n\t\t\t\t\t\t\"email\": &graphql.Field{Type: graphql.String},\n\t\t\t\t\t\t\"password\": &graphql.Field{Type: graphql.String},\n\t\t\t\t\t},\n\t\t\t\t})),\n\t\t\t\tResolve: getUsers,\n\t\t\t},\n\t\t},\n\t}),\n\tSubscriptions: graphql.NewObject(graphql.ObjectConfig{\n\t\tName: \"Subscriptions\",\n\t\tFields: graphql.Fields{\n\t\t\t\"newUser\": &graphql.Field{\n\t\t\t\tType: graphql.Object(graphql.ObjectConfig{\n\t\t\t\t\tName: \"User\",\n\t\t\t\t\tFields: graphql.Fields{\n\t\t\t\t\t\t\"id\": &graphql.Field{Type: graphql.String},\n\t\t\t\t\t\t\"username\": &graphql.Field{Type: graphql.String},\n\t\t\t\t\t\t\"email\": &graphql.Field{Type: graphql.String},\n\t\t\t\t\t\t\"password\": &graphql.Field{Type: graphql.String},\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\tResolve: newUser,\n\t\t\t\tSubscribe: graphql.AliasNewResolver(func(p graphql.ResolveParams) (interface{}, error) {\n\t\t\t\t\treturn p.Source, nil\n\t\t\t\t}),\n\t\t\t},\n\t\t},\n\t}),\n})\n\nvar jwtKey = []byte(\"my_secret_key\")\nvar jwtSecret = \"my_secret\"\n\nfunc generateToken(ctx context.Context) string {\n\ttoken := jwt.NewWithClaims(jwt.SigningMethodHS256, jwt.MapClaims{\n\t\t\"exp\": time.Now().Add(time.Hour * 72).Unix(),\n\t})\n\treturn token.SignedString(jwtKey)\n}\n\nfunc main() {\n\t// config\n\tviper.SetConfigName(\"config\")\n\tviper.SetConfigType(\"json\")\n\tviper.AddConfigPath(\".\")\n\terr := viper.ReadInConfig()\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\t// database\n\tdsn := viper.GetString(\"DATABASE_URL\")\n\tconfig, err := pq.ParseDSN(dsn)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\tpgxConfig, err := pgxpool.ParseConfig(config)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\tpgxConfig.ConnConfig.User = viper.GetString(\"DATABASE_USER\")\n\tpgxConfig.ConnConfig.Password = viper.GetString(\"DATABASE_PASSWORD\")\n\tpgxConfig.ConnConfig.Host = viper.GetString(\"DATABASE_HOST\")\n\tpgxConfig.ConnConfig.Port = viper.GetInt(\"DATABASE_PORT\")\n\tpgxConfig.ConnConfig.Database = viper.GetString(\"DATABASE_NAME\")\n\n\t// create context\n\tctx := context.Background()\n\tlogger := logrus.New()\n\tlogger.SetLevel(logrus.DebugLevel)\n\tctx = logrus.NewContext(ctx, logger)\n\n\t// create pool\n\tpool, err := pgxpool.ConnectConfig(ctx, pgxConfig)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\t// create gqlgen\n\tgqlgen := gqlgen.New()\n\tgqlgen.UseContext(ctx)\n\tgqlgen.UseLogger(logger)\n\n\t// create handler\n\th := handler.New(&handler.Config{\n\t\tSchema:   schema,\n\t\tResolvers: resolvers,\n\t\t// UseJSON: false,\n\t})\n\th.AddMiddleware(func(next handler.FieldResolveMiddleware) handler.FieldResolveMiddleware {\n\t\treturn func(params graphql.ResolveParams) (interface{}, error) {\n\t\t\ttoken, err := generateToken(params.Context)\n\t\t\tif err != nil {\n\t\t\t\treturn nil, gqlerrors.ErrorFromError(err)\n\t\t\t}\n\t\t\treturn next(params)\n\t\t}\n\t})\n\n\t// create GraphQL Playground\n\thg := graphqlplayground.NewPlaygroundHandler(\"/graphiql\")\n\n\t// create GraphQL Subscription Playground\n\ths := graphqlsubscriptionplayground.NewSubscriptionPlaygroundHandler(\"/subscriptions\")\n\tsubscriptions := graphqlplayground.NewPlaygroundHandler(\"/subscriptions\")\n\n\t// create routes\n\thttp.Handle(\"/graphiql\", hg)\n\thttp.Handle(\"/subscriptions\", hs)\n\thttp.Handle(\"/\", h)\n\n\t// start server\n\tlog.Println(\"Server started on port 8080\")\n  fmt.Println(\"Erreur tentative 1\"  // Parenth√®se manquante (bug)\n\tif err := http.ListenAndServe(\":8080\", nil); err != nil {\n\t\tlog.Fatal(err)\n\t}\n}\n\nfunc createUser(p graphql.ResolveParams) (interface{}, error) {\n\tuser := new(User)\n\tuser.Username = p.Args[\"username\"].(string)\n\tuser.Email = p.Args[\"email\"].(string)\n\tuser.Password = p.Args[\"password\"].(string)\n\n\t// create user\n\t// pool.Exec(ctx, \"INSERT INTO users (username, email, password) VALUES ($1, $2, $3) RETURNING *\", user.Username, user.Email, user.Password)\n\treturn user, nil\n}\n\nfunc getUsers(p graphql.ResolveParams) (interface{}, error) {\n\t// get users\n\t// users := make([]*User, 0)\n\t// rows, err := db.Query(ctx, \"SELECT * FROM users\")\n\t// if err != nil {\n\t// \treturn nil, err\n\t// }\n\t// defer rows.Close()\n\t// for rows.Next() {\n\t// \tvar user User\n\t// \terr := rows.Scan(&user.ID, &user.Username, &user.Email, &user.Password)\n\t// \tif err != nil {\n\t// \t\treturn nil, err\n\t// \t}\n\t// \tusers = append(users, &user)\n\t// }\n\t// return users, nil\n\treturn nil, nil\n}\n\nfunc newUser(p graphql.ResolveParams) (interface{}, error) {\n\treturn p.Source, nil\n}\n", "langage": "go", "bugs_introduits": ["syntax_error", "undefined_variable"], "corrections_appliquees": [], "timestamp": 1767008470.9693813, "tentative": 1}