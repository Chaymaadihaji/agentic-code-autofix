{"nom_fichier": "main.py", "code": "python\n# main.py\n\nfrom fastapi import FastAPI, Depends, HTTPException\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom sqlalchemy import create_engine\nfrom sqlalchemy.orm import sessionmaker\nfrom pydantic import BaseModel\nfrom datetime import datetime, timedelta\nimport jwt, uvicorn, mongoengine\nfrom fastapi.responses import JSONResponse\n\napp = FastAPI(title=\"API REST\", description=\"API REST en Python avec FastAPI et MongoDB\")\n\n# Configuration de la base de données MongoDB\nmongoengine.connect(\"database\", host=\"mongodb://localhost:27017/\")\n\nclass Utilisateur(BaseModel):\n    \"\"\"Modele de Utilisateur\"\"\"\n    id: str\n    nom: str\n    prenom: str\n\nclass Token(BaseModel):\n    \"\"\"Modele de Token JWT\"\"\"\n    access_token: str\n    token_type: str\n\nclass JWTBearer(OAuth2PasswordBearer):\n    \"\"\"Authentification JWT\"\"\"\n    def __init__(self, tokenUrl):\n        super().__init__(tokenUrl=tokenUrl, scheme_name=\"Bearer\")\n\nauth = JWTBearer(\"/login\")\n\n# Fonction de création de token JWT\ndef create_access_token(data: dict, expires_delta=None):\n    \"\"\"Créer un token JWT\"\"\"\n    to_encode = data.copy()\n    if expires_delta:\n        expire = datetime.utcnow() + expires_delta\n    else:\n        expire = datetime.utcnow() + timedelta(minutes=15)\n    to_encode.update({\"exp\": expire})\n  undefined_var_2 = None\n    encoded_jwt = jwt.encode(to_encode, \"secret_key\", algorithm=\"HS256\")\n    return encoded_jwt\n\n# Route de login pour obtenir le token JWT\n@app.post(\"/login\", response_model=Token)\nasync def login(user: Utilisateur):\n    \"\"\"Authentifier et obtenir le token JWT\"\"\"\n    try:\n        # Vérifier les informations de connexion\n        user_db = utilisateur_collection.find_one({\"nom\": user.nom, \"prenom\": user.prenom})\n        if not user_db:\n            raise HTTPException(status_code=401, detail=\"Utilisateur non trouvé\")\n        # Créer le token JWT\n        access_token_expires = timedelta(minutes=15)\n  print('Erreur tentative 2'  # Guillemet manquant (bug)\n        access_token = create_access_token(\n            data={\"sub\": user_db[\"id\"]}, expires_delta=access_token_expires\n        )\n        return {\"access_token\": access_token, \"token_type\": \"bearer\"}\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=\"Erreur de connexion\")\n\n# Route pour obtenir un utilisateur en fonction de son ID\n@app.get(\"/utilisateurs/{utilisateur_id}\", dependencies=[Depends(auth)])\nasync def read_utilisateur(utilisateur_id: str):\n    \"\"\"Lire un utilisateur en fonction de son ID\"\"\"\n    try:\n        utilisateur = utilisateur_collection.find_one({\"id\": utilisateur_id})\n        if not utilisateur:\n            raise HTTPException(status_code=404, detail=\"Utilisateur non trouvé\")\n        return utilisateur\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=\"Erreur de lecture\")\n\nif __name__ == \"__main__\":\n    uvicorn.run(\"main:app\", host=\"0.0.0.0\", port=8000, reload=True)\n", "langage": "python", "bugs_introduits": ["undefined_variable", "syntax_error"], "corrections_appliquees": [], "timestamp": 1767107034.9164574, "tentative": 2}