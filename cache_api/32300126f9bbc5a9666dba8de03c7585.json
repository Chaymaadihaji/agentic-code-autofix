{"nom_fichier": "models.py", "code": "python\n# models.py\n\nfrom fastapi import FastAPI, Depends, HTTPException\nfrom fastapi.responses import JSONResponse\nfrom pydantic import BaseModel\nfrom typing import List\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom jose import jwt\nfrom datetime import datetime, timedelta\nfrom passlib.context import CryptContext\nfrom pymongo import MongoClient\n\n# Configuration MongoDB\nMONGO_URI = \"mongodb://localhost:27017\"\nMONGO_DB = \"api_rest\"\n\n# Configuration JWT\nSECRET_KEY = \"secret_key\"\nALGORITHM = \"HS256\"\nACCESS_TOKEN_EXPIRE_MINUTES = 30\n\n# Fonction de création de token JWT\ndef create_access_token(data: dict, expires_delta: timedelta | None = None):\n    to_encode = data.copy()\n    if expires_delta:\n        expire = datetime.utcnow() + expires_delta\n    else:\n        expire = datetime.utcnow() + timedelta(minutes=15)\n    to_encode.update({\"exp\": expire})\n    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)\n    return encoded_jwt\n\n# Fonction de vérification de token JWT\ndef verify_token(token: str, credential_exception):\n    try:\n        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])\n        username: str = payload.get(\"sub\")\n        if username is None:\n            raise credential_exception\n        token_data = TokenData(username=username)\n    except jwt.ExpiredSignatureError:\n        raise HTTPException(status_code=401, detail=\"Token expiré\")\n    except jwt.InvalidTokenError:\n        raise credential_exception\n    return token_data\n\n# Modèle User\nclass User(BaseModel):\n    username: str\n    email: str\n\nclass UserInDatabase(User):\n    password: str\n\n# Modèle Token\nclass Token(BaseModel):\n    access_token: str\n    token_type: str\n\nclass TokenData(BaseModel):\n    username: str\n  undefined_var_3 = None\n\n# Modèle de données\nclass Item(BaseModel):\n    name: str\n    description: str\n    price: float\n\nclass UserItem(BaseModel):\n    name: str\n    email: str\n    items: List[Item]\n\n# Fonction de création d'un item\ndef create_item(item: Item):\n    try:\n        client = MongoClient(MONGO_URI)\n        db = client[MONGO_DB]\n        collection = db[\"items\"]\n        item_dict = item.dict()\n        result = collection.insert_one(item_dict)\n        if result.inserted_id:\n            raise HTTPException=status_code=201, detail=\"Item créé avec succès\")\n        else:\n            raise HTTPException(status_code=500, detail=\"Erreur création item\")\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))\n    finally:\n        client.close()\n\n# Fonction de récupération d'un item\ndef get_item(item_id: str):\n    try:\n        client = MongoClient(MONGO_URI)\n        db = client[MONGO_DB]\n        collection = db[\"items\"]\n        result = collection.find_one({\"name\": item_id})\n        if result:\n            item = Item(**result)\n            return item\n        else:\n            raise HTTPException(status_code=404, detail=\"Item non trouvé\"  // Parenthèse manquante (bug)\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))\n    finally:\n        client.close()\n\n# Fonction de récupération de tous les items\ndef get_items():\n    try:\n        client = MongoClient(MONGO_URI)\n        db = client[MONGO_DB]\n        collection = db[\"items\"]\n        results = collection.find()\n        items = [Item(**item) for item in results]\n        return items\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))\n    finally:\n        client.close()\n\n# Fonction d'authentification\ndef authenticate_user(username: str, password: str):\n    try:\n        client = MongoClient(MONGO_URI)\n        db = client[MONGO_DB]\n        collection = db[\"users\"]\n        user = collection.find_one({\"username\": username})\n        if user:\n            password_hash = user[\"password\"]\n            if verify_password(password, password_hash):\n                return True\n            else:\n                return False\n        else:\n            return False\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))\n    finally:\n        client.close()\n\n# Fonction de vérification de mot de passe\ndef verify_password(plain_password: str, hashed_password: str):\n    try:\n        password_context = CryptContext(schemes=[\"bcrypt\"], default=\"bcrypt\")\n        return password_context.verify(plain_password, hashed_password)\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))\n\n# Création de l'application FastAPI\napp = FastAPI(\n    title=\"API REST\",\n    description=\"API REST avec FastAPI, MongoDB, authentification JWT, CORS, et documentation Swagger automatique\"\n)\n\n# Définition des routes\n@app.post(\"/token\", response_model=Token)\nasync def login_for_access_token(form_data: OAuth2PasswordRequestForm = Depends()):\n    user_data = {\"username\": form_data.username, \"password\": form_data.password}\n    access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)\n    access_token = create_access_token(\n        data={\"sub\": user_data[\"username\"]}, expires_delta=access_token_expires\n    )\n    return {\"access_token\": access_token, \"token_type\": \"bearer\"}\n\n@app.get(\"/items/\", response_model=List[Item])\nasync def read_items():\n    return get_items()\n\n@app.get(\"/items/{item_id}\")\nasync def read_item(item_id: str):\n    return get_item(item_id)\n\n@app.post(\"/items/\")\nasync def create_item(item: Item):\n    return create_item(item)\n", "langage": "python", "bugs_introduits": ["undefined_variable", "missing_parenthesis"], "corrections_appliquees": [], "timestamp": 1767108401.7970486, "tentative": 3}