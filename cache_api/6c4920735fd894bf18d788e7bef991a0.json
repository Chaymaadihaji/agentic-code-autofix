{"nom_fichier": "main.py", "code": "python\n# Importations\nfrom flask import Flask, request, jsonify\nfrom flask_sqlalchemy import SQLAlchemy\nfrom flask_marshmallow import Marshmallow\nfrom flask_mail import Mail, Message\nfrom flask_jwt_extended import JWTManager, jwt_required, create_access_token\nfrom sqlalchemy import func\nfrom datetime import datetime, timedelta\nimport os\nimport csv\nfrom fpdf import FPDF\nimport sqlite3\nfrom config import Config\nfrom models import db, ma, User, Book, Loan, Stat\nfrom api import api\nfrom dashboard import dashboard\nfrom utils import send_email, get_stats\n\n# Application\napp = Flask(__name__)\napp.config.from_object(Config)\n\n# Gestion de la base de données\ndb.init_app(app)\n\n# Authentification\nma.init_app(app)\nmail = Mail(app)\njwt = JWTManager(app)\n\n# API\napi.init_app(app)\n\n# Dashboard\ndashboard.init_app(app)\n\n# Routes\n@app.route('/')\ndef index():\n    return 'Bienvenue dans la bibliothèque en ligne !'\n\n@app.route('/inscription', methods=['POST'])\ndef inscription():\n    try:\n        user = User(\n            username=request.json['username'],\n            email=request.json['email'],\n            password=request.json['password']\n        )\n        db.session.add(user)\n        db.session.commit()\n        return jsonify({'message': 'Inscription réussie !'}), 201\n    except Exception as e:\n        return jsonify({'message': 'Erreur d\\'inscription : ' + str(e)}), 400\n\n@app.route('/connexion', methods=['POST'])\ndef connexion():\n    try:\n        user = User.query.filter_by(username=request.json['username']).first()\n        if user and user.password == request.json['password']:\n            access_token = create_access_token(identity=user.id)\n            return jsonify({'token': access_token}), 200\n        else:\n            return jsonify({'message': 'Identifiants incorrects'}), 401\n    except Exception as e:\n        return jsonify({'message': 'Erreur de connexion : ' + str(e)}), 400\n\n@app.route('/deconnexion')\n@jwt_required\ndef deconnexion():\n    return jsonify({'message': 'Déconnexion réussie !'}), 200\n\n@app.route('/livres', methods=['GET', 'POST', 'PUT', 'DELETE'])\n@jwt_required\ndef livres():\n    if request.method == 'GET':\n        livres = Book.query.all()\n        return jsonify([book.to_dict() for book in livres]), 200\n    elif request.method == 'POST':\n        try:\n            book = Book(\n                title=request.json['title'],\n                author=request.json['author'],\n                publication_date=request.json['publication_date']\n            )\n            db.session.add(book)\n            db.session.commit()\n            return jsonify({'message': 'Livre ajouté avec succès !'}), 201\n        except Exception as e:\n            return jsonify({'message': 'Erreur d\\'ajout : ' + str(e)}), 400\n    elif request.method == 'PUT':\n        try:\n            book = Book.query.get(request.json['id'])\n            if book:\n                book.title = request.json['title']\n                book.author = request.json['author']\n                book.publication_date = request.json['publication_date']\n                db.session.commit()\n                return jsonify({'message': 'Livre modifié avec succès !'}), 200\n            else:\n                return jsonify({'message': 'Livre non trouvé'}), 404\n        except Exception as e:\n            return jsonify({'message': 'Erreur de modification : ' + str(e)}), 400\n    elif request.method == 'DELETE':\n        try:\n            book = Book.query.get(request.json['id'])\n            if book:\n                db.session.delete(book)\n                db.session.commit()\n                return jsonify({'message': 'Livre supprimé avec succès !'}), 200\n            else:\n                return jsonify({'message': 'Livre non trouvé'}), 404\n        except Exception as e:\n            return jsonify({'message': 'Erreur de suppression : ' + str(e)}), 400\n\n@app.route('/emprunts', methods=['GET', 'POST', 'PUT', 'DELETE'])\n@jwt_required\ndef emprunts():\n    if request.method == 'GET':\n        emprunts = Loan.query.all()\n        return jsonify([emprunt.to_dict() for emprunt in emprunts]), 200\n    elif request.method == 'POST':\n        try:\n            emprunt = Loan(\n                user_id=request.json['user_id'],\n                book_id=request.json['book_id'],\n                start_date=request.json['start_date'],\n                end_date=request.json['end_date']\n            )\n            db.session.add(emprunt)\n            db.session.commit()\n            return jsonify({'message': 'Emprunt ajouté avec succès !'}), 201\n        except Exception as e:\n            return jsonify({'message': 'Erreur d\\'ajout : ' + str(e)}), 400\n    elif request.method == 'PUT':\n        try:\n            emprunt = Loan.query.get(request.json['id'])\n            if emprunt:\n                emprunt.start_date = request.json['start_date']\n                emprunt.end_date = request.json['end_date']\n                db.session.commit()\n                return jsonify({'message': 'Emprunt modifié avec succès !'}), 200\n            else:\n                return jsonify({'message': 'Emprunt non trouvé'}), 404\n        except Exception as e:\n            return jsonify({'message': 'Erreur de modification : ' + str(e)}), 400\n    elif request.method == 'DELETE':\n        try:\n            emprunt = Loan.query.get(request.json['id'])\n            if emprunt:\n                db.session.delete(emprunt)\n                db.session.commit()\n                return jsonify({'message': 'Emprunt supprimé avec succès !'}), 200\n            else:\n                return jsonify({'message': 'Emprunt non trouvé'}), 404\n        except Exception as e:\n            return jsonify({'message': 'Erreur de suppression : ' + str(e)}), 400\n\n@app.route('/recherche', methods=['GET'])\ndef recherche():\n    try:\n        q = request.args.get('q')\n        livres = Book.query.filter(Book.title.like('%' + q + '%')).all()\n        return jsonify([book.to_dict() for book in livres]), 200\n    except Exception as e:\n        return jsonify({'message': 'Erreur de recherche : ' + str(e)}), 400\n\n@app.route('/recommandations')\n@jwt_required\ndef recommandations():\n    try:\n        historique = Loan.query.filter(Loan.user_id == request.json['user_id']).all()\n        recommandations = []\n        for emprunt in historique:\n            book = Book.query.get(emprunt.book_id)\n            recommandations.append(book.title)\n        return jsonify({'recommandations': recommandations}), 200\n    except Exception as e:\n        return jsonify({'message': 'Erreur de recommandations : ' + str(e)}), 400\n\n@app.route('/export/csv')\ndef export_csv():\n    try:\n        livres = Book.query.all()\n        with open('livres.csv', 'w', newline='') as csvfile:\n            writer = csv.writer(csvfile)\n            writer.writerow(['Titre', 'Auteur', 'Date de publication'])\n            for livre in livres:\n                writer.writerow([livre.title, livre.author, livre.publication_date])\n        return jsonify({'message': 'Export CSV réussi !'}), 200\n    except Exception as e:\n        return jsonify({'message': 'Erreur d\\'export CSV : ' + str(e)}), 400\n\n@app.route('/export/pdf')\ndef export_pdf():\n    try:\n        pdf = FPDF()\n        pdf.add_page()\n        pdf.set_font('Arial', 'B', 16)\n        pdf.cell(0, 10, 'Livres', 0, 1, 'C')\n        pdf.ln(10)\n        livres = Book.query.all()\n        for livre in livres:\n            pdf.cell(0, 10, str(livre.title), 0, 1, 'L')\n            pdf.cell(0, 10, str(livre.author), 0, 1, 'L')\n            pdf.cell(0, 10, str(livre.publication_date), 0, 1, 'L')\n            pdf.ln(10)\n        pdf.output('livres.pdf')\n        return jsonify({'message': 'Export PDF réussi !'}), 200\n    except Exception as e:\n        return jsonify({'message': 'Erreur d\\'export PDF : ' + str(e)}), 400\n\n# Gestion des erreurs\n@app.errorhandler(404)\ndef not_found(error):\n    return jsonify({'message': 'Ressource non trouvée'}), 404\n\n@app.errorhandler(500)\ndef internal_server_error(error):\n    return jsonify({'message': 'Erreur interne du serveur'}), 500\n\n# Début de l'application\nif __name__ == '__main__':\n    app.run(debug=True)\n", "timestamp": 1766873016.2701545}