{"nom_fichier": "internal/models/models.go", "code": "go\n// Package models contient les définitions des modèles de données de l'application.\npackage models\n\nimport (\n\t\"context\"\n\t\"database/sql\"\n\t\"time\"\n\n\t\"github.com/go-redis/redis/v9\"\n\t\"github.com/lib/pq\"\n)\n\n// User représente un utilisateur de l'application.\ntype User struct {\n\tID       int       `json:\"id\"`\n\tUsername string    `json:\"username\"`\n\tEmail    string    `json:\"email\"`\n\tPassword string    `json:\"-\"`\n\tCreated  time.Time `json:\"created\"`\n\tUpdated  time.Time `json:\"updated\"`\n}\n\n// UserCache est un modèle pour stocker les données d'un utilisateur dans Redis.\ntype UserCache struct {\n\tID       string `json:\"id\"`\n\tUsername string `json:\"username\"`\n\tEmail    string `json:\"email\"`\n\tExpires  time.Time\n}\n\n// Database est une interface pour interagir avec la base de données PostgreSQL.\ntype Database interface {\n\tConn() (*sql.DB, error)\n}\n\n// RedisClient est une interface pour interagir avec le client Redis.\ntype RedisClient interface {\n\tGet(ctx context.Context, key string) (*redis.StringCmd, error)\n\tSet(ctx context.Context, key string, value string, expiration time.Duration) (*redis.StatusCmd, error)\n}\n\n// UserRepository est une interface pour gérer les opérations sur les utilisateurs.\ntype UserRepository interface {\n\tGetUser(ctx context.Context, id int) (*User, error)\n\tGetUserByUsername(ctx context.Context, username string) (*User, error)\n\tCreateUser(ctx context.Context, user *User) error\n}\n\n// CacheRepository est une interface pour gérer les opérations sur le cache.\ntype CacheRepository interface {\n\tGetUserCache(ctx context.Context, id int) (*UserCache, error)\n\tSetUserCache(ctx context.Context, id int, cache *UserCache) error\n}\n\n// userRepositoryImpl est une implémentation de UserRepository.\ntype userRepositoryImpl struct {\n\tdb Database\n}\n\n// NewUserRepository retourne une nouvelle instance de UserRepository.\nfunc NewUserRepository(db Database) UserRepository {\n\treturn &userRepositoryImpl{db: db}\n}\n\n// GetUser retourne l'utilisateur correspondant à l'ID donné.\nfunc (r *userRepositoryImpl) GetUser(ctx context.Context, id int) (*User, error) {\n\tuser := &User{}\n\terr := r.db.Conn().QueryRowContext(ctx, \"SELECT * FROM users WHERE id = $1\", id).Scan(user)\n\tif err != nil {\n\t\tif err == sql.ErrNoRows {\n\t\t\treturn nil, sql.ErrNoRows\n\t\t}\n\t\treturn nil, err\n\t}\n\treturn user, nil\n}\n\n// GetUserByUsername retourne l'utilisateur correspondant au nom d'utilisateur donné.\nfunc (r *userRepositoryImpl) GetUserByUsername(ctx context.Context, username string) (*User, error) {\n\tuser := &User{}\n\terr := r.db.Conn().QueryRowContext(ctx, \"SELECT * FROM users WHERE username = $1\", username).Scan(user)\n\tif err != nil {\n\t\tif err == sql.ErrNoRows {\n\t\t\treturn nil, sql.ErrNoRows\n\t\t}\n\t\treturn nil, err\n\t}\n\treturn user, nil\n}\n\n// CreateUser crée un nouvel utilisateur.\nfunc (r *userRepositoryImpl) CreateUser(ctx context.Context, user *User) error {\n\t_, err := r.db.Conn().ExecContext(ctx, \"INSERT INTO users (username, email, password) VALUES ($1, $2, $3)\", user.Username, user.Email, user.Password)\n\treturn err\n}\n\n// cacheRepositoryImpl est une implémentation de CacheRepository.\ntype cacheRepositoryImpl struct {\n\tr RedisClient\n}\n\n// NewCacheRepository retourne une nouvelle instance de CacheRepository.\nfunc NewCacheRepository(r RedisClient) CacheRepository {\n\treturn &cacheRepositoryImpl{r: r}\n}\n\n// GetUserCache retourne le cache utilisateur correspondant à l'ID donné.\nfunc (r *cacheRepositoryImpl) GetUserCache(ctx context.Context, id int) (*UserCache, error) {\n\tcache := &UserCache{}\n\tkey := fmt.Sprintf(\"user:%d\", id)\n\tcmd := r.r.Get(ctx, key)\n\terr := cmd.Err()\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\terr = cmd.Scan(cache)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\treturn cache, nil\n}\n\n// SetUserCache stocke le cache utilisateur pour l'ID donné.\nfunc (r *cacheRepositoryImpl) SetUserCache(ctx context.Context, id int, cache *UserCache) error {\n\tkey := fmt.Sprintf(\"user:%d\", id)\n\treturn r.r.Set(ctx, key, cache.Username, cache.Expires.Sub(time.Now())).Err()\n}\n", "timestamp": 1766868123.6864555}