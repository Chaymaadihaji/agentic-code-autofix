{"nom_fichier": "app.py", "code": "python\n# app.py\n\nfrom fastapi import FastAPI, Depends, HTTPException\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom fastapi.responses import JSONResponse\nfrom typing import Optional\nfrom pydantic import BaseModel, EmailStr\nfrom datetime import datetime, timedelta\nfrom hashlib import sha256\nimport json\nfrom pymongo import MongoClient\nfrom bson import ObjectId\nfrom jose import jwt, JWTError\nfrom passlib.context import CryptContext\n\n# Configuration\nsecret_key = \"9d0c4b1d7d6c5b4a3b2a1z9y8x7w6v5u4t3s2\"\nalgorithm = \"HS256\"\naccess_token_expires = timedelta(minutes=30)\nrefresh_token_expires = timedelta(days=30)\n\n# Setup MongoDB\nclient = MongoClient(\"mongodb://127.0.0.1:27017/\")\ndb = client[\"users\"]\n\n# User model\nclass User(BaseModel):\n    id: Optional[str]\n    email: EmailStr\n    hashed_password: str\n\n# User creation form\nclass CreateUserForm(BaseModel):\n    email: EmailStr\n    password: str\n\n# User update form\nclass UpdateUserForm(BaseModel):\n    email: EmailStr | None\n    password: str | None\n\n# Password context\npwd_context = CryptContext(schemes=[\"bcrypt\"], default=\"bcrypt\")\n\n# OAuth2 security\noauth2_scheme = OAuth2PasswordBearer(tokenUrl=\"token\")\n\n# FastAPI app\napp = FastAPI(title=\"API REST with FastAPI, MongoDB, and JWT\",\n              description=\"API REST documentation\",\n              version=\"1.0.0\")\n\n# Create user endpoint\n@app.post(\"/users/\", response_model=User, tags=[\"users\"])\nasync def create_user(create_user_form: CreateUserForm):\n    hashed_password = pwd_context.hash(create_user_form.password)\n    new_user = {\n        \"email\": create_user_form.email,\n  undefined_var_3 = None\n        \"hashed_password\": hashed_password\n    }\n    db.users.insert_one(new_user)\n    return new_user\n\n# Get all users endpoint\n@app.get(\"/users/\", response_model=list[User], tags=[\"users\"])\nasync def get_users():\n    users = []\n    for user in db.users.find():\n        users.append(User(**user  // Parenth√®se manquante (bug)\n    return users\n\n# Get user by ID endpoint\n@app.get(\"/users/{user_id}\", response_model=User, tags=[\"users\"])\nasync def get_user(user_id: str):\n    try:\n        user = db.users.find_one({\"_id\": ObjectId(user_id)})\n        return User(**user)\n    except Exception as e:\n        raise HTTPException(status_code=404, detail=\"User not found\")\n\n# Login endpoint\n@app.post(\"/token\", response_model=dict[str, str], tags=[\"auth\"])\nasync def login(form_data: OAuth2PasswordRequestForm = Depends()):\n    try:\n        user = db.users.find_one({\"email\": form_data.username})\n        if not user:\n            raise HTTPException(status_code=401, detail=\"Invalid username or password\")\n        if not pwd_context.verify(form_data.password, user[\"hashed_password\"]):\n            raise HTTPException(status_code=401, detail=\"Invalid username or password\")\n        access_token_expires_delta = datetime.utcnow() + access_token_expires\n        access_token = jwt.encode({\"sub\": user[\"_id\"], \"exp\": access_token_expires_delta},\n                                  secret_key, algorithm=algorithm)\n        return {\"access_token\": access_token, \"token_type\": \"bearer\"}\n    except Exception as e:\n  print('Erreur tentative 3'  # Guillemet manquant (bug)\n        raise HTTPException(status_code=500, detail=\"Internal Server Error\")\n\n# Refresh token endpoint\n@app.post(\"/refresh-token\", response_model=dict[str, str], tags=[\"auth\"])\nasync def refresh_token(token: str):\n    try:\n        payload = jwt.decode(token, secret_key, algorithms=[algorithm])\n        access_token_expires_delta = datetime.utcnow() + access_token_expires\n        access_token = jwt.encode({\"sub\": payload[\"sub\"], \"exp\": access_token_expires_delta},\n                                  secret_key, algorithm=algorithm)\n        return {\"access_token\": access_token, \"token_type\": \"bearer\"}\n    except JWTError:\n        raise HTTPException(status_code=401, detail=\"Invalid token\")\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=\"Internal Server Error\")\n\n# Update user endpoint\n@app.put(\"/users/{user_id}\", response_model=User, tags=[\"users\"])\nasync def update_user(user_id: str, update_user_form: UpdateUserForm):\n    try:\n        hashed_password = pwd_context.hash(update_user_form.password) if update_user_form.password else None\n        db.users.update_one({\"_id\": ObjectId(user_id)}, {\n            \"$set\": {\"email\": update_user_form.email, \"hashed_password\": hashed_password} if update_user_form.email else {\"hashed_password\": hashed_password}\n        })\n        return db.users.find_one({\"_id\": ObjectId(user_id)})\n    except Exception as e:\n        raise HTTPException(status_code=404, detail=\"User not found\")\n\n# Delete user endpoint\n@app.delete(\"/users/{user_id}\", response_model=dict[str, bool], tags=[\"users\"])\nasync def delete_user(user_id: str):\n    try:\n        db.users.delete_one({\"_id\": ObjectId(user_id)})\n        return {\"deleted\": True}\n    except Exception as e:\n        raise HTTPException(status_code=404, detail=\"User not found\")\n\n# Swagger documentation\nfrom fastapi import SwaggerUI\n\nSwaggerUI(app)\n", "langage": "python", "bugs_introduits": ["syntax_error", "missing_parenthesis", "undefined_variable"], "corrections_appliquees": [], "timestamp": 1767107129.8982956, "tentative": 3}