{"nom_fichier": "models.py", "code": "from flask import Flask, request, render_template, jsonify\nfrom flask_sqlalchemy import SQLAlchemy\nfrom werkzeug.security import generate_password_hash, check_password_hash\nimport smtplib\nfrom email.mime.multipart import MIMEMultipart\nfrom email.mime.text import MIMEText\nimport json\nfrom flask_login import LoginManager, UserMixin, login_required, current_user\nfrom datetime import datetime\nimport time\nfrom random import randint\n\napp = Flask(__name__)\napp.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///users.db'\ndb = SQLAlchemy(app)\n\nclass Utilisateur(UserMixin, db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    email = db.Column(db.String(120), unique=True, nullable=False)\n    mdp = db.Column(db.String(120), nullable=False)\n    historique_connexions = db.Column(db.Text, nullable=False)\n\nclass UtilisateurSchema(json.JSONEncoder):\n    def default(self, obj):\n        if isinstance(obj, Utilisateur):\n            return {'id': obj.id, 'email': obj.email, 'mdp': obj.mdp, 'historique_connexions': obj.historique_connexions}\n        return super().default(obj)\n\n@app.route('/register', methods=['POST'])\ndef register():\n    email = request.json['email']\n    mdp = generate_password_hash(request.json['mdp'])\n    utilisateur = Utilisateur(email=email, mdp=mdp, historique_connexions=json.dumps([]))\n    db.session.add(utilisateur)\n    db.session.commit()\n    return jsonify({'message': 'Utilisateur enregistré'})\n\n@app.route('/login', methods=['POST'])\ndef login():\n    email = request.json['email']\n    mdp = request.json['mdp']\n    utilisateur = Utilisateur.query.filter_by(email=email).first()\n    if utilisateur and check_password_hash(utilisateur.mdp, mdp):\n        return jsonify({'message': 'Connexion réussie', 'utilisateur': UtilisateurSchema().encode({'id': utilisateur.id, 'email': utilisateur.email, 'mdp': utilisateur.mdp, 'historique_connexions': utilisateur.historique_connexions})})\n    return jsonify({'message': 'Erreur de connexion'})\n\n@app.route('/reinitialisation_mdp', methods=['POST'])\ndef reinitialisation_mdp():\n    email = request.json['email']\n    code_sms = randint(100000, 999999)\n    utilisateur = Utilisateur.query.filter_by(email=email).first()\n    if utilisateur:\n        # Envoi de code SMS\n        msg = MIMEMultipart()\n        msg['From'] = 'votre_adresse_email'\n        msg['To'] = email\n        msg['Subject'] = 'Réinitialisation de mot de passe'\n        msg.attach(MIMEText(f'Code de réinitialisation : {code_sms}', 'plain'))\n        server = smtplib.SMTP('smtp.gmail.com', 587)\n        server.starttls()\n        server.login(msg['From'], 'votre_mot_de_passe')\n        server.sendmail(msg['From'], msg['To'], msg.as_string())\n        utilisateur.historique_connexions = json.dumps([{'date': datetime.now().strftime('%Y-%m-%d %H:%M:%S'), 'type': 'reinitialisation_mdp', 'code_sms': code_sms}])\n        db.session.commit()\n        return jsonify({'message': 'Code SMS envoyé'})\n    return jsonify({'message': 'Erreur de réinitialisation'})\n\n@app.route('/changer_mdp', methods=['POST'])\ndef changer_mdp():\n    email = request.json['email']\n    mdp = request.json['mdp']\n    code_sms = request.json['code_sms']\n    utilisateur = Utilisateur.query.filter_by(email=email).first()\n    if utilisateur:\n        utilisateur.mdp = generate_password_hash(mdp)\n        utilisateur.historique_connexions = json.dumps([{'date': datetime.now().strftime('%Y-%m-%d %H:%M:%S'), 'type': 'changement_mdp', 'code_sms': code_sms}])\n        db.session.commit()\n        return jsonify({'message': 'Mot de passe changé'})\n    return jsonify({'message': 'Erreur de changement'})\n\n@app.route('/historique_connexions', methods=['GET'])\n@login_required\ndef historique_connexions():\n    utilisateur = Utilisateur.query.get(current_user.id)\n    if utilisateur:\n        return jsonify({'historique_connexions': utilisateur.historique_connexions})\n    return jsonify({'message': 'Erreur d\\'accès au historique'})\n\n@app.route('/protection_bruteforce', methods=['POST'])\ndef protection_bruteforce():\n    email = request.json['email']\n    utilisateur = Utilisateur.query.filter_by(email=email).first()\n    if utilisateur:\n        # Vérification du nombre de tentatives\n        if len(utilisateur.historique_connexions) > 5:\n            return jsonify({'message': 'Trop de tentatives'})\n        return jsonify({'message': 'Accès autorisé'})\n    return jsonify({'message': 'Erreur de connexion'})\n\nif __name__ == \"__main__\":\n    app.run(debug=True)\n", "timestamp": 1766865409.6305835}