{"nom_fichier": "main.py", "code": "python\nfrom fastapi import FastAPI, Depends, HTTPException\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom pymongo import MongoClient\nfrom pydantic import BaseModel\nfrom typing import List\nimport jwt\n\napp = FastAPI()\n\nSECRET_KEY = \"secret_key_here\"\nALGORITHM = \"HS256\"\n\n# Connexion à MongoDB\nMONGODB_URL = \"mongodb://localhost:27017/\"\nclient = MongoClient(MONGODB_URL)\ndb = client[\"mon_app\"]\n\nclass Utilisateur(BaseModel):\n    id: str\n    username: str\n    passwordDigest: str\n\nclass UtilisateurReponse(BaseModel):\n    id: str\n    username: str\n\n# Fonction de vérification d'authentification\ndef authenticate_user(username: str, password: str):\n    try:\n        utilisateur = db[\"utilisateurs\"].find_one({\"username\": username})\n        if utilisateur and utilisateur[\"passwordDigest\"] == password:\n            return UtilisateurReponse(**utilisateur)\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))\n    return None\n\n# Création de l'API REST\n@app.post(\"/api/login\")\ndef login_for_access_token(form_data: OAuth2PasswordRequestForm = Depends()):\n    try:\n        username = form_data.username\n        password = form_data.password\n        utilisateur = authenticate_user(username, password)\n        if utilisateur:\n            access_token = jwt.encode({\"sub\": utilisateur.id}, SECRET_KEY, algorithm=ALGORITHM)\n            db[\"utilisateurs\"].update_one({\"_id\": utilisateur.id}, {\"$set\": {\"last_login_at\": datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")}})\n            return {\"access_token\": access_token, \"token_type\": \"bearer\"}\n    except Exception as e:\n        raise HTTPException(status_code=401, detail=\"Invalid username or password\")\n\n@app.get(\"/api/utilisateurs/\")\ndef read_utilisateurs():\n    try:\n        utilisateurs = list(db[\"utilisateurs\"].find())\n        return {\"utilisateurs\": utilisateurs}\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))\n", "langage": "python", "bugs_introduits": [], "corrections_appliquees": [], "timestamp": 1767107167.641049, "tentative": 4}